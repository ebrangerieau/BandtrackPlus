(()=>{var Ae=Object.create;var fe=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames;var Me=Object.getPrototypeOf,je=Object.prototype.hasOwnProperty;var ee=(e,t)=>()=>(e&&(t=e(e=0)),t);var ye=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Ue=(e,t,l,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of $e(t))!je.call(e,o)&&o!==l&&fe(e,o,{get:()=>t[o],enumerable:!(a=Ie(t,o))||a.enumerable});return e};var Re=(e,t,l)=>(l=e!=null?Ae(Me(e)):{},Ue(t||!e||!e.__esModule?fe(l,"default",{value:e,enumerable:!0}):l,e));function re(){I.rehearsalsCache=[],I.suggestionsCache=[]}var I,X=ee(()=>{I={currentUser:null,currentPage:"home",rehearsalsCache:[],groupsCache:[],activeGroupId:null,agendaDate:new Date,suggestionsCache:[]}});async function x(e,t="GET",l,a={}){let{silent401:o=!1}=a,n={method:t,credentials:"include"};l!==void 0&&(n.headers={"Content-Type":"application/json"},n.body=JSON.stringify(l));let c=await fetch("/api"+e,n),d;try{d=await c.json()}catch{d=null}if(c.status===401){if(I.currentUser=null,o)return console.debug(`API ${t} ${e} returned 401`),null;throw new Error(d?.error||"Non authentifi\xE9")}if(c.status===403&&d&&d.error==="No membership")throw I.currentUser&&(I.currentUser.needsGroup=!0),new Error("No membership");if(c.status===404&&e==="/context"&&t==="GET")return null;if(!c.ok)throw new Error(d&&d.error||"Erreur API");return d}function Ve(e){return x(`/rehearsals/${e}/partitions`)}async function Ee(e,t,l){let a=new FormData;a.append("file",t),l&&a.append("displayName",l);let o=await fetch(`/api/rehearsals/${e}/partitions`,{method:"POST",body:a,credentials:"include"}),n;try{n=await o.json()}catch{n=null}if(o.status===401)throw I.currentUser=null,new Error(n?.error||"Non authentifi\xE9");if(!o.ok)throw new Error(n&&n.error||"Erreur API");return n}function ge(e,t){return x(`/rehearsals/${e}/partitions/${t}`,"DELETE")}async function O(){let e=await x("/rehearsals"),t=await Promise.allSettled(e.map(a=>Ve(a.id))),l=[];t.forEach((a,o)=>{let n=e[o];a.status==="fulfilled"?l.push({...n,partitions:a.value}):console.error(`Erreur lors de la r\xE9cup\xE9ration des partitions pour le morceau ${n.id}`,a.reason)}),I.rehearsalsCache=l}var de=ee(()=>{X();setInterval(()=>{I.currentUser&&O().catch(()=>{})},5*60*1e3)});async function J(){try{let e=await x("/me","GET",void 0,{silent401:!0});if(!e){I.currentUser=null;return}if(I.currentUser=e,!e.needsGroup){let t=await x("/settings");te(t.darkMode),se(t.template||"classic"),document.title=`${t.groupName} \u2013 BandTrack`;let l=document.getElementById("group-name");l&&(l.textContent=t.groupName)}}catch(e){console.debug("checkSession failed",e),I.currentUser=null}}function te(e){let t=document.body;e?t.classList.add("dark"):t.classList.remove("dark")}function se(e){let t=document.body;t.classList.forEach(l=>{l.startsWith("template-")&&t.classList.remove(l)}),t.classList.add("template-"+e)}async function ie(){try{await x("/logout","POST"),I.currentUser=null}catch(e){alert(e.message)}}var ve=ee(()=>{X();de()});var pe,me,be=ee(()=>{pe=class{constructor(){this.audio=new Audio,this.playlist=[],this.currentIndex=-1,this._createUI()}_createUI(){this.container=document.createElement("div"),this.container.id="audio-player-controls",this.container.className="fixed bottom-0 left-0 right-0 bg-gray-100 flex items-center gap-2 p-2 shadow",this.playBtn=document.createElement("button"),this.playBtn.className="btn-primary",this.playBtn.textContent="Play",this.playBtn.onclick=()=>this.toggle(),this.container.appendChild(this.playBtn),this.progress=document.createElement("input"),this.progress.type="range",this.progress.min=0,this.progress.max=100,this.progress.value=0,this.progress.className="flex-grow",this.progress.oninput=()=>{let t=this.progress.value/100;this.audio.currentTime=t*(this.audio.duration||0)},this.container.appendChild(this.progress),this.volume=document.createElement("input"),this.volume.type="range",this.volume.min=0,this.volume.max=1,this.volume.step=.01,this.volume.value=this.audio.volume,this.volume.oninput=()=>{this.audio.volume=this.volume.value},this.container.appendChild(this.volume),document.body.appendChild(this.container),this.audio.addEventListener("timeupdate",()=>{this.audio.duration&&(this.progress.value=this.audio.currentTime/this.audio.duration*100)}),this.audio.addEventListener("ended",()=>this.next()),this.audio.addEventListener("play",()=>{this.playBtn.textContent="Pause"}),this.audio.addEventListener("pause",()=>{this.playBtn.textContent="Play"})}play(t){let l=this.playlist.indexOf(t);return l===-1?(this.playlist.push(t),this.currentIndex=this.playlist.length-1):this.currentIndex=l,this.audio.src=t,this.audio.play()}queue(t){this.playlist.push(t)}next(){if(!this.playlist.length)return;this.currentIndex=(this.currentIndex+1)%this.playlist.length;let t=this.playlist[this.currentIndex];this.audio.src=t,this.audio.play()}toggle(){this.audio.paused?this.audio.play():this.audio.pause()}},me=new pe});var ke=ye(()=>{X();var xe=location.protocol==="https:"?"wss":"ws",we=typeof process<"u"?process.env||{}:{},ue=window.WS_URL||we.WS_URL;if(!ue){let e=location.port?parseInt(location.port,10):xe==="wss"?443:80,t=window.WS_PORT||we.WS_PORT,l=t?parseInt(t,10):e+1;ue=`${xe}://${location.hostname}:${l}`}var ne;function Ne(){ne=new WebSocket(ue),ne.onmessage=e=>{try{let t=JSON.parse(e.data);if(t.groupId&&I.activeGroupId&&t.groupId!==I.activeGroupId)return;switch(t.type){case"suggestion:new":I.suggestionsCache=I.suggestionsCache||[],I.suggestionsCache.push(t.suggestion);break;case"suggestion:vote":let l=I.suggestionsCache?.findIndex(o=>o.id===t.suggestion.id);l>=0&&(I.suggestionsCache[l]=t.suggestion);break;case"rehearsal:new":I.rehearsalsCache.push(t.rehearsal);break;case"rehearsal:update":let a=I.rehearsalsCache.findIndex(o=>o.id===t.rehearsal.id);a>=0&&(I.rehearsalsCache[a]=t.rehearsal);break;default:break}}catch(t){console.error("WS message error",t)}},ne.onerror=e=>{console.error("WS connection error",e)},ne.onclose=e=>{console.warn("WS connection closed, retrying in 5s",e),setTimeout(Ne,5e3)}}Ne()});var et=ye(()=>{X();de();ve();be();var ft=Re(ke()),D=null,M="home",j=[],Z=[],q=null,H=new Date;Object.defineProperties(I,{currentUser:{get:()=>D,set:e=>D=e},currentPage:{get:()=>M,set:e=>M=e},rehearsalsCache:{get:()=>j,set:e=>j=e},groupsCache:{get:()=>Z,set:e=>Z=e},activeGroupId:{get:()=>q,set:e=>q=e},agendaDate:{get:()=>H,set:e=>H=e}});document.addEventListener("click",e=>{let t=document.getElementById("profile-menu"),l=document.getElementById("profile-btn");t&&!t.classList.contains("hidden")&&!t.contains(e.target)&&e.target!==l&&!l?.contains(e.target)&&(t.classList.add("hidden"),t.classList.remove("block","open"),l?.classList.remove("open"))});function ae(){let e=document.getElementById("profile-menu"),t=document.getElementById("profile-btn");!e||!t||(e.classList.toggle("hidden"),e.classList.toggle("block"),e.classList.toggle("open"),t.classList.toggle("open"))}function ce(){return D&&(D.membershipRole==="admin"||D.membershipRole==="moderator")}function Ce(){return D&&D.membershipRole==="admin"}function oe(e){if(!e)return"";let t=new Date(e);return isNaN(t)?e:t.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short",hour12:!1})}async function Se(){if(confirm("\xCAtes-vous s\xFBr de vouloir supprimer votre compte ?"))try{await x("/me","DELETE"),D=null,K()}catch(t){alert(t.message)}}async function Te(e){await x("/context","PUT",{groupId:Number(e)}),localStorage.setItem("activeGroupId",String(e)),q=Number(e),re(),await J()}async function _(e){if(!D)return;let t=document.getElementById("group-select"),l=document.getElementById("create-group-btn"),a=document.getElementById("join-group-btn");l&&(l.onclick=()=>Be()),a&&(a.onclick=()=>Pe());try{Z=await x("/groups");let o=e||localStorage.getItem("activeGroupId");Z.some(n=>String(n.id)===String(o))||(o=Z[0]?Z[0].id:null),t&&(t.innerHTML="",Z.forEach(n=>{let c=document.createElement("option");c.value=n.id,c.textContent=n.name,t.appendChild(c)}),o&&(t.value=o),t.onchange=async()=>{await Te(t.value),Y(document.getElementById("app"))}),o&&await Te(o)}catch(o){console.error(o)}}function Be(){let e=document.createElement("div");e.className="modal";let t=document.createElement("div");t.className="modal-content";let l=document.createElement("h3");l.textContent="Cr\xE9er un groupe",t.appendChild(l);let a=document.createElement("form");a.onsubmit=u=>u.preventDefault();let o=document.createElement("label");o.textContent="Nom du groupe";let n=document.createElement("input");n.type="text",n.required=!0,n.style.width="100%",a.appendChild(o),a.appendChild(n),t.appendChild(a);let c=document.createElement("div");c.className="modal-actions";let d=document.createElement("button");d.className="btn-secondary",d.textContent="Annuler",d.onclick=()=>e.remove();let r=document.createElement("button");r.className="btn-primary",r.textContent="Cr\xE9er",r.onclick=async()=>{let u=n.value.trim();if(u)try{let s=await x("/groups","POST",{name:u});alert("Code d'invitation : "+s.invitationCode),e.remove(),await _(s.id),Y(document.getElementById("app"))}catch(s){alert(s.message)}},c.appendChild(d),c.appendChild(r),t.appendChild(c),e.appendChild(t),document.body.appendChild(e),setTimeout(()=>n.focus(),50)}function Pe(){let e=document.createElement("div");e.className="modal";let t=document.createElement("div");t.className="modal-content";let l=document.createElement("h3");l.textContent="Rejoindre un groupe",t.appendChild(l);let a=document.createElement("form");a.onsubmit=i=>i.preventDefault();let o=document.createElement("label");o.textContent="Code d'invitation";let n=document.createElement("input");n.type="text",n.required=!0,n.style.width="100%";let c=document.createElement("label");c.textContent="Surnom";let d=document.createElement("input");d.type="text",d.style.width="100%",a.appendChild(o),a.appendChild(n),a.appendChild(c),a.appendChild(d),t.appendChild(a);let r=document.createElement("div");r.className="modal-actions";let u=document.createElement("button");u.className="btn-secondary",u.textContent="Annuler",u.onclick=()=>e.remove();let s=document.createElement("button");s.className="btn-primary",s.textContent="Rejoindre",s.onclick=async()=>{let i=n.value.trim(),y=d.value.trim();if(i)try{let v=await x("/groups/join","POST",{code:i,nickname:y});e.remove(),await _(v.groupId),Y(document.getElementById("app"))}catch(v){alert(v.message)}},r.appendChild(u),r.appendChild(s),t.appendChild(r),e.appendChild(t),document.body.appendChild(e),setTimeout(()=>n.focus(),50)}async function Oe(){await J(),D&&await _(),K()}function K(){let e=document.getElementById("app");if(D)D.needsGroup?He(e):Y(e);else{let t=document.getElementById("group-name");t&&(t.textContent=""),re(),qe(e)}}function He(e){e.innerHTML="";let t=document.createElement("div");t.className="auth-container";let l=document.createElement("h2");l.textContent="Rejoindre ou cr\xE9er un groupe",t.appendChild(l);let a=document.createElement("p");a.textContent="Vous devez s\xE9lectionner ou cr\xE9er un groupe pour continuer.",t.appendChild(a);let o=document.createElement("p");o.textContent="Pour rejoindre un groupe existant, munissez-vous de son code d'invitation ou demandez \xE0 un administrateur de vous ajouter directement.",t.appendChild(o);let n=document.createElement("div"),c=document.createElement("button");c.className="btn-primary",c.textContent="Cr\xE9er un groupe",c.onclick=()=>Be(),n.appendChild(c);let d=document.createElement("button");d.className="btn-secondary",d.style.marginLeft="10px",d.textContent="Rejoindre un groupe",d.onclick=()=>Pe(),n.appendChild(d),t.appendChild(n);let r=document.createElement("button");r.id="delete-account-btn-group-setup",r.className="delete-account-btn",r.textContent="Supprimer mon compte",r.onclick=Se,t.appendChild(r),e.appendChild(t)}function qe(e){e.innerHTML="";let t=document.createElement("div");t.className="auth-container";let l=!1;function a(){t.innerHTML="";let o=document.createElement("h2");o.textContent=l?"Inscription":"Connexion",t.appendChild(o);let n=document.createElement("form");n.onsubmit=async p=>{p.preventDefault(),l?await g():await m()};let c=document.createElement("label");c.textContent="Nom d\u2019utilisateur";let d=document.createElement("input");d.type="text",d.required=!0,d.autocomplete="username";let r=document.createElement("label");r.textContent="Mot de passe";let u=document.createElement("input");u.type="password",u.required=!0,u.autocomplete=l?"new-password":"current-password",n.appendChild(c),n.appendChild(d),n.appendChild(r),n.appendChild(u);let s;if(l){let p=document.createElement("label");p.textContent="Confirmer le mot de passe",s=document.createElement("input"),s.type="password",s.required=!0,s.autocomplete="new-password",n.appendChild(p),n.appendChild(s)}let i=document.createElement("div");i.style.color="var(--danger-color)",i.style.marginTop="12px",n.appendChild(i);let y=document.createElement("button");y.className="btn-primary",y.style.marginTop="20px",y.textContent=l?"S\u2019inscrire":"Se connecter",n.appendChild(y);let v=document.createElement("a");v.className="link",v.textContent=l?"D\xE9j\xE0 un compte ? Se connecter":"Cr\xE9er un compte",v.onclick=p=>{p.preventDefault(),l=!l,a()},t.appendChild(n),t.appendChild(v),e.appendChild(t);async function g(){let p=d.value.trim(),C=u.value,h=s?s.value:"";if(!p||!C){i.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}if(C!==h){i.textContent="Les mots de passe ne correspondent pas";return}try{await x("/register","POST",{username:p,password:C}),await J(),M="home",await _(),K()}catch(w){i.textContent=w.message}}async function m(){let p=d.value.trim(),C=u.value;if(!p||!C){i.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}try{await x("/login","POST",{username:p,password:C}),await J(),M="home",await _(),K()}catch(h){i.textContent=h.message}}}a()}async function Ge(e){e.innerHTML="";let t=document.createElement("div");t.className="home-container",e.appendChild(t);let l=D?D.username:"",a=document.createElement("div");a.className="welcome-section";let o=document.createElement("p"),n=document.createElement("strong");n.className="text-xl",n.textContent="Salut",o.appendChild(n),o.appendChild(document.createTextNode(` ${l}, voici o\xF9 en est votre groupe aujourd'hui...`)),a.appendChild(o),t.appendChild(a);let c=document.createElement("div");c.className="upcoming-section";let d=document.createElement("h3");d.textContent="\xC0 venir",c.appendChild(d);let r="Aucune prestation pr\xE9vue";try{let g=await x("/performances"),m=new Date,p=g.filter(C=>new Date(C.date)>=m);if(p.sort((C,h)=>new Date(C.date)-new Date(h.date)),p.length>0){let C=p[0];r=`${C.name} (${oe(C.date)})`}}catch{r="Impossible de r\xE9cup\xE9rer les prestations"}let u=document.createElement("p"),s=document.createElement("strong");s.textContent="Prochaine prestation :",u.appendChild(s),u.appendChild(document.createTextNode(" "+r)),c.appendChild(u);let i="\u2014";try{let m=(await x("/agenda")).filter(h=>h.type==="rehearsal"),p=new Date,C=m.filter(h=>new Date(h.date)>=p);if(C.sort((h,w)=>new Date(h.date)-new Date(w.date)),C.length>0){let h=C[0];i=`${oe(h.date)}${h.location?" \u2013 "+h.location:""}`}}catch{}let y=document.createElement("p"),v=document.createElement("strong");v.textContent="Prochaine r\xE9p\xE9tition :",y.appendChild(v),y.appendChild(document.createTextNode(" "+i)),c.appendChild(y),t.appendChild(c)}async function Y(e){e.innerHTML="";let t=document.getElementById("profile-btn"),l=document.getElementById("profile-menu"),a=document.getElementById("menu-performances"),o=document.getElementById("menu-settings"),n=document.getElementById("menu-logout"),c=document.getElementById("theme-toggle");t&&l&&(t.onclick=m=>{m.stopPropagation(),ae()}),c&&(c.textContent=document.body.classList.contains("dark")?"\u2600\uFE0F":"\u{1F319}",c.onclick=async()=>{document.body.classList.toggle("dark");let m=document.body.classList.contains("dark");c.textContent=m?"\u2600\uFE0F":"\u{1F319}";try{let C={...await x("/settings"),darkMode:m};await x("/settings","PUT",C),te(C.darkMode)}catch(p){console.error(p)}}),a&&(a.onclick=()=>{M!=="performances"&&(M="performances",Y(e)),l?.classList.contains("hidden")||ae()}),o&&(o.onclick=()=>{M!=="settings"&&(M="settings",Y(e)),l?.classList.contains("hidden")||ae()}),n&&(n.onclick=async()=>{l?.classList.contains("hidden")||ae(),await ie()});let d=document.createElement("div");d.className="page",e.appendChild(d);let r=document.createElement("div");r.className="nav-bar";let u=[{key:"home",label:"Home",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>'},{key:"suggestions",label:"Suggestions",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"/></svg>'},{key:"rehearsals",label:"R\xE9p\xE8tes",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"/></svg>'},{key:"performances",label:"Prestations",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>'},{key:"agenda",label:"Agenda",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z"/></svg>'}],s=null,i=null,y=50;function v(m){let p=m-s;if(Math.abs(p)>y){let C=u.findIndex(w=>w.key===M),h=p<0?C+1:C-1;h>=0&&h<u.length&&(M=u[h].key,Y(e))}s=null,i=null}d.addEventListener("pointerdown",m=>{s=m.clientX,i=s}),d.addEventListener("pointerup",m=>{s!==null&&v(m.clientX)}),d.addEventListener("pointercancel",()=>{s=null,i=null}),d.addEventListener("touchstart",m=>{m.touches.length===1&&(s=m.touches[0].clientX,i=s)}),d.addEventListener("touchmove",m=>{s!==null&&m.touches.length===1&&(i=m.touches[0].clientX)});function g(m){if(s===null)return;let p=i??m.changedTouches[0]?.clientX;v(p)}if(d.addEventListener("touchend",g),d.addEventListener("touchcancel",()=>{s=null,i=null}),u.forEach(m=>{let p=document.createElement("button");p.innerHTML=`${m.icon}<span>${m.label}</span>`,p.className=M===m.key?"active":"",p.onclick=()=>{M!==m.key&&(M=m.key,Y(e))},r.appendChild(p)}),e.appendChild(r),M==="home")Ge(d);else if(M==="suggestions")F(d);else if(M==="rehearsals"){try{await O()}catch{}W(d)}else if(M==="performances"){try{await O()}catch{}le(d)}else if(M==="agenda"){try{await O()}catch{}G(d)}else M==="settings"&&Q(d)}async function F(e){e.innerHTML="";let t=document.createElement("h2");t.textContent="Morceaux sugg\xE9r\xE9s",t.className="section-title",e.appendChild(t);let l=[];try{l=await x("/suggestions")}catch{let n=document.createElement("p");n.style.color="var(--danger-color)",n.textContent="Impossible de r\xE9cup\xE9rer les suggestions",e.appendChild(n);return}if(l.length===0){let o=document.createElement("p");o.className="empty-state",o.textContent="Aucune proposition pour l\u2019instant",e.appendChild(o)}l.forEach(o=>{let n=document.createElement("div");n.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-pink-50 text-gray-900";let c=document.createElement("div");c.className="card-header";let d=document.createElement("h3");d.textContent=o.title,d.onclick=()=>{n.classList.toggle("collapsed")},c.appendChild(d);let r=document.createElement("div");r.className="like-info";let u=document.createElement("span");u.textContent=`\u2764\uFE0F ${o.likes||0}`;let s=document.createElement("button");s.className="like-btn",s.textContent="\u{1F44D}",s.onclick=async m=>{m.stopPropagation(),s.disabled=!0,i.disabled=!0;try{let p=await x(`/suggestions/${o.id}/vote`,"POST");u.textContent=`\u2764\uFE0F ${p.likes}`,await F(e)}catch(p){alert(p.message),s.disabled=!1,i.disabled=!1}};let i=document.createElement("button");i.className="like-btn",i.textContent="\u{1F44E}",i.onclick=async m=>{m.stopPropagation(),s.disabled=!0,i.disabled=!0;try{let p=await x(`/suggestions/${o.id}/vote`,"DELETE");u.textContent=`\u2764\uFE0F ${p.likes}`,await F(e)}catch(p){alert(p.message),s.disabled=!1,i.disabled=!1}},r.appendChild(u),r.appendChild(s),r.appendChild(i),c.appendChild(r),n.appendChild(c);let y=document.createElement("div");if(y.className="card-details",o.author){let m=document.createElement("p");m.style.fontStyle="italic",m.textContent="Auteur : "+o.author,y.appendChild(m)}if(o.versionOf){let m=document.createElement("p");m.style.fontStyle="italic",m.textContent="Version de : "+o.versionOf,y.appendChild(m)}let v=o.youtube||o.url;if(v){let m=document.createElement("a");m.href=v,m.target="_blank",m.rel="noopener noreferrer",m.textContent=v,y.appendChild(m)}let g=document.createElement("p");if(g.style.fontSize="12px",g.style.color="var(--text-color)",g.textContent=`Ajout\xE9 par ${o.creator}`,y.appendChild(g),D&&(ce()||o.creatorId===D.id||o.creator===D.username)){let m=document.createElement("div");m.className="actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Modifier",p.onclick=w=>{w.stopPropagation(),Ye(o,e)},m.appendChild(p);let C=document.createElement("button");C.className="btn-primary",C.textContent="Passer en r\xE9p\xE9tition",C.onclick=async w=>{w.stopPropagation();try{let T=await x(`/suggestions/${o.id}/to-rehearsal`,"POST");j.push(T),F(e)}catch(T){alert(T.message)}},m.appendChild(C);let h=document.createElement("button");h.className="btn-danger",h.textContent="Supprimer",h.onclick=async w=>{if(w.stopPropagation(),!!confirm("Supprimer cette suggestion ?"))try{await x(`/suggestions/${o.id}`,"DELETE"),F(e)}catch(T){alert(T.message)}},m.appendChild(h),y.appendChild(m)}n.appendChild(y),e.appendChild(n)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau",a.textContent="+",a.onclick=()=>We(e),e.appendChild(a)}function We(e){let t=document.createElement("div");t.className="modal";let l=document.createElement("div");l.className="modal-content";let a=document.createElement("h3");a.textContent="Ajouter une suggestion",l.appendChild(a);let o=document.createElement("form");o.onsubmit=p=>{p.preventDefault()};let n=document.createElement("label");n.textContent="Titre";let c=document.createElement("input");c.type="text",c.required=!0,c.style.width="100%";let d=document.createElement("label");d.textContent="Auteur";let r=document.createElement("input");r.type="text",r.style.width="100%";let u=document.createElement("label");u.textContent="Version de";let s=document.createElement("input");s.type="text",s.style.width="100%";let i=document.createElement("label");i.textContent="Lien YouTube";let y=document.createElement("input");y.type="url",y.style.width="100%",o.appendChild(n),o.appendChild(c),o.appendChild(d),o.appendChild(r),o.appendChild(u),o.appendChild(s),o.appendChild(i),o.appendChild(y),l.appendChild(o);let v=document.createElement("div");v.className="modal-actions";let g=document.createElement("button");g.className="btn-secondary",g.textContent="Annuler",g.onclick=()=>{t.parentNode&&t.parentNode.removeChild(t)};let m=document.createElement("button");m.className="btn-primary",m.textContent="Ajouter",m.onclick=async p=>{p.preventDefault();let C=c.value.trim(),h=r.value.trim(),w=s.value.trim(),T=y.value.trim();if(C)try{await x("/suggestions","POST",{title:C,author:h,youtube:T,versionOf:w}),t.parentNode&&t.parentNode.removeChild(t),F(e)}catch(B){alert(B.message)}},v.appendChild(g),v.appendChild(m),l.appendChild(v),t.appendChild(l),document.body.appendChild(t),setTimeout(()=>c.focus(),50)}function Ye(e,t){let l=document.createElement("div");l.className="modal";let a=document.createElement("div");a.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la suggestion",a.appendChild(o);let n=document.createElement("form");n.onsubmit=C=>C.preventDefault();let c=document.createElement("label");c.textContent="Titre";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.title;let r=document.createElement("label");r.textContent="Auteur";let u=document.createElement("input");u.type="text",u.style.width="100%",u.value=e.author||"";let s=document.createElement("label");s.textContent="Version de";let i=document.createElement("input");i.type="text",i.style.width="100%",i.value=e.versionOf||"";let y=document.createElement("label");y.textContent="Lien YouTube";let v=document.createElement("input");v.type="url",v.style.width="100%",v.value=e.youtube||e.url||"",n.appendChild(c),n.appendChild(d),n.appendChild(r),n.appendChild(u),n.appendChild(s),n.appendChild(i),n.appendChild(y),n.appendChild(v),a.appendChild(n);let g=document.createElement("div");g.className="modal-actions";let m=document.createElement("button");m.className="btn-secondary",m.textContent="Annuler",m.onclick=()=>{l.parentNode&&l.parentNode.removeChild(l)};let p=document.createElement("button");p.className="btn-primary",p.textContent="Enregistrer",p.onclick=async C=>{C.preventDefault();let h=d.value.trim(),w=u.value.trim(),T=i.value.trim(),B=v.value.trim();if(h)try{await x(`/suggestions/${e.id}`,"PUT",{title:h,author:w,versionOf:T,youtube:B}),l.parentNode&&l.parentNode.removeChild(l),F(t)}catch(S){alert(S.message)}},g.appendChild(m),g.appendChild(p),a.appendChild(g),l.appendChild(a),document.body.appendChild(l),setTimeout(()=>d.focus(),50)}async function W(e){e.innerHTML="";let t=document.createElement("h2");t.textContent="Morceaux en cours de travail",t.className="section-title",e.appendChild(t);let l=document.createElement("button");l.textContent="Exporter en PDF",l.className="btn-secondary",l.onclick=async()=>{try{let n=await fetch("/api/repertoire.pdf",{credentials:"include"});if(!n.ok)throw new Error("\xC9chec de l'export PDF");let c=await n.blob(),d=URL.createObjectURL(c),r=document.createElement("a");r.href=d,r.download="repertoire.pdf",document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(d)}catch(n){alert(n.message)}},e.appendChild(l);let a=j;if(a.length===0)try{await O(),a=j}catch{let c=document.createElement("p");c.style.color="var(--danger-color)",c.textContent="Impossible de r\xE9cup\xE9rer les r\xE9p\xE9titions",e.appendChild(c);return}if(a.length===0){let n=document.createElement("p");n.className="empty-state",n.textContent="Aucun morceau en r\xE9p\xE9tition",e.appendChild(n)}a.forEach(n=>{let c=document.createElement("div");c.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-blue-50";let d=n.levels[D.username]!=null?n.levels[D.username]:0,r=document.createElement("div");r.className="card-header";let u=document.createElement("h3");u.textContent=n.title,u.onclick=()=>{c.classList.toggle("collapsed")},r.appendChild(u);let s=document.createElement("span");s.className="level-badge",s.textContent=d,r.appendChild(s),c.appendChild(r);let i=document.createElement("div");if(i.className="card-details",n.author){let E=document.createElement("p");E.style.fontStyle="italic",E.textContent="Auteur : "+n.author,i.appendChild(E)}if(n.youtube){let E=document.createElement("a");E.href=n.youtube,E.target="_blank",E.rel="noopener noreferrer",E.textContent=n.youtube,i.appendChild(E)}let y=document.createElement("div");y.style.marginTop="8px";let v=document.createElement("label");v.textContent=`Votre niveau (${d}/10)`,v.className="level-display";let g=document.createElement("input");g.type="range",g.min=0,g.max=10,g.step=1,g.value=d;function m(E){let L=E/10,f=Math.round(255*(1-L)),b=Math.round(255*L);g.style.background=`linear-gradient(to right, rgb(${f},${b},80) ${E/10*100}%, var(--border-color) ${E/10*100}%)`}m(d),g.oninput=async()=>{let E=Number(g.value);v.textContent=`Votre niveau (${E}/10)`,s.textContent=E,m(E);try{await x(`/rehearsals/${n.id}`,"PUT",{level:E})}catch(L){alert(L.message)}},y.appendChild(v),y.appendChild(g),i.appendChild(y);let p=document.createElement("label");p.textContent="Vos notes";let C=document.createElement("textarea");C.value=n.notes&&n.notes[D.username]||"",C.onchange=async()=>{try{await x(`/rehearsals/${n.id}`,"PUT",{note:C.value})}catch(E){alert(E.message)}},i.appendChild(p),i.appendChild(C);let h=document.createElement("div");h.style.marginTop="8px",(n.audioNotes&&n.audioNotes[D.username]||[]).forEach((E,L)=>{let f=document.createElement("div");if(E.title){let k=document.createElement("div");k.textContent=E.title,f.appendChild(k)}let b=document.createElement("button");b.className="btn-secondary",b.textContent="\xC9couter",b.onclick=()=>me.play(E.audio),f.appendChild(b);let N=document.createElement("button");N.className="btn-danger",N.textContent="Supprimer audio",N.style.marginLeft="8px",N.onclick=async k=>{if(k.preventDefault(),!!confirm("Supprimer la note audio\xA0?"))try{await x(`/rehearsals/${n.id}`,"PUT",{audioIndex:L}),W(e)}catch(P){alert(P.message)}},f.appendChild(N),h.appendChild(f)});let T=document.createElement("input");T.type="text",T.placeholder="Titre de la note",T.style.display="block",T.style.marginTop="8px";let B=document.createElement("input");B.type="file",B.accept="audio/*",B.style.display="none";let S=document.createElement("button");if(S.className="btn-secondary",S.textContent="Ajouter une note audio",S.onclick=E=>{E.preventDefault(),B.click()},B.onchange=async()=>{let E=B.files[0];if(!E)return;if(E.size>5*1024*1024){alert("Le fichier audio est trop volumineux (max 5\xA0Mo).");return}let L=new FileReader;L.onload=async f=>{let b=(f.target?.result||"").toString();try{await x(`/rehearsals/${n.id}`,"PUT",{audio:b,audioTitle:T.value}),W(e)}catch(N){alert(N.message)}},L.readAsDataURL(E)},h.appendChild(T),h.appendChild(S),h.appendChild(B),i.appendChild(h),D){let E=document.createElement("div");E.style.marginTop="8px";let L=document.createElement("label");L.textContent="Partition(s)",E.appendChild(L);let f=document.createElement("div");(n.partitions||[]).forEach(k=>{let P=document.createElement("div"),U=document.createElement("span");U.textContent=`${k.displayName} \u2013 ${k.uploader} \u2013 ${oe(k.date)}`,P.appendChild(U);let $=document.createElement("a");if($.href=k.downloadUrl,$.textContent="T\xE9l\xE9charger",$.target="_blank",$.rel="noopener noreferrer",$.className="btn-secondary",$.style.marginLeft="8px",P.appendChild($),k.uploader===D.username||Ce()){let R=document.createElement("button");R.className="btn-danger",R.textContent="Supprimer",R.style.marginLeft="8px",R.onclick=async V=>{if(V.preventDefault(),!!confirm("Supprimer cette partition\xA0?"))try{await ge(n.id,k.id),await O(),W(e)}catch(z){alert(z.message)}},P.appendChild(R)}f.appendChild(P)}),E.appendChild(f);let b=document.createElement("input");b.type="file",b.accept="application/pdf",b.style.display="none";let N=document.createElement("button");N.className="btn-secondary",N.textContent="D\xE9poser une partition",N.onclick=k=>{k.preventDefault(),b.click()},b.onchange=async()=>{let k=b.files[0];if(k)try{await Ee(n.id,k,k.name),await O(),W(e)}catch(P){alert(P.message)}},E.appendChild(N),E.appendChild(b),i.appendChild(E)}let A=Object.keys(n.levels||{}).filter(E=>E.toLowerCase()!==D.username.toLowerCase());if(A.length>0){let E=document.createElement("div");E.style.marginTop="12px";let L=document.createElement("p");L.textContent="Autres membres :",L.style.fontStyle="italic",E.appendChild(L),A.forEach(f=>{let b=document.createElement("div");b.style.marginBottom="4px";let N=n.levels[f],k=n.notes&&n.notes[f]?n.notes[f]:"",P=document.createElement("p");P.style.margin="0";let U=document.createElement("strong");U.textContent=f,P.appendChild(U),P.appendChild(document.createTextNode(` \u2013 Niveau ${N}/10${k?" \u2013 "+k:""}`)),b.appendChild(P),(n.audioNotes&&n.audioNotes[f]||[]).forEach(R=>{if(R.title){let z=document.createElement("div");z.textContent=R.title,z.style.marginTop="4px",b.appendChild(z)}let V=document.createElement("button");V.className="btn-secondary",V.textContent="\xC9couter",V.style.display="block",V.style.marginTop="4px",V.onclick=()=>me.play(R.audio),b.appendChild(V)}),E.appendChild(b)}),i.appendChild(E)}if(D&&(ce()||D.id===n.creatorId)){let E=document.createElement("div");E.className="actions";let L=document.createElement("button");L.className="btn-secondary",L.textContent="Modifier",L.onclick=N=>{N.stopPropagation(),Fe(n,e)},E.appendChild(L);let f=document.createElement("button");f.className="btn-primary",f.textContent="Remettre dans J\u2019aime",f.onclick=async N=>{N.stopPropagation();try{await x(`/rehearsals/${n.id}/to-suggestion`,"POST"),W(e)}catch(k){alert(k.message)}},E.appendChild(f);let b=document.createElement("button");b.className="btn-danger",b.textContent="Supprimer",b.onclick=async N=>{if(N.stopPropagation(),!!confirm("Supprimer ce morceau ?"))try{await x(`/rehearsals/${n.id}`,"DELETE"),j=j.filter(k=>k.id!==n.id),W(e)}catch(k){alert(k.message)}},E.appendChild(b),i.appendChild(E)}c.appendChild(i),e.appendChild(c)});let o=document.createElement("div");o.className="fab",o.title="Ajouter un morceau en r\xE9p\xE9tition",o.textContent="+",o.onclick=()=>Ze(e),e.appendChild(o)}function Ze(e,t){let l=document.createElement("div");l.className="modal";let a=document.createElement("div");a.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter un morceau",a.appendChild(o);let n=document.createElement("form");n.onsubmit=w=>w.preventDefault();let c=document.createElement("label");c.textContent="Titre";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%";let r=document.createElement("label");r.textContent="Auteur";let u=document.createElement("input");u.type="text",u.style.width="100%";let s=document.createElement("label");s.textContent="Lien YouTube";let i=document.createElement("input");i.type="url",i.style.width="100%";let y=document.createElement("label");y.textContent="Lien Spotify";let v=document.createElement("input");v.type="url",v.style.width="100%";let g=document.createElement("label");g.textContent="Version de";let m=document.createElement("input");m.type="text",m.style.width="100%",n.appendChild(c),n.appendChild(d),n.appendChild(r),n.appendChild(u),n.appendChild(s),n.appendChild(i),n.appendChild(y),n.appendChild(v),n.appendChild(g),n.appendChild(m),a.appendChild(n);let p=document.createElement("div");p.className="modal-actions";let C=document.createElement("button");C.className="btn-secondary",C.textContent="Annuler",C.onclick=()=>{l.parentNode&&l.parentNode.removeChild(l)};let h=document.createElement("button");h.className="btn-primary",h.textContent="Ajouter",h.onclick=async w=>{w.preventDefault();let T=d.value.trim();if(!T)return;let B=u.value.trim(),S=i.value.trim(),A=v.value.trim(),E=m.value.trim();try{let L=await x("/rehearsals","POST",{title:T,author:B,youtube:S,spotify:A,versionOf:E});l.parentNode&&l.parentNode.removeChild(l),j.push(L),typeof t=="function"?t():W(e)}catch(L){alert(L.message)}},p.appendChild(C),p.appendChild(h),a.appendChild(p),l.appendChild(a),document.body.appendChild(l),setTimeout(()=>d.focus(),50)}function Fe(e,t,l){let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let n=document.createElement("h3");n.textContent="Modifier le morceau",o.appendChild(n);let c=document.createElement("form");c.onsubmit=T=>T.preventDefault();let d=document.createElement("label");d.textContent="Titre";let r=document.createElement("input");r.type="text",r.required=!0,r.style.width="100%",r.value=e.title;let u=document.createElement("label");u.textContent="Auteur";let s=document.createElement("input");s.type="text",s.style.width="100%",s.value=e.author||"";let i=document.createElement("label");i.textContent="Lien YouTube";let y=document.createElement("input");y.type="url",y.style.width="100%",y.value=e.youtube||"";let v=document.createElement("label");v.textContent="Lien Spotify";let g=document.createElement("input");g.type="url",g.style.width="100%",g.value=e.spotify||"";let m=document.createElement("label");m.textContent="Version de";let p=document.createElement("input");p.type="text",p.style.width="100%",p.value=e.versionOf||"",c.appendChild(d),c.appendChild(r),c.appendChild(u),c.appendChild(s),c.appendChild(i),c.appendChild(y),c.appendChild(v),c.appendChild(g),c.appendChild(m),c.appendChild(p),o.appendChild(c);let C=document.createElement("div");C.className="modal-actions";let h=document.createElement("button");h.className="btn-secondary",h.textContent="Annuler",h.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let w=document.createElement("button");w.className="btn-primary",w.textContent="Enregistrer",w.onclick=async T=>{T.preventDefault();let B=r.value.trim(),S=s.value.trim(),A=y.value.trim(),E=g.value.trim(),L=p.value.trim();if(B)try{await x(`/rehearsals/${e.id}`,"PUT",{title:B,author:S,youtube:A,spotify:E,versionOf:L}),a.parentNode&&a.parentNode.removeChild(a);let f=j.findIndex(b=>b.id===e.id);f!==-1&&(j[f]={...j[f],title:B,author:S||null,youtube:A||null,spotify:E||null,versionOf:L||null}),typeof l=="function"?l():W(t)}catch(f){alert(f.message)}},C.appendChild(h),C.appendChild(w),o.appendChild(C),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>r.focus(),50)}async function le(e){e.innerHTML="";let t=document.createElement("h2");t.className="section-title",t.textContent="Prestations",e.appendChild(t);let l=[];try{l=await x("/performances")}catch{let u=document.createElement("p");u.style.color="var(--danger-color)",u.textContent="Impossible de r\xE9cup\xE9rer les prestations",e.appendChild(u);return}if(j.length===0)try{await O()}catch{}let a=new Date,o=l.filter(r=>new Date(r.date)>=a),n=l.filter(r=>new Date(r.date)<a);function c(r,u){let s=document.createElement("div");if(s.className="section-title",s.textContent=r,e.appendChild(s),u.length===0){let i=document.createElement("p");i.textContent="Aucune prestation",e.appendChild(i);return}u.forEach(i=>{let y=document.createElement("div");y.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-green-50";let v=document.createElement("h3");v.textContent=i.name,v.onclick=()=>{y.classList.toggle("collapsed")},y.appendChild(v);let g=document.createElement("div");g.className="card-details";let m=document.createElement("p");if(m.textContent="Date : "+oe(i.date),g.appendChild(m),i.location){let p=document.createElement("p");p.textContent="Lieu : "+i.location,g.appendChild(p)}if(i.songs&&i.songs.length>0){let p=document.createElement("ul");i.songs.forEach(C=>{let h=j.find(T=>T.id===C),w=document.createElement("li");w.textContent=h?h.title:"\u2014",p.appendChild(w)}),g.appendChild(p)}if(D&&(ce()||D.id===i.creatorId)){let p=document.createElement("div");p.className="actions";let C=document.createElement("button");C.className="btn-secondary",C.textContent="Modifier",C.onclick=w=>{w.stopPropagation(),De(i,e)},p.appendChild(C);let h=document.createElement("button");h.className="btn-danger",h.textContent="Supprimer",h.onclick=async w=>{if(w.stopPropagation(),!!confirm("Supprimer cette prestation ?"))try{await x(`/performances/${i.id}`,"DELETE"),le(e)}catch(T){alert(T.message)}},p.appendChild(h),g.appendChild(p)}y.appendChild(g),e.appendChild(y)})}c("\xC0 venir",o),c("Pass\xE9es",n);let d=document.createElement("div");d.className="fab",d.title="Ajouter une prestation",d.textContent="+",d.onclick=()=>he(e),e.appendChild(d)}async function G(e){e.innerHTML="";let t=document.createElement("h2");t.textContent="Agenda",t.className="section-title",e.appendChild(t);let l=document.createElement("div");l.className="calendar-nav";let a=document.createElement("button");a.textContent="<",a.onclick=()=>{H.setMonth(H.getMonth()-1),G(e)};let o=document.createElement("button");o.textContent=">",o.onclick=()=>{H.setMonth(H.getMonth()+1),G(e)};let n=document.createElement("span");n.textContent=H.toLocaleDateString(void 0,{month:"long",year:"numeric"}),l.appendChild(a),l.appendChild(n),l.appendChild(o),e.appendChild(l);let c=document.createElement("div");c.className="actions";let d=document.createElement("button");d.className="btn-secondary",d.textContent="Nouvelle r\xE9p\xE9tition",d.onclick=()=>Le(e,()=>G(e));let r=document.createElement("button");r.className="btn-secondary",r.textContent="Nouvelle prestation",r.onclick=()=>he(e,()=>G(e)),c.appendChild(d),c.appendChild(r),e.appendChild(c);let u=[];try{let C=H.getFullYear(),h=H.getMonth()+1,w=String(h).padStart(2,"0"),T=`${C}-${w}-01`,B=`${C}-${w}-31`;u=await x(`/agenda?start=${T}&end=${B}`)}catch{let h=document.createElement("p");h.style.color="var(--danger-color)",h.textContent="Impossible de r\xE9cup\xE9rer l'agenda",e.appendChild(h);return}u.sort((C,h)=>C.date.localeCompare(h.date));let s=document.createElement("div");s.className="calendar-grid",["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(C=>{let h=document.createElement("div");h.className="calendar-day-name",h.textContent=C,s.appendChild(h)});let y=H.getFullYear(),v=H.getMonth(),m=(new Date(y,v,1).getDay()+6)%7;for(let C=0;C<m;C++){let h=document.createElement("div");h.className="calendar-cell empty",s.appendChild(h)}let p=new Date(y,v+1,0).getDate();for(let C=1;C<=p;C++){let h=document.createElement("div");h.className="calendar-cell";let w=document.createElement("div");w.className="calendar-date",w.textContent=C,h.appendChild(w);let T=`${y}-${String(v+1).padStart(2,"0")}-${String(C).padStart(2,"0")}`,B=u.filter(S=>S.date?.startsWith(T));B.forEach(S=>{let A=document.createElement("div");A.className=`calendar-event ${S.type==="performance"?"performance":"rehearsal"}`;let E=S.title||S.location||"",L=S.type==="performance"?"Prestation":"R\xE9p\xE9tition";A.textContent=E||L,A.onclick=async f=>{if(f.preventDefault(),f.stopPropagation(),S.type==="performance")try{j.length===0&&await O();let N=(await x("/performances")).find(k=>k.id===S.id);N&&De(N,e,()=>G(e))}catch(b){alert(b.message)}else _e(S,e,()=>G(e))},h.appendChild(A)}),B.length===0&&(h.onclick=async()=>{if(!ce())return;if(confirm("Ajouter une prestation ? (Annuler pour une r\xE9p\xE9tition)")){try{j.length===0&&await O()}catch{}he(e,()=>G(e),T)}else Le(e,()=>G(e),`${T}T20:00`)}),s.appendChild(h)}e.appendChild(s)}function Le(e,t,l){let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let n=document.createElement("h3");n.textContent="Ajouter une r\xE9p\xE9tition",o.appendChild(n);let c=document.createElement("form");c.onsubmit=g=>g.preventDefault();let d=document.createElement("label");d.textContent="Date et heure";let r=document.createElement("input");r.type="datetime-local",r.required=!0,r.style.width="100%",l&&(r.value=l);let u=document.createElement("label");u.textContent="Lieu";let s=document.createElement("input");s.type="text",s.style.width="100%",c.appendChild(d),c.appendChild(r),c.appendChild(u),c.appendChild(s),o.appendChild(c);let i=document.createElement("div");i.className="modal-actions";let y=document.createElement("button");y.className="btn-secondary",y.textContent="Annuler",y.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let v=document.createElement("button");v.className="btn-primary",v.textContent="Ajouter",v.onclick=async g=>{g.preventDefault();let m=r.value;if(!m)return;let p=s.value.trim();try{await x("/agenda","POST",{type:"rehearsal",date:m,location:p}),a.parentNode&&a.parentNode.removeChild(a),typeof t=="function"&&t()}catch(C){alert(C.message)}},i.appendChild(y),i.appendChild(v),o.appendChild(i),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>r.focus(),50)}async function he(e,t,l){try{await O()}catch(T){alert(T.message);return}let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let n=document.createElement("h3");n.textContent="Ajouter une prestation",o.appendChild(n);let c=document.createElement("form");c.onsubmit=T=>T.preventDefault();let d=document.createElement("label");d.textContent="Nom";let r=document.createElement("input");r.type="text",r.required=!0,r.style.width="100%";let u=document.createElement("label");u.textContent="Date";let s=document.createElement("input");s.type="date",s.required=!0,s.style.width="100%",l&&(s.value=l);let i=document.createElement("label");i.textContent="Heure";let y=document.createElement("input");y.type="time",y.required=!0,y.style.width="100%";let v=document.createElement("label");v.textContent="Lieu";let g=document.createElement("input");g.type="text",g.style.width="100%";let m=document.createElement("label");m.textContent="Morceaux jou\xE9s";let p=document.createElement("div");p.className="select-list",j.forEach(T=>{let B=document.createElement("label");B.style.display="flex",B.style.justifyContent="space-between",B.style.alignItems="center";let S=document.createElement("input");S.type="checkbox",S.value=T.id;let A=document.createElement("span");A.textContent=T.title,A.style.marginLeft="4px";let E=document.createElement("span");E.appendChild(S),E.appendChild(A);let L=document.createElement("span");L.className="level-badge";let f=Object.values(T.levels||{}).map(Number),b=f.length>0?f.reduce((N,k)=>N+k,0)/f.length:0;L.textContent=b.toFixed(1),B.appendChild(E),B.appendChild(L),p.appendChild(B)}),c.appendChild(d),c.appendChild(r),c.appendChild(u),c.appendChild(s),c.appendChild(i),c.appendChild(y),c.appendChild(v),c.appendChild(g),c.appendChild(m),c.appendChild(p),o.appendChild(c);let C=document.createElement("div");C.className="modal-actions";let h=document.createElement("button");h.className="btn-secondary",h.textContent="Annuler",h.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let w=document.createElement("button");w.className="btn-primary",w.textContent="Ajouter",w.onclick=async T=>{T.preventDefault();let B=r.value.trim(),S=s.value,A=y.value,E=g.value.trim();if(!B||!S||!A)return;let L=`${S}T${A}`,f=[];p.querySelectorAll('input[type="checkbox"]').forEach(N=>{N.checked&&f.push(Number(N.value))});let b=!1;for(let N of f){let k=j.find(P=>P.id===N);if(k){let P=Object.values(k.levels||{}).map(Number);if((P.length?Math.min(...P):0)<=6){b=!0;break}}}if(!(b&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Ajouter quand m\xEAme ?")))try{await x("/performances","POST",{name:B,date:L,location:E,songs:f}),a.parentNode&&a.parentNode.removeChild(a),typeof t=="function"?t():le(e)}catch(N){alert(N.message)}},C.appendChild(h),C.appendChild(w),o.appendChild(C),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>r.focus(),50)}function _e(e,t,l){let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let n=document.createElement("h3");n.textContent="Modifier la r\xE9p\xE9tition",o.appendChild(n);let c=document.createElement("form");c.onsubmit=g=>g.preventDefault();let d=document.createElement("label");d.textContent="Date et heure";let r=document.createElement("input");r.type="datetime-local",r.required=!0,r.style.width="100%",r.value=e.date||"";let u=document.createElement("label");u.textContent="Lieu";let s=document.createElement("input");s.type="text",s.style.width="100%",s.value=e.location||"",c.appendChild(d),c.appendChild(r),c.appendChild(u),c.appendChild(s),o.appendChild(c);let i=document.createElement("div");i.className="modal-actions";let y=document.createElement("button");y.className="btn-secondary",y.textContent="Annuler",y.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let v=document.createElement("button");v.className="btn-primary",v.textContent="Enregistrer",v.onclick=async g=>{g.preventDefault();let m=r.value;if(!m)return;let p=s.value.trim();try{await x(`/agenda/${e.id}`,"PUT",{type:"rehearsal",date:m,location:p}),a.parentNode&&a.parentNode.removeChild(a),typeof l=="function"&&l()}catch(C){alert(C.message)}},i.appendChild(y),i.appendChild(v),o.appendChild(i),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>r.focus(),50)}async function De(e,t,l){try{await O()}catch(S){alert(S.message);return}let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let n=document.createElement("h3");n.textContent="Modifier la prestation",o.appendChild(n);let c=document.createElement("form");c.onsubmit=S=>S.preventDefault();let d=document.createElement("label");d.textContent="Nom";let r=document.createElement("input");r.type="text",r.required=!0,r.style.width="100%",r.value=e.name;let u=document.createElement("label");u.textContent="Date";let s=document.createElement("input");s.type="date",s.required=!0,s.style.width="100%";let[i,y]=(e.date||"").split("T");s.value=i;let v=document.createElement("label");v.textContent="Heure";let g=document.createElement("input");g.type="time",g.required=!0,g.style.width="100%",g.value=(y||"").slice(0,5);let m=document.createElement("label");m.textContent="Lieu";let p=document.createElement("input");p.type="text",p.style.width="100%",p.value=e.location||"";let C=document.createElement("label");C.textContent="Morceaux jou\xE9s";let h=document.createElement("div");h.className="select-list",j.forEach(S=>{let A=document.createElement("label");A.style.display="flex",A.style.justifyContent="space-between",A.style.alignItems="center";let E=document.createElement("input");E.type="checkbox",E.value=S.id,e.songs.includes(S.id)&&(E.checked=!0);let L=document.createElement("span");L.textContent=S.title,L.style.marginLeft="4px";let f=document.createElement("span");f.appendChild(E),f.appendChild(L);let b=document.createElement("span");b.className="level-badge";let N=Object.values(S.levels||{}).map(Number),k=N.length>0?N.reduce((P,U)=>P+U,0)/N.length:0;b.textContent=k.toFixed(1),A.appendChild(f),A.appendChild(b),h.appendChild(A)}),c.appendChild(d),c.appendChild(r),c.appendChild(u),c.appendChild(s),c.appendChild(v),c.appendChild(g),c.appendChild(m),c.appendChild(p),c.appendChild(C),c.appendChild(h),o.appendChild(c);let w=document.createElement("div");w.className="modal-actions";let T=document.createElement("button");T.className="btn-secondary",T.textContent="Annuler",T.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let B=document.createElement("button");B.className="btn-primary",B.textContent="Enregistrer",B.onclick=async S=>{S.preventDefault();let A=r.value.trim(),E=s.value,L=g.value,f=p.value.trim();if(!A||!E||!L)return;let b=`${E}T${L}`,N=[];h.querySelectorAll('input[type="checkbox"]').forEach(P=>{P.checked&&N.push(Number(P.value))});let k=!1;for(let P of N){let U=j.find($=>$.id===P);if(U){let $=Object.values(U.levels||{}).map(Number);if(($.length?Math.min(...$):0)<=6){k=!0;break}}}if(!(k&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Enregistrer quand m\xEAme ?")))try{await x(`/performances/${e.id}`,"PUT",{name:A,date:b,location:f,songs:N}),a.parentNode&&a.parentNode.removeChild(a),typeof l=="function"?l():le(t)}catch(P){alert(P.message)}},w.appendChild(T),w.appendChild(B),o.appendChild(w),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>r.focus(),50)}function ze(e){let t=document.createElement("div");t.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let l=document.createElement("h3");l.textContent="Groupes",t.appendChild(l);let a=document.createElement("select");a.id="group-select",t.appendChild(a);let o=document.createElement("div");o.style.marginTop="10px";let n=document.createElement("button");n.id="create-group-btn",n.className="btn-secondary",n.textContent="Cr\xE9er",o.appendChild(n);let c=document.createElement("button");c.id="join-group-btn",c.className="btn-secondary",c.textContent="Rejoindre",c.style.marginLeft="8px",o.appendChild(c);let d=document.createElement("button");if(d.id="rename-group-btn",d.className="btn-secondary",d.textContent="Renommer",d.style.marginLeft="8px",d.onclick=async()=>{let r=prompt("Nouveau nom du groupe",e.groupName);if(!r||r.trim()===""||r===e.groupName)return;let u=r.trim(),s=e.id||D.groupId;try{await x(`/groups/${s}`,"PUT",{name:u}),e.groupName=u,document.title=`${e.groupName} \u2013 BandTrack`;let i=document.getElementById("group-name");i&&(i.textContent=e.groupName),await _(s),await Q(document.getElementById("app"))}catch(i){alert(i.message)}},o.appendChild(d),t.appendChild(o),Ce()){let r=document.createElement("div");r.style.marginTop="8px";let u=e.invitationCode,s=document.createElement("span");s.textContent=`Code d'invitation : ${u}`,r.appendChild(s);let i=document.createElement("button");i.textContent="Copier",i.style.marginLeft="8px",i.onclick=()=>navigator.clipboard.writeText(u),r.appendChild(i);let y=document.createElement("button");y.textContent="Renouveler",y.style.marginLeft="8px",y.onclick=async()=>{try{u=(await x("/groups/renew-code","POST")).invitationCode,s.textContent=`Code d'invitation : ${u}`}catch(v){alert(v.message)}},r.appendChild(y),t.appendChild(r)}return t}function Xe(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let t=document.createElement("h3");t.textContent="Mot de passe",e.appendChild(t);let l=document.createElement("form");l.onsubmit=u=>u.preventDefault();let a=document.createElement("label");a.textContent="Mot de passe actuel";let o=document.createElement("input");o.type="password",o.required=!0,o.style.width="100%";let n=document.createElement("label");n.textContent="Nouveau mot de passe";let c=document.createElement("input");c.type="password",c.required=!0,c.style.width="100%";let d=document.createElement("button");d.className="btn-primary",d.type="submit",d.textContent="Modifier",d.style.marginTop="8px";let r=document.createElement("p");return r.style.marginTop="8px",l.appendChild(a),l.appendChild(o),l.appendChild(n),l.appendChild(c),l.appendChild(d),l.appendChild(r),l.onsubmit=async u=>{u.preventDefault(),r.textContent="";try{await x("/password","PUT",{oldPassword:o.value,newPassword:c.value}),r.style.color="green",r.textContent="Mot de passe mis \xE0 jour",o.value="",c.value=""}catch(s){r.style.color="var(--danger-color)",r.textContent=s.message}},e.appendChild(l),e}function Je(e){let t=document.createElement("div");t.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let l=document.createElement("h3");l.textContent="Th\xE8me",t.appendChild(l);let a=document.createElement("div"),o=document.createElement("label");o.textContent="Mode sombre",o.style.marginRight="8px";let n=document.createElement("input");n.type="checkbox",n.checked=e.darkMode,n.onchange=async()=>{e.darkMode=n.checked;try{await x("/settings","PUT",e),te(n.checked)}catch(s){alert(s.message)}},a.appendChild(o),a.appendChild(n),t.appendChild(a);let c=document.createElement("div");c.style.marginTop="20px";let d=document.createElement("label");d.textContent="Template (design)",d.style.marginRight="8px";let r=document.createElement("select");return[{value:"classic",label:"Classique"},{value:"groove",label:"Groove"},{value:"violet",label:"Violet"},{value:"imgbg",label:"Image"}].forEach(s=>{let i=document.createElement("option");i.value=s.value,i.textContent=s.label,r.appendChild(i)}),r.value=e.template||"classic",r.onchange=async()=>{let s=r.value;e.template=s;try{await x("/settings","PUT",e),se(s)}catch(i){alert(i.message)}},c.appendChild(d),c.appendChild(r),t.appendChild(c),t}async function Qe(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let t=document.createElement("h3");if(t.textContent="Membres",e.appendChild(t),q==null||D?.needsGroup){let l=document.createElement("p");return l.textContent="Aucun groupe actif",e.appendChild(l),e}try{let l=await x(`/groups/${q}/members`),a=document.createElement("table");a.className="user-table";let o=document.createElement("thead");o.innerHTML="<tr><th>Membre</th><th>R\xF4le</th></tr>",a.appendChild(o);let n=document.createElement("tbody");l.forEach(c=>{let d=document.createElement("tr"),r=document.createElement("td");r.textContent=c.username;let u=document.createElement("td");u.textContent=c.role,d.appendChild(r),d.appendChild(u),n.appendChild(d)}),a.appendChild(n),e.appendChild(a)}catch{let a=document.createElement("p");a.style.color="var(--danger-color)",a.textContent="Impossible de r\xE9cup\xE9rer les membres du groupe",e.appendChild(a)}return e}async function Ke(e){let t=document.createElement("div");t.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let l=document.createElement("h3");if(l.textContent="Administration",t.appendChild(l),q==null||D?.needsGroup){let a=document.createElement("p");return a.textContent="Aucun groupe actif",t.appendChild(a),t}try{let a=await x("/context");if(!a){let f=document.createElement("p");return f.textContent="Aucun groupe actif",t.appendChild(f),t}let[o,n]=await Promise.all([x(`/groups/${q}/members`),x("/users")]),c=document.createElement("h4");c.textContent="Tableau de bord du groupe",c.style.marginTop="10px",t.appendChild(c);let d=document.createElement("div"),r=a.invitation_code,u=document.createElement("span");u.textContent=`Code d'invitation : ${r}`,d.appendChild(u);let s=document.createElement("button");s.textContent="Copier",s.style.marginLeft="8px",s.onclick=()=>navigator.clipboard.writeText(r),d.appendChild(s);let i=document.createElement("button");i.textContent="Renouveler",i.style.marginLeft="8px",i.onclick=async()=>{try{r=(await x("/groups/renew-code","POST")).invitationCode,u.textContent=`Code d'invitation : ${r}`}catch(f){alert(f.message)}},d.appendChild(i),t.appendChild(d);let y=document.createElement("table");y.className="user-table";let v=document.createElement("thead");v.innerHTML="<tr><th>Membre</th><th>R\xF4le</th><th>Actions</th></tr>",y.appendChild(v);let g=document.createElement("tbody");o.forEach(f=>{let b=document.createElement("tr"),N=document.createElement("td");N.textContent=f.username;let k=document.createElement("td"),P=document.createElement("select");["user","moderator","admin"].forEach(R=>{let V=document.createElement("option");V.value=R,V.textContent=R,f.role===R&&(V.selected=!0),P.appendChild(V)}),f.userId===D.id&&(P.disabled=!0),P.onchange=async()=>{try{await x(`/groups/${q}/members`,"PUT",{id:f.id,role:P.value})}catch(R){alert(R.message)}},k.appendChild(P);let U=document.createElement("td"),$=document.createElement("button");$.textContent=f.userId===D.id?"Quitter":"Retirer",$.onclick=async()=>{let R=f.userId===D.id?"Quitter le groupe ?":"Supprimer ce membre ?";if(confirm(R))try{await x(`/groups/${q}/members`,"DELETE",{userId:f.userId}),f.userId===D.id?(alert("Quitter le groupe"),D.needsGroup=!0,K()):(b.remove(),alert("Membre supprim\xE9"))}catch(V){alert(V.message)}},U.appendChild($),b.appendChild(N),b.appendChild(k),b.appendChild(U),g.appendChild(b)}),y.appendChild(g),t.appendChild(y);let m=new Set(o.map(f=>f.userId)),p=n.filter(f=>!m.has(f.id));if(p.length>0){let f=document.createElement("div"),b=document.createElement("select");p.forEach(k=>{let P=document.createElement("option");P.value=k.id,P.textContent=k.username,b.appendChild(P)}),f.appendChild(b);let N=document.createElement("button");N.textContent="Ajouter",N.style.marginLeft="8px",N.onclick=async()=>{try{let k=Number(b.value);await x(`/groups/${q}/members`,"POST",{userId:k,role:"user"}),Q(e)}catch(k){alert(k.message)}},f.appendChild(N),t.appendChild(f)}let C=document.createElement("div"),h=document.createElement("input");h.type="email",h.placeholder="adresse e-mail",C.appendChild(h);let w=document.createElement("button");w.textContent="Inviter",w.style.marginLeft="8px",w.onclick=async()=>{let f=h.value.trim();if(f)try{let b=await x(`/groups/${q}/invite`,"POST",{email:f});b.temporaryPassword&&alert(`Mot de passe temporaire : ${b.temporaryPassword}`),Q(e)}catch(b){alert(b.message)}},C.appendChild(w),t.appendChild(C);let T=document.createElement("h4");T.textContent="Gestion des utilisateurs",T.style.marginTop="30px",t.appendChild(T);let B=document.createElement("table");B.className="user-table";let S=document.createElement("thead");S.innerHTML="<tr><th>Utilisateur</th><th>R\xF4le</th></tr>",B.appendChild(S);let A=document.createElement("tbody"),E={};n.forEach(f=>{E[f.id]=f.role;let b=document.createElement("tr"),N=document.createElement("td");N.textContent=f.username;let k=document.createElement("td"),P=document.createElement("select");["user","moderator","admin"].forEach(U=>{let $=document.createElement("option");$.value=U,$.textContent=U,f.role===U&&($.selected=!0),P.appendChild($)}),f.id===D.id&&(P.disabled=!0),P.dataset.userId=f.id,k.appendChild(P),b.appendChild(N),b.appendChild(k),A.appendChild(b)}),B.appendChild(A),t.appendChild(B);let L=document.createElement("button");L.className="btn-primary",L.style.marginTop="10px",L.textContent="Enregistrer les r\xF4les",L.onclick=async()=>{try{let f=[];A.querySelectorAll("select").forEach(b=>{let N=Number(b.dataset.userId),k=b.value;E[N]!==k&&f.push({id:N,role:k})});for(let b of f)await x(`/users/${b.id}`,"PUT",{role:b.role});alert("R\xF4les mis \xE0 jour"),Q(e)}catch(f){alert(f.message)}},t.appendChild(L)}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les membres",t.appendChild(o)}return t}async function Q(e){e.innerHTML="";let t=document.createElement("h2");if(t.className="section-title",t.textContent="Param\xE8tres",e.appendChild(t),D){let s=document.createElement("p");s.className="user-info",s.textContent=`Utilisateur connect\xE9: ${D.username}`,e.appendChild(s)}let l=document.createElement("div");l.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let a=document.createElement("button");a.className="logout-btn",a.textContent="Se d\xE9connecter",a.onclick=ie,l.appendChild(a);let o=document.createElement("button");o.id="delete-account-btn",o.className="delete-account-btn",o.textContent="Supprimer mon compte",o.onclick=Se,l.appendChild(o);let n;try{n=await x("/settings")}catch{let i=document.createElement("p");i.style.color="var(--danger-color)",i.textContent="Impossible de r\xE9cup\xE9rer les param\xE8tres",e.appendChild(i),e.appendChild(l);return}let c={...n},d=ze(c);e.appendChild(d);try{await _();let s=await Qe();e.appendChild(s)}catch(s){console.error("Failed to load groups or members",s)}let r=Je(c);e.appendChild(r);let u=Xe();if(e.appendChild(u),e.appendChild(l),Ce()){let s=await Ke(e);e.appendChild(s)}}window.addEventListener("DOMContentLoaded",Oe)});et();})();
