(()=>{var ce=(e,n)=>()=>(e&&(n=e(e=0)),n);var ge=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports);function le(){U.rehearsalsCache=[]}var U,K=ce(()=>{U={currentUser:null,currentPage:"home",rehearsalsCache:[],groupsCache:[],activeGroupId:null,agendaDate:new Date}});async function x(e,n="GET",r){let a={method:n,credentials:"same-origin"};r!==void 0&&(a.headers={"Content-Type":"application/json"},a.body=JSON.stringify(r));let o=await fetch("/api"+e,a),t;try{t=await o.json()}catch{t=null}if(o.status===401)throw U.currentUser=null,new Error(t?.error||"Non authentifi\xE9");if(o.status===403&&t&&t.error==="No membership")throw U.currentUser&&(U.currentUser.needsGroup=!0),new Error("No membership");if(o.status===404&&e==="/context"&&n==="GET")return null;if(!o.ok)throw new Error(t&&t.error||"Erreur API");return t}function xe(e){return x(`/rehearsals/${e}/partitions`)}async function me(e,n,r){let a=new FormData;a.append("file",n),r&&a.append("displayName",r);let o=await fetch(`/api/rehearsals/${e}/partitions`,{method:"POST",body:a,credentials:"same-origin"}),t;try{t=await o.json()}catch{t=null}if(o.status===401)throw U.currentUser=null,new Error(t?.error||"Non authentifi\xE9");if(!o.ok)throw new Error(t&&t.error||"Erreur API");return t}function ue(e,n){return x(`/rehearsals/${e}/partitions/${n}`,"DELETE")}async function O(){let e=await x("/rehearsals"),n=await Promise.allSettled(e.map(a=>xe(a.id))),r=[];n.forEach((a,o)=>{let t=e[o];a.status==="fulfilled"?r.push({...t,partitions:a.value}):console.error(`Erreur lors de la r\xE9cup\xE9ration des partitions pour le morceau ${t.id}`,a.reason)}),U.rehearsalsCache=r}var re=ce(()=>{K();setInterval(()=>{U.currentUser&&O().catch(()=>{})},5*60*1e3)});async function J(){try{let e=await x("/me");if(U.currentUser=e,!e.needsGroup){let n=await x("/settings");ee(n.darkMode),de(n.template||"classic"),document.title=`${n.groupName} \u2013 BandTrack`;let r=document.getElementById("group-name");r&&(r.textContent=n.groupName)}}catch{U.currentUser=null}}function ee(e){let n=document.body;e?n.classList.add("dark"):n.classList.remove("dark")}function de(e){let n=document.body;n.classList.forEach(r=>{r.startsWith("template-")&&n.classList.remove(r)}),n.classList.add("template-"+e)}async function se(){try{await x("/logout","POST"),U.currentUser=null}catch(e){alert(e.message)}}var he=ce(()=>{K();re()});var Ve=ge(()=>{K();re();he();var B=null,$="home",I=[],F=[],q=null,H=new Date;Object.defineProperties(U,{currentUser:{get:()=>B,set:e=>B=e},currentPage:{get:()=>$,set:e=>$=e},rehearsalsCache:{get:()=>I,set:e=>I=e},groupsCache:{get:()=>F,set:e=>F=e},activeGroupId:{get:()=>q,set:e=>q=e},agendaDate:{get:()=>H,set:e=>H=e}});document.addEventListener("click",e=>{let n=document.getElementById("profile-menu"),r=document.getElementById("profile-btn");n&&!n.classList.contains("hidden")&&!n.contains(e.target)&&e.target!==r&&!r?.contains(e.target)&&(n.classList.add("hidden"),n.classList.remove("block","open"),r?.classList.remove("open"))});function te(){let e=document.getElementById("profile-menu"),n=document.getElementById("profile-btn");!e||!n||(e.classList.toggle("hidden"),e.classList.toggle("block"),e.classList.toggle("open"),n.classList.toggle("open"))}function ae(){return B&&(B.membershipRole==="admin"||B.membershipRole==="moderator")}function pe(){return B&&B.membershipRole==="admin"}function ne(e){if(!e)return"";let n=new Date(e);return isNaN(n)?e:n.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short",hour12:!1})}async function ye(){if(confirm("\xCAtes-vous s\xFBr de vouloir supprimer votre compte ?"))try{await x("/me","DELETE"),B=null,X()}catch(n){alert(n.message)}}async function Ce(e){await x("/context","PUT",{groupId:Number(e)}),localStorage.setItem("activeGroupId",String(e)),q=Number(e),le(),await J()}async function W(e){if(!B)return;let n=document.getElementById("group-select"),r=document.getElementById("create-group-btn"),a=document.getElementById("join-group-btn");r&&(r.onclick=()=>Ee()),a&&(a.onclick=()=>ve());try{F=await x("/groups");let o=e||localStorage.getItem("activeGroupId");F.some(t=>String(t.id)===String(o))||(o=F[0]?F[0].id:null),n&&(n.innerHTML="",F.forEach(t=>{let c=document.createElement("option");c.value=t.id,c.textContent=t.name,n.appendChild(c)}),o&&(n.value=o),n.onchange=async()=>{await Ce(n.value),Z(document.getElementById("app"))}),o&&await Ce(o)}catch(o){console.error(o)}}function Ee(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let r=document.createElement("h3");r.textContent="Cr\xE9er un groupe",n.appendChild(r);let a=document.createElement("form");a.onsubmit=m=>m.preventDefault();let o=document.createElement("label");o.textContent="Nom du groupe";let t=document.createElement("input");t.type="text",t.required=!0,t.style.width="100%",a.appendChild(o),a.appendChild(t),n.appendChild(a);let c=document.createElement("div");c.className="modal-actions";let s=document.createElement("button");s.className="btn-secondary",s.textContent="Annuler",s.onclick=()=>e.remove();let l=document.createElement("button");l.className="btn-primary",l.textContent="Cr\xE9er",l.onclick=async()=>{let m=t.value.trim();if(m)try{let d=await x("/groups","POST",{name:m});alert("Code d'invitation : "+d.invitationCode),e.remove(),await W(d.id),Z(document.getElementById("app"))}catch(d){alert(d.message)}},c.appendChild(s),c.appendChild(l),n.appendChild(c),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>t.focus(),50)}function ve(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let r=document.createElement("h3");r.textContent="Rejoindre un groupe",n.appendChild(r);let a=document.createElement("form");a.onsubmit=i=>i.preventDefault();let o=document.createElement("label");o.textContent="Code d'invitation";let t=document.createElement("input");t.type="text",t.required=!0,t.style.width="100%";let c=document.createElement("label");c.textContent="Surnom";let s=document.createElement("input");s.type="text",s.style.width="100%",a.appendChild(o),a.appendChild(t),a.appendChild(c),a.appendChild(s),n.appendChild(a);let l=document.createElement("div");l.className="modal-actions";let m=document.createElement("button");m.className="btn-secondary",m.textContent="Annuler",m.onclick=()=>e.remove();let d=document.createElement("button");d.className="btn-primary",d.textContent="Rejoindre",d.onclick=async()=>{let i=t.value.trim(),p=s.value.trim();if(i)try{let y=await x("/groups/join","POST",{code:i,nickname:p});e.remove(),await W(y.groupId),Z(document.getElementById("app"))}catch(y){alert(y.message)}},l.appendChild(m),l.appendChild(d),n.appendChild(l),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>t.focus(),50)}async function we(){await J(),B&&await W(),X()}function X(){let e=document.getElementById("app");if(B)B.needsGroup?Ne(e):Z(e);else{let n=document.getElementById("group-name");n&&(n.textContent=""),le(),ke(e)}}function Ne(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let r=document.createElement("h2");r.textContent="Rejoindre ou cr\xE9er un groupe",n.appendChild(r);let a=document.createElement("p");a.textContent="Vous devez s\xE9lectionner ou cr\xE9er un groupe pour continuer.",n.appendChild(a);let o=document.createElement("p");o.textContent="Pour rejoindre un groupe existant, munissez-vous de son code d'invitation ou demandez \xE0 un administrateur de vous ajouter directement.",n.appendChild(o);let t=document.createElement("div"),c=document.createElement("button");c.className="btn-primary",c.textContent="Cr\xE9er un groupe",c.onclick=()=>Ee(),t.appendChild(c);let s=document.createElement("button");s.className="btn-secondary",s.style.marginLeft="10px",s.textContent="Rejoindre un groupe",s.onclick=()=>ve(),t.appendChild(s),n.appendChild(t);let l=document.createElement("button");l.id="delete-account-btn-group-setup",l.className="delete-account-btn",l.textContent="Supprimer mon compte",l.onclick=ye,n.appendChild(l),e.appendChild(n)}function ke(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let r=!1;function a(){n.innerHTML="";let o=document.createElement("h2");o.textContent=r?"Inscription":"Connexion",n.appendChild(o);let t=document.createElement("form");t.onsubmit=async u=>{u.preventDefault(),r?await E():await b()};let c=document.createElement("label");c.textContent="Nom d\u2019utilisateur";let s=document.createElement("input");s.type="text",s.required=!0;let l=document.createElement("label");l.textContent="Mot de passe";let m=document.createElement("input");m.type="password",m.required=!0,t.appendChild(c),t.appendChild(s),t.appendChild(l),t.appendChild(m);let d;if(r){let u=document.createElement("label");u.textContent="Confirmer le mot de passe",d=document.createElement("input"),d.type="password",d.required=!0,t.appendChild(u),t.appendChild(d)}let i=document.createElement("div");i.style.color="var(--danger-color)",i.style.marginTop="12px",t.appendChild(i);let p=document.createElement("button");p.className="btn-primary",p.style.marginTop="20px",p.textContent=r?"S\u2019inscrire":"Se connecter",t.appendChild(p);let y=document.createElement("a");y.className="link",y.textContent=r?"D\xE9j\xE0 un compte ? Se connecter":"Cr\xE9er un compte",y.onclick=u=>{u.preventDefault(),r=!r,a()},n.appendChild(t),n.appendChild(y),e.appendChild(n);async function E(){let u=s.value.trim(),C=m.value,h=d?d.value:"";if(!u||!C){i.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}if(C!==h){i.textContent="Les mots de passe ne correspondent pas";return}try{await x("/register","POST",{username:u,password:C}),await J(),$="home",await W(),X()}catch(k){i.textContent=k.message}}async function b(){let u=s.value.trim(),C=m.value;if(!u||!C){i.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}try{await x("/login","POST",{username:u,password:C}),await J(),$="home",await W(),X()}catch(h){i.textContent=h.message}}}a()}async function Te(e){e.innerHTML="";let n=document.createElement("div");n.className="home-container",e.appendChild(n);let r=B?B.username:"",a=document.createElement("div");a.className="welcome-section";let o=document.createElement("p"),t=document.createElement("strong");t.className="text-xl",t.textContent="Salut",o.appendChild(t),o.appendChild(document.createTextNode(` ${r}, voici o\xF9 en est votre groupe aujourd'hui...`)),a.appendChild(o),n.appendChild(a);let c=document.createElement("div");c.className="upcoming-section";let s=document.createElement("h3");s.textContent="\xC0 venir",c.appendChild(s);let l="Aucune prestation pr\xE9vue";try{let E=await x("/performances"),b=new Date,u=E.filter(C=>new Date(C.date)>=b);if(u.sort((C,h)=>new Date(C.date)-new Date(h.date)),u.length>0){let C=u[0];l=`${C.name} (${ne(C.date)})`}}catch{l="Impossible de r\xE9cup\xE9rer les prestations"}let m=document.createElement("p"),d=document.createElement("strong");d.textContent="Prochaine prestation :",m.appendChild(d),m.appendChild(document.createTextNode(" "+l)),c.appendChild(m);let i="\u2014";try{let b=(await x("/agenda")).filter(h=>h.type==="rehearsal"),u=new Date,C=b.filter(h=>new Date(h.date)>=u);if(C.sort((h,k)=>new Date(h.date)-new Date(k.date)),C.length>0){let h=C[0];i=`${ne(h.date)}${h.location?" \u2013 "+h.location:""}`}}catch{}let p=document.createElement("p"),y=document.createElement("strong");y.textContent="Prochaine r\xE9p\xE9tition :",p.appendChild(y),p.appendChild(document.createTextNode(" "+i)),c.appendChild(p),n.appendChild(c)}async function Z(e){e.innerHTML="";let n=document.getElementById("profile-btn"),r=document.getElementById("profile-menu"),a=document.getElementById("menu-performances"),o=document.getElementById("menu-settings"),t=document.getElementById("menu-logout"),c=document.getElementById("theme-toggle");n&&r&&(n.onclick=p=>{p.stopPropagation(),te()}),c&&(c.textContent=document.body.classList.contains("dark")?"\u2600\uFE0F":"\u{1F319}",c.onclick=async()=>{document.body.classList.toggle("dark");let p=document.body.classList.contains("dark");c.textContent=p?"\u2600\uFE0F":"\u{1F319}";try{let E={...await x("/settings"),darkMode:p};await x("/settings","PUT",E),ee(E.darkMode)}catch(y){console.error(y)}}),a&&(a.onclick=()=>{$!=="performances"&&($="performances",Z(e)),r?.classList.contains("hidden")||te()}),o&&(o.onclick=()=>{$!=="settings"&&($="settings",Z(e)),r?.classList.contains("hidden")||te()}),t&&(t.onclick=async()=>{r?.classList.contains("hidden")||te(),await se()});let s=document.createElement("div");s.className="page",e.appendChild(s);let l=document.createElement("div");l.className="nav-bar";let m=[{key:"home",label:"Home",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>'},{key:"suggestions",label:"Suggestions",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"/></svg>'},{key:"rehearsals",label:"R\xE9p\xE8tes",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"/></svg>'},{key:"performances",label:"Prestations",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>'},{key:"agenda",label:"Agenda",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z"/></svg>'}],d=null,i=50;if(s.addEventListener("pointerdown",p=>{d=p.clientX}),s.addEventListener("pointerup",p=>{if(d===null)return;let y=p.clientX-d;if(Math.abs(y)>i){let E=m.findIndex(u=>u.key===$),b=y<0?E+1:E-1;b>=0&&b<m.length&&($=m[b].key,Z(e))}d=null}),m.forEach(p=>{let y=document.createElement("button");y.innerHTML=`${p.icon}<span>${p.label}</span>`,y.className=$===p.key?"active":"",y.onclick=()=>{$!==p.key&&($=p.key,Z(e))},l.appendChild(y)}),e.appendChild(l),$==="home")Te(s);else if($==="suggestions")z(s);else if($==="rehearsals"){try{await O()}catch{}Y(s)}else if($==="performances"){try{await O()}catch{}oe(s)}else if($==="agenda"){try{await O()}catch{}G(s)}else $==="settings"&&Q(s)}async function z(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux sugg\xE9r\xE9s",n.className="section-title",e.appendChild(n);let r=[];try{r=await x("/suggestions")}catch{let t=document.createElement("p");t.style.color="var(--danger-color)",t.textContent="Impossible de r\xE9cup\xE9rer les suggestions",e.appendChild(t);return}if(r.length===0){let o=document.createElement("p");o.className="empty-state",o.textContent="Aucune proposition pour l\u2019instant",e.appendChild(o)}r.forEach(o=>{let t=document.createElement("div");t.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-pink-50 text-gray-900";let c=document.createElement("div");c.className="card-header";let s=document.createElement("h3");s.textContent=o.title,s.onclick=()=>{t.classList.toggle("collapsed")},c.appendChild(s);let l=document.createElement("div");l.className="like-info";let m=document.createElement("span");m.textContent=`\u2764\uFE0F ${o.likes||0}`;let d=document.createElement("button");d.className="like-btn",d.textContent="\u{1F44D}",d.onclick=async b=>{b.stopPropagation(),d.disabled=!0,i.disabled=!0;try{let u=await x(`/suggestions/${o.id}/vote`,"POST");m.textContent=`\u2764\uFE0F ${u.likes}`,await z(e)}catch(u){alert(u.message),d.disabled=!1,i.disabled=!1}};let i=document.createElement("button");i.className="like-btn",i.textContent="\u{1F44E}",i.onclick=async b=>{b.stopPropagation(),d.disabled=!0,i.disabled=!0;try{let u=await x(`/suggestions/${o.id}/vote`,"DELETE");m.textContent=`\u2764\uFE0F ${u.likes}`,await z(e)}catch(u){alert(u.message),d.disabled=!1,i.disabled=!1}},l.appendChild(m),l.appendChild(d),l.appendChild(i),c.appendChild(l),t.appendChild(c);let p=document.createElement("div");if(p.className="card-details",o.author){let b=document.createElement("p");b.style.fontStyle="italic",b.textContent="Auteur : "+o.author,p.appendChild(b)}if(o.versionOf){let b=document.createElement("p");b.style.fontStyle="italic",b.textContent="Version de : "+o.versionOf,p.appendChild(b)}let y=o.youtube||o.url;if(y){let b=document.createElement("a");b.href=y,b.target="_blank",b.rel="noopener noreferrer",b.textContent=y,p.appendChild(b)}let E=document.createElement("p");if(E.style.fontSize="12px",E.style.color="var(--text-color)",E.textContent=`Ajout\xE9 par ${o.creator}`,p.appendChild(E),B&&(ae()||o.creatorId===B.id||o.creator===B.username)){let b=document.createElement("div");b.className="actions";let u=document.createElement("button");u.className="btn-secondary",u.textContent="Modifier",u.onclick=k=>{k.stopPropagation(),Se(o,e)},b.appendChild(u);let C=document.createElement("button");C.className="btn-primary",C.textContent="Passer en r\xE9p\xE9tition",C.onclick=async k=>{k.stopPropagation();try{let T=await x(`/suggestions/${o.id}/to-rehearsal`,"POST");I.push(T),z(e)}catch(T){alert(T.message)}},b.appendChild(C);let h=document.createElement("button");h.className="btn-danger",h.textContent="Supprimer",h.onclick=async k=>{if(k.stopPropagation(),!!confirm("Supprimer cette suggestion ?"))try{await x(`/suggestions/${o.id}`,"DELETE"),z(e)}catch(T){alert(T.message)}},b.appendChild(h),p.appendChild(b)}t.appendChild(p),e.appendChild(t)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau",a.textContent="+",a.onclick=()=>Le(e),e.appendChild(a)}function Le(e){let n=document.createElement("div");n.className="modal";let r=document.createElement("div");r.className="modal-content";let a=document.createElement("h3");a.textContent="Ajouter une suggestion",r.appendChild(a);let o=document.createElement("form");o.onsubmit=u=>{u.preventDefault()};let t=document.createElement("label");t.textContent="Titre";let c=document.createElement("input");c.type="text",c.required=!0,c.style.width="100%";let s=document.createElement("label");s.textContent="Auteur";let l=document.createElement("input");l.type="text",l.style.width="100%";let m=document.createElement("label");m.textContent="Version de";let d=document.createElement("input");d.type="text",d.style.width="100%";let i=document.createElement("label");i.textContent="Lien YouTube";let p=document.createElement("input");p.type="url",p.style.width="100%",o.appendChild(t),o.appendChild(c),o.appendChild(s),o.appendChild(l),o.appendChild(m),o.appendChild(d),o.appendChild(i),o.appendChild(p),r.appendChild(o);let y=document.createElement("div");y.className="modal-actions";let E=document.createElement("button");E.className="btn-secondary",E.textContent="Annuler",E.onclick=()=>{n.parentNode&&n.parentNode.removeChild(n)};let b=document.createElement("button");b.className="btn-primary",b.textContent="Ajouter",b.onclick=async u=>{u.preventDefault();let C=c.value.trim(),h=l.value.trim(),k=d.value.trim(),T=p.value.trim();if(C)try{await x("/suggestions","POST",{title:C,author:h,youtube:T,versionOf:k}),n.parentNode&&n.parentNode.removeChild(n),z(e)}catch(D){alert(D.message)}},y.appendChild(E),y.appendChild(b),r.appendChild(y),n.appendChild(r),document.body.appendChild(n),setTimeout(()=>c.focus(),50)}function Se(e,n){let r=document.createElement("div");r.className="modal";let a=document.createElement("div");a.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la suggestion",a.appendChild(o);let t=document.createElement("form");t.onsubmit=C=>C.preventDefault();let c=document.createElement("label");c.textContent="Titre";let s=document.createElement("input");s.type="text",s.required=!0,s.style.width="100%",s.value=e.title;let l=document.createElement("label");l.textContent="Auteur";let m=document.createElement("input");m.type="text",m.style.width="100%",m.value=e.author||"";let d=document.createElement("label");d.textContent="Version de";let i=document.createElement("input");i.type="text",i.style.width="100%",i.value=e.versionOf||"";let p=document.createElement("label");p.textContent="Lien YouTube";let y=document.createElement("input");y.type="url",y.style.width="100%",y.value=e.youtube||e.url||"",t.appendChild(c),t.appendChild(s),t.appendChild(l),t.appendChild(m),t.appendChild(d),t.appendChild(i),t.appendChild(p),t.appendChild(y),a.appendChild(t);let E=document.createElement("div");E.className="modal-actions";let b=document.createElement("button");b.className="btn-secondary",b.textContent="Annuler",b.onclick=()=>{r.parentNode&&r.parentNode.removeChild(r)};let u=document.createElement("button");u.className="btn-primary",u.textContent="Enregistrer",u.onclick=async C=>{C.preventDefault();let h=s.value.trim(),k=m.value.trim(),T=i.value.trim(),D=y.value.trim();if(h)try{await x(`/suggestions/${e.id}`,"PUT",{title:h,author:k,versionOf:T,youtube:D}),r.parentNode&&r.parentNode.removeChild(r),z(n)}catch(S){alert(S.message)}},E.appendChild(b),E.appendChild(u),a.appendChild(E),r.appendChild(a),document.body.appendChild(r),setTimeout(()=>s.focus(),50)}async function Y(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux en cours de travail",n.className="section-title",e.appendChild(n);let r=document.createElement("button");r.textContent="Exporter en PDF",r.className="btn-secondary",r.onclick=async()=>{try{let t=await fetch("/api/repertoire.pdf",{credentials:"include"});if(!t.ok)throw new Error("\xC9chec de l'export PDF");let c=await t.blob(),s=URL.createObjectURL(c),l=document.createElement("a");l.href=s,l.download="repertoire.pdf",document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(s)}catch(t){alert(t.message)}},e.appendChild(r);let a=I;if(a.length===0)try{await O(),a=I}catch{let c=document.createElement("p");c.style.color="var(--danger-color)",c.textContent="Impossible de r\xE9cup\xE9rer les r\xE9p\xE9titions",e.appendChild(c);return}if(a.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucun morceau en r\xE9p\xE9tition",e.appendChild(t)}a.forEach(t=>{let c=document.createElement("div");c.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-blue-50";let s=t.levels[B.username]!=null?t.levels[B.username]:0,l=document.createElement("div");l.className="card-header";let m=document.createElement("h3");m.textContent=t.title,m.onclick=()=>{c.classList.toggle("collapsed")},l.appendChild(m);let d=document.createElement("span");d.className="level-badge",d.textContent=s,l.appendChild(d),c.appendChild(l);let i=document.createElement("div");if(i.className="card-details",t.author){let v=document.createElement("p");v.style.fontStyle="italic",v.textContent="Auteur : "+t.author,i.appendChild(v)}if(t.youtube){let v=document.createElement("a");v.href=t.youtube,v.target="_blank",v.rel="noopener noreferrer",v.textContent=t.youtube,i.appendChild(v)}let p=document.createElement("div");p.style.marginTop="8px";let y=document.createElement("label");y.textContent=`Votre niveau (${s}/10)`,y.className="level-display";let E=document.createElement("input");E.type="range",E.min=0,E.max=10,E.step=1,E.value=s;function b(v){let L=v/10,f=Math.round(255*(1-L)),g=Math.round(255*L);E.style.background=`linear-gradient(to right, rgb(${f},${g},80) ${v/10*100}%, var(--border-color) ${v/10*100}%)`}b(s),E.oninput=async()=>{let v=Number(E.value);y.textContent=`Votre niveau (${v}/10)`,d.textContent=v,b(v);try{await x(`/rehearsals/${t.id}`,"PUT",{level:v})}catch(L){alert(L.message)}},p.appendChild(y),p.appendChild(E),i.appendChild(p);let u=document.createElement("label");u.textContent="Vos notes";let C=document.createElement("textarea");C.value=t.notes&&t.notes[B.username]||"",C.onchange=async()=>{try{await x(`/rehearsals/${t.id}`,"PUT",{note:C.value})}catch(v){alert(v.message)}},i.appendChild(u),i.appendChild(C);let h=document.createElement("div");h.style.marginTop="8px",(t.audioNotes&&t.audioNotes[B.username]||[]).forEach((v,L)=>{let f=document.createElement("div");if(v.title){let N=document.createElement("div");N.textContent=v.title,f.appendChild(N)}let g=document.createElement("audio");g.controls=!0,g.src=v.audio,f.appendChild(g);let w=document.createElement("button");w.className="btn-danger",w.textContent="Supprimer audio",w.style.marginLeft="8px",w.onclick=async N=>{if(N.preventDefault(),!!confirm("Supprimer la note audio\xA0?"))try{await x(`/rehearsals/${t.id}`,"PUT",{audioIndex:L}),Y(e)}catch(P){alert(P.message)}},f.appendChild(w),h.appendChild(f)});let T=document.createElement("input");T.type="text",T.placeholder="Titre de la note",T.style.display="block",T.style.marginTop="8px";let D=document.createElement("input");D.type="file",D.accept="audio/*",D.style.display="none";let S=document.createElement("button");if(S.className="btn-secondary",S.textContent="Ajouter une note audio",S.onclick=v=>{v.preventDefault(),D.click()},D.onchange=async()=>{let v=D.files[0];if(!v)return;if(v.size>5*1024*1024){alert("Le fichier audio est trop volumineux (max 5\xA0Mo).");return}let L=new FileReader;L.onload=async f=>{let g=(f.target?.result||"").toString();try{await x(`/rehearsals/${t.id}`,"PUT",{audio:g,audioTitle:T.value}),Y(e)}catch(w){alert(w.message)}},L.readAsDataURL(v)},h.appendChild(T),h.appendChild(S),h.appendChild(D),i.appendChild(h),B){let v=document.createElement("div");v.style.marginTop="8px";let L=document.createElement("label");L.textContent="Partition(s)",v.appendChild(L);let f=document.createElement("div");(t.partitions||[]).forEach(N=>{let P=document.createElement("div"),j=document.createElement("span");j.textContent=`${N.displayName} \u2013 ${N.uploader} \u2013 ${ne(N.date)}`,P.appendChild(j);let M=document.createElement("a");if(M.href=N.downloadUrl,M.textContent="T\xE9l\xE9charger",M.target="_blank",M.rel="noopener noreferrer",M.className="btn-secondary",M.style.marginLeft="8px",P.appendChild(M),N.uploader===B.username||pe()){let V=document.createElement("button");V.className="btn-danger",V.textContent="Supprimer",V.style.marginLeft="8px",V.onclick=async R=>{if(R.preventDefault(),!!confirm("Supprimer cette partition\xA0?"))try{await ue(t.id,N.id),await O(),Y(e)}catch(_){alert(_.message)}},P.appendChild(V)}f.appendChild(P)}),v.appendChild(f);let g=document.createElement("input");g.type="file",g.accept="application/pdf",g.style.display="none";let w=document.createElement("button");w.className="btn-secondary",w.textContent="D\xE9poser une partition",w.onclick=N=>{N.preventDefault(),g.click()},g.onchange=async()=>{let N=g.files[0];if(N)try{await me(t.id,N,N.name),await O(),Y(e)}catch(P){alert(P.message)}},v.appendChild(w),v.appendChild(g),i.appendChild(v)}let A=Object.keys(t.levels||{}).filter(v=>v.toLowerCase()!==B.username.toLowerCase());if(A.length>0){let v=document.createElement("div");v.style.marginTop="12px";let L=document.createElement("p");L.textContent="Autres membres :",L.style.fontStyle="italic",v.appendChild(L),A.forEach(f=>{let g=document.createElement("div");g.style.marginBottom="4px";let w=t.levels[f],N=t.notes&&t.notes[f]?t.notes[f]:"",P=document.createElement("p");P.style.margin="0";let j=document.createElement("strong");j.textContent=f,P.appendChild(j),P.appendChild(document.createTextNode(` \u2013 Niveau ${w}/10${N?" \u2013 "+N:""}`)),g.appendChild(P),(t.audioNotes&&t.audioNotes[f]||[]).forEach(V=>{let R=document.createElement("audio");if(R.controls=!0,R.src=V.audio,R.style.display="block",R.style.marginTop="4px",V.title){let _=document.createElement("div");_.textContent=V.title,_.style.marginTop="4px",g.appendChild(_)}g.appendChild(R)}),v.appendChild(g)}),i.appendChild(v)}if(B&&(ae()||B.id===t.creatorId)){let v=document.createElement("div");v.className="actions";let L=document.createElement("button");L.className="btn-secondary",L.textContent="Modifier",L.onclick=w=>{w.stopPropagation(),Pe(t,e)},v.appendChild(L);let f=document.createElement("button");f.className="btn-primary",f.textContent="Remettre dans J\u2019aime",f.onclick=async w=>{w.stopPropagation();try{await x(`/rehearsals/${t.id}/to-suggestion`,"POST"),Y(e)}catch(N){alert(N.message)}},v.appendChild(f);let g=document.createElement("button");g.className="btn-danger",g.textContent="Supprimer",g.onclick=async w=>{if(w.stopPropagation(),!!confirm("Supprimer ce morceau ?"))try{await x(`/rehearsals/${t.id}`,"DELETE"),I=I.filter(N=>N.id!==t.id),Y(e)}catch(N){alert(N.message)}},v.appendChild(g),i.appendChild(v)}c.appendChild(i),e.appendChild(c)});let o=document.createElement("div");o.className="fab",o.title="Ajouter un morceau en r\xE9p\xE9tition",o.textContent="+",o.onclick=()=>De(e),e.appendChild(o)}function De(e,n){let r=document.createElement("div");r.className="modal";let a=document.createElement("div");a.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter un morceau",a.appendChild(o);let t=document.createElement("form");t.onsubmit=k=>k.preventDefault();let c=document.createElement("label");c.textContent="Titre";let s=document.createElement("input");s.type="text",s.required=!0,s.style.width="100%";let l=document.createElement("label");l.textContent="Auteur";let m=document.createElement("input");m.type="text",m.style.width="100%";let d=document.createElement("label");d.textContent="Lien YouTube";let i=document.createElement("input");i.type="url",i.style.width="100%";let p=document.createElement("label");p.textContent="Lien Spotify";let y=document.createElement("input");y.type="url",y.style.width="100%";let E=document.createElement("label");E.textContent="Version de";let b=document.createElement("input");b.type="text",b.style.width="100%",t.appendChild(c),t.appendChild(s),t.appendChild(l),t.appendChild(m),t.appendChild(d),t.appendChild(i),t.appendChild(p),t.appendChild(y),t.appendChild(E),t.appendChild(b),a.appendChild(t);let u=document.createElement("div");u.className="modal-actions";let C=document.createElement("button");C.className="btn-secondary",C.textContent="Annuler",C.onclick=()=>{r.parentNode&&r.parentNode.removeChild(r)};let h=document.createElement("button");h.className="btn-primary",h.textContent="Ajouter",h.onclick=async k=>{k.preventDefault();let T=s.value.trim();if(!T)return;let D=m.value.trim(),S=i.value.trim(),A=y.value.trim(),v=b.value.trim();try{let L=await x("/rehearsals","POST",{title:T,author:D,youtube:S,spotify:A,versionOf:v});r.parentNode&&r.parentNode.removeChild(r),I.push(L),typeof n=="function"?n():Y(e)}catch(L){alert(L.message)}},u.appendChild(C),u.appendChild(h),a.appendChild(u),r.appendChild(a),document.body.appendChild(r),setTimeout(()=>s.focus(),50)}function Pe(e,n,r){let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let t=document.createElement("h3");t.textContent="Modifier le morceau",o.appendChild(t);let c=document.createElement("form");c.onsubmit=T=>T.preventDefault();let s=document.createElement("label");s.textContent="Titre";let l=document.createElement("input");l.type="text",l.required=!0,l.style.width="100%",l.value=e.title;let m=document.createElement("label");m.textContent="Auteur";let d=document.createElement("input");d.type="text",d.style.width="100%",d.value=e.author||"";let i=document.createElement("label");i.textContent="Lien YouTube";let p=document.createElement("input");p.type="url",p.style.width="100%",p.value=e.youtube||"";let y=document.createElement("label");y.textContent="Lien Spotify";let E=document.createElement("input");E.type="url",E.style.width="100%",E.value=e.spotify||"";let b=document.createElement("label");b.textContent="Version de";let u=document.createElement("input");u.type="text",u.style.width="100%",u.value=e.versionOf||"",c.appendChild(s),c.appendChild(l),c.appendChild(m),c.appendChild(d),c.appendChild(i),c.appendChild(p),c.appendChild(y),c.appendChild(E),c.appendChild(b),c.appendChild(u),o.appendChild(c);let C=document.createElement("div");C.className="modal-actions";let h=document.createElement("button");h.className="btn-secondary",h.textContent="Annuler",h.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let k=document.createElement("button");k.className="btn-primary",k.textContent="Enregistrer",k.onclick=async T=>{T.preventDefault();let D=l.value.trim(),S=d.value.trim(),A=p.value.trim(),v=E.value.trim(),L=u.value.trim();if(D)try{await x(`/rehearsals/${e.id}`,"PUT",{title:D,author:S,youtube:A,spotify:v,versionOf:L}),a.parentNode&&a.parentNode.removeChild(a);let f=I.findIndex(g=>g.id===e.id);f!==-1&&(I[f]={...I[f],title:D,author:S||null,youtube:A||null,spotify:v||null,versionOf:L||null}),typeof r=="function"?r():Y(n)}catch(f){alert(f.message)}},C.appendChild(h),C.appendChild(k),o.appendChild(C),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>l.focus(),50)}async function oe(e){e.innerHTML="";let n=document.createElement("h2");n.className="section-title",n.textContent="Prestations",e.appendChild(n);let r=[];try{r=await x("/performances")}catch{let m=document.createElement("p");m.style.color="var(--danger-color)",m.textContent="Impossible de r\xE9cup\xE9rer les prestations",e.appendChild(m);return}if(I.length===0)try{await O()}catch{}let a=new Date,o=r.filter(l=>new Date(l.date)>=a),t=r.filter(l=>new Date(l.date)<a);function c(l,m){let d=document.createElement("div");if(d.className="section-title",d.textContent=l,e.appendChild(d),m.length===0){let i=document.createElement("p");i.textContent="Aucune prestation",e.appendChild(i);return}m.forEach(i=>{let p=document.createElement("div");p.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-green-50";let y=document.createElement("h3");y.textContent=i.name,y.onclick=()=>{p.classList.toggle("collapsed")},p.appendChild(y);let E=document.createElement("div");E.className="card-details";let b=document.createElement("p");if(b.textContent="Date : "+ne(i.date),E.appendChild(b),i.location){let u=document.createElement("p");u.textContent="Lieu : "+i.location,E.appendChild(u)}if(i.songs&&i.songs.length>0){let u=document.createElement("ul");i.songs.forEach(C=>{let h=I.find(T=>T.id===C),k=document.createElement("li");k.textContent=h?h.title:"\u2014",u.appendChild(k)}),E.appendChild(u)}if(B&&(ae()||B.id===i.creatorId)){let u=document.createElement("div");u.className="actions";let C=document.createElement("button");C.className="btn-secondary",C.textContent="Modifier",C.onclick=k=>{k.stopPropagation(),be(i,e)},u.appendChild(C);let h=document.createElement("button");h.className="btn-danger",h.textContent="Supprimer",h.onclick=async k=>{if(k.stopPropagation(),!!confirm("Supprimer cette prestation ?"))try{await x(`/performances/${i.id}`,"DELETE"),oe(e)}catch(T){alert(T.message)}},u.appendChild(h),E.appendChild(u)}p.appendChild(E),e.appendChild(p)})}c("\xC0 venir",o),c("Pass\xE9es",t);let s=document.createElement("div");s.className="fab",s.title="Ajouter une prestation",s.textContent="+",s.onclick=()=>ie(e),e.appendChild(s)}async function G(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Agenda",n.className="section-title",e.appendChild(n);let r=document.createElement("div");r.className="calendar-nav";let a=document.createElement("button");a.textContent="<",a.onclick=()=>{H.setMonth(H.getMonth()-1),G(e)};let o=document.createElement("button");o.textContent=">",o.onclick=()=>{H.setMonth(H.getMonth()+1),G(e)};let t=document.createElement("span");t.textContent=H.toLocaleDateString(void 0,{month:"long",year:"numeric"}),r.appendChild(a),r.appendChild(t),r.appendChild(o),e.appendChild(r);let c=document.createElement("div");c.className="actions";let s=document.createElement("button");s.className="btn-secondary",s.textContent="Nouvelle r\xE9p\xE9tition",s.onclick=()=>fe(e,()=>G(e));let l=document.createElement("button");l.className="btn-secondary",l.textContent="Nouvelle prestation",l.onclick=()=>ie(e,()=>G(e)),c.appendChild(s),c.appendChild(l),e.appendChild(c);let m=[];try{let C=H.getFullYear(),h=H.getMonth()+1,k=String(h).padStart(2,"0"),T=`${C}-${k}-01`,D=`${C}-${k}-31`;m=await x(`/agenda?start=${T}&end=${D}`)}catch{let h=document.createElement("p");h.style.color="var(--danger-color)",h.textContent="Impossible de r\xE9cup\xE9rer l'agenda",e.appendChild(h);return}m.sort((C,h)=>C.date.localeCompare(h.date));let d=document.createElement("div");d.className="calendar-grid",["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(C=>{let h=document.createElement("div");h.className="calendar-day-name",h.textContent=C,d.appendChild(h)});let p=H.getFullYear(),y=H.getMonth(),b=(new Date(p,y,1).getDay()+6)%7;for(let C=0;C<b;C++){let h=document.createElement("div");h.className="calendar-cell empty",d.appendChild(h)}let u=new Date(p,y+1,0).getDate();for(let C=1;C<=u;C++){let h=document.createElement("div");h.className="calendar-cell";let k=document.createElement("div");k.className="calendar-date",k.textContent=C,h.appendChild(k);let T=`${p}-${String(y+1).padStart(2,"0")}-${String(C).padStart(2,"0")}`,D=m.filter(S=>S.date?.startsWith(T));D.forEach(S=>{let A=document.createElement("div");A.className=`calendar-event ${S.type==="performance"?"performance":"rehearsal"}`;let v=S.title||S.location||"",L=S.type==="performance"?"Prestation":"R\xE9p\xE9tition";A.textContent=v||L,A.onclick=async f=>{if(f.preventDefault(),f.stopPropagation(),S.type==="performance")try{I.length===0&&await O();let w=(await x("/performances")).find(N=>N.id===S.id);w&&be(w,e,()=>G(e))}catch(g){alert(g.message)}else Be(S,e,()=>G(e))},h.appendChild(A)}),D.length===0&&(h.onclick=async()=>{if(!ae())return;if(confirm("Ajouter une prestation ? (Annuler pour une r\xE9p\xE9tition)")){try{I.length===0&&await O()}catch{}ie(e,()=>G(e),T)}else fe(e,()=>G(e),`${T}T20:00`)}),d.appendChild(h)}e.appendChild(d)}function fe(e,n,r){let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let t=document.createElement("h3");t.textContent="Ajouter une r\xE9p\xE9tition",o.appendChild(t);let c=document.createElement("form");c.onsubmit=E=>E.preventDefault();let s=document.createElement("label");s.textContent="Date et heure";let l=document.createElement("input");l.type="datetime-local",l.required=!0,l.style.width="100%",r&&(l.value=r);let m=document.createElement("label");m.textContent="Lieu";let d=document.createElement("input");d.type="text",d.style.width="100%",c.appendChild(s),c.appendChild(l),c.appendChild(m),c.appendChild(d),o.appendChild(c);let i=document.createElement("div");i.className="modal-actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Annuler",p.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let y=document.createElement("button");y.className="btn-primary",y.textContent="Ajouter",y.onclick=async E=>{E.preventDefault();let b=l.value;if(!b)return;let u=d.value.trim();try{await x("/agenda","POST",{type:"rehearsal",date:b,location:u}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"&&n()}catch(C){alert(C.message)}},i.appendChild(p),i.appendChild(y),o.appendChild(i),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>l.focus(),50)}async function ie(e,n,r){try{await O()}catch(T){alert(T.message);return}let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let t=document.createElement("h3");t.textContent="Ajouter une prestation",o.appendChild(t);let c=document.createElement("form");c.onsubmit=T=>T.preventDefault();let s=document.createElement("label");s.textContent="Nom";let l=document.createElement("input");l.type="text",l.required=!0,l.style.width="100%";let m=document.createElement("label");m.textContent="Date";let d=document.createElement("input");d.type="date",d.required=!0,d.style.width="100%",r&&(d.value=r);let i=document.createElement("label");i.textContent="Heure";let p=document.createElement("input");p.type="time",p.required=!0,p.style.width="100%";let y=document.createElement("label");y.textContent="Lieu";let E=document.createElement("input");E.type="text",E.style.width="100%";let b=document.createElement("label");b.textContent="Morceaux jou\xE9s";let u=document.createElement("div");u.className="select-list",I.forEach(T=>{let D=document.createElement("label");D.style.display="flex",D.style.justifyContent="space-between",D.style.alignItems="center";let S=document.createElement("input");S.type="checkbox",S.value=T.id;let A=document.createElement("span");A.textContent=T.title,A.style.marginLeft="4px";let v=document.createElement("span");v.appendChild(S),v.appendChild(A);let L=document.createElement("span");L.className="level-badge";let f=Object.values(T.levels||{}).map(Number),g=f.length>0?f.reduce((w,N)=>w+N,0)/f.length:0;L.textContent=g.toFixed(1),D.appendChild(v),D.appendChild(L),u.appendChild(D)}),c.appendChild(s),c.appendChild(l),c.appendChild(m),c.appendChild(d),c.appendChild(i),c.appendChild(p),c.appendChild(y),c.appendChild(E),c.appendChild(b),c.appendChild(u),o.appendChild(c);let C=document.createElement("div");C.className="modal-actions";let h=document.createElement("button");h.className="btn-secondary",h.textContent="Annuler",h.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let k=document.createElement("button");k.className="btn-primary",k.textContent="Ajouter",k.onclick=async T=>{T.preventDefault();let D=l.value.trim(),S=d.value,A=p.value,v=E.value.trim();if(!D||!S||!A)return;let L=`${S}T${A}`,f=[];u.querySelectorAll('input[type="checkbox"]').forEach(w=>{w.checked&&f.push(Number(w.value))});let g=!1;for(let w of f){let N=I.find(P=>P.id===w);if(N){let P=Object.values(N.levels||{}).map(Number);if((P.length?Math.min(...P):0)<=6){g=!0;break}}}if(!(g&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Ajouter quand m\xEAme ?")))try{await x("/performances","POST",{name:D,date:L,location:v,songs:f}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"?n():oe(e)}catch(w){alert(w.message)}},C.appendChild(h),C.appendChild(k),o.appendChild(C),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>l.focus(),50)}function Be(e,n,r){let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let t=document.createElement("h3");t.textContent="Modifier la r\xE9p\xE9tition",o.appendChild(t);let c=document.createElement("form");c.onsubmit=E=>E.preventDefault();let s=document.createElement("label");s.textContent="Date et heure";let l=document.createElement("input");l.type="datetime-local",l.required=!0,l.style.width="100%",l.value=e.date||"";let m=document.createElement("label");m.textContent="Lieu";let d=document.createElement("input");d.type="text",d.style.width="100%",d.value=e.location||"",c.appendChild(s),c.appendChild(l),c.appendChild(m),c.appendChild(d),o.appendChild(c);let i=document.createElement("div");i.className="modal-actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Annuler",p.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let y=document.createElement("button");y.className="btn-primary",y.textContent="Enregistrer",y.onclick=async E=>{E.preventDefault();let b=l.value;if(!b)return;let u=d.value.trim();try{await x(`/agenda/${e.id}`,"PUT",{type:"rehearsal",date:b,location:u}),a.parentNode&&a.parentNode.removeChild(a),typeof r=="function"&&r()}catch(C){alert(C.message)}},i.appendChild(p),i.appendChild(y),o.appendChild(i),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>l.focus(),50)}async function be(e,n,r){try{await O()}catch(S){alert(S.message);return}let a=document.createElement("div");a.className="modal";let o=document.createElement("div");o.className="modal-content";let t=document.createElement("h3");t.textContent="Modifier la prestation",o.appendChild(t);let c=document.createElement("form");c.onsubmit=S=>S.preventDefault();let s=document.createElement("label");s.textContent="Nom";let l=document.createElement("input");l.type="text",l.required=!0,l.style.width="100%",l.value=e.name;let m=document.createElement("label");m.textContent="Date";let d=document.createElement("input");d.type="date",d.required=!0,d.style.width="100%";let[i,p]=(e.date||"").split("T");d.value=i;let y=document.createElement("label");y.textContent="Heure";let E=document.createElement("input");E.type="time",E.required=!0,E.style.width="100%",E.value=(p||"").slice(0,5);let b=document.createElement("label");b.textContent="Lieu";let u=document.createElement("input");u.type="text",u.style.width="100%",u.value=e.location||"";let C=document.createElement("label");C.textContent="Morceaux jou\xE9s";let h=document.createElement("div");h.className="select-list",I.forEach(S=>{let A=document.createElement("label");A.style.display="flex",A.style.justifyContent="space-between",A.style.alignItems="center";let v=document.createElement("input");v.type="checkbox",v.value=S.id,e.songs.includes(S.id)&&(v.checked=!0);let L=document.createElement("span");L.textContent=S.title,L.style.marginLeft="4px";let f=document.createElement("span");f.appendChild(v),f.appendChild(L);let g=document.createElement("span");g.className="level-badge";let w=Object.values(S.levels||{}).map(Number),N=w.length>0?w.reduce((P,j)=>P+j,0)/w.length:0;g.textContent=N.toFixed(1),A.appendChild(f),A.appendChild(g),h.appendChild(A)}),c.appendChild(s),c.appendChild(l),c.appendChild(m),c.appendChild(d),c.appendChild(y),c.appendChild(E),c.appendChild(b),c.appendChild(u),c.appendChild(C),c.appendChild(h),o.appendChild(c);let k=document.createElement("div");k.className="modal-actions";let T=document.createElement("button");T.className="btn-secondary",T.textContent="Annuler",T.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let D=document.createElement("button");D.className="btn-primary",D.textContent="Enregistrer",D.onclick=async S=>{S.preventDefault();let A=l.value.trim(),v=d.value,L=E.value,f=u.value.trim();if(!A||!v||!L)return;let g=`${v}T${L}`,w=[];h.querySelectorAll('input[type="checkbox"]').forEach(P=>{P.checked&&w.push(Number(P.value))});let N=!1;for(let P of w){let j=I.find(M=>M.id===P);if(j){let M=Object.values(j.levels||{}).map(Number);if((M.length?Math.min(...M):0)<=6){N=!0;break}}}if(!(N&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Enregistrer quand m\xEAme ?")))try{await x(`/performances/${e.id}`,"PUT",{name:A,date:g,location:f,songs:w}),a.parentNode&&a.parentNode.removeChild(a),typeof r=="function"?r():oe(n)}catch(P){alert(P.message)}},k.appendChild(T),k.appendChild(D),o.appendChild(k),a.appendChild(o),document.body.appendChild(a),setTimeout(()=>l.focus(),50)}function Ae(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");r.textContent="Groupes",n.appendChild(r);let a=document.createElement("select");a.id="group-select",n.appendChild(a);let o=document.createElement("div");o.style.marginTop="10px";let t=document.createElement("button");t.id="create-group-btn",t.className="btn-secondary",t.textContent="Cr\xE9er",o.appendChild(t);let c=document.createElement("button");c.id="join-group-btn",c.className="btn-secondary",c.textContent="Rejoindre",c.style.marginLeft="8px",o.appendChild(c);let s=document.createElement("button");if(s.id="rename-group-btn",s.className="btn-secondary",s.textContent="Renommer",s.style.marginLeft="8px",s.onclick=async()=>{let l=prompt("Nouveau nom du groupe",e.groupName);if(!l||l.trim()===""||l===e.groupName)return;let m=l.trim(),d=e.id||B.groupId;try{await x(`/groups/${d}`,"PUT",{name:m}),e.groupName=m,document.title=`${e.groupName} \u2013 BandTrack`;let i=document.getElementById("group-name");i&&(i.textContent=e.groupName),await W(d),await Q(document.getElementById("app"))}catch(i){alert(i.message)}},o.appendChild(s),n.appendChild(o),pe()){let l=document.createElement("div");l.style.marginTop="8px";let m=e.invitationCode,d=document.createElement("span");d.textContent=`Code d'invitation : ${m}`,l.appendChild(d);let i=document.createElement("button");i.textContent="Copier",i.style.marginLeft="8px",i.onclick=()=>navigator.clipboard.writeText(m),l.appendChild(i);let p=document.createElement("button");p.textContent="Renouveler",p.style.marginLeft="8px",p.onclick=async()=>{try{m=(await x("/groups/renew-code","POST")).invitationCode,d.textContent=`Code d'invitation : ${m}`}catch(y){alert(y.message)}},l.appendChild(p),n.appendChild(l)}return n}function Me(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");n.textContent="Mot de passe",e.appendChild(n);let r=document.createElement("form");r.onsubmit=m=>m.preventDefault();let a=document.createElement("label");a.textContent="Mot de passe actuel";let o=document.createElement("input");o.type="password",o.required=!0,o.style.width="100%";let t=document.createElement("label");t.textContent="Nouveau mot de passe";let c=document.createElement("input");c.type="password",c.required=!0,c.style.width="100%";let s=document.createElement("button");s.className="btn-primary",s.type="submit",s.textContent="Modifier",s.style.marginTop="8px";let l=document.createElement("p");return l.style.marginTop="8px",r.appendChild(a),r.appendChild(o),r.appendChild(t),r.appendChild(c),r.appendChild(s),r.appendChild(l),r.onsubmit=async m=>{m.preventDefault(),l.textContent="";try{await x("/password","PUT",{oldPassword:o.value,newPassword:c.value}),l.style.color="green",l.textContent="Mot de passe mis \xE0 jour",o.value="",c.value=""}catch(d){l.style.color="var(--danger-color)",l.textContent=d.message}},e.appendChild(r),e}function $e(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");r.textContent="Th\xE8me",n.appendChild(r);let a=document.createElement("div"),o=document.createElement("label");o.textContent="Mode sombre",o.style.marginRight="8px";let t=document.createElement("input");t.type="checkbox",t.checked=e.darkMode,t.onchange=async()=>{e.darkMode=t.checked;try{await x("/settings","PUT",e),ee(t.checked)}catch(d){alert(d.message)}},a.appendChild(o),a.appendChild(t),n.appendChild(a);let c=document.createElement("div");c.style.marginTop="20px";let s=document.createElement("label");s.textContent="Template (design)",s.style.marginRight="8px";let l=document.createElement("select");return[{value:"classic",label:"Classique"},{value:"groove",label:"Groove"},{value:"violet",label:"Violet"},{value:"imgbg",label:"Image"}].forEach(d=>{let i=document.createElement("option");i.value=d.value,i.textContent=d.label,l.appendChild(i)}),l.value=e.template||"classic",l.onchange=async()=>{let d=l.value;e.template=d;try{await x("/settings","PUT",e),de(d)}catch(i){alert(i.message)}},c.appendChild(s),c.appendChild(l),n.appendChild(c),n}async function Ie(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");if(n.textContent="Membres",e.appendChild(n),q==null||B?.needsGroup){let r=document.createElement("p");return r.textContent="Aucun groupe actif",e.appendChild(r),e}try{let r=await x(`/groups/${q}/members`),a=document.createElement("table");a.className="user-table";let o=document.createElement("thead");o.innerHTML="<tr><th>Membre</th><th>R\xF4le</th></tr>",a.appendChild(o);let t=document.createElement("tbody");r.forEach(c=>{let s=document.createElement("tr"),l=document.createElement("td");l.textContent=c.username;let m=document.createElement("td");m.textContent=c.role,s.appendChild(l),s.appendChild(m),t.appendChild(s)}),a.appendChild(t),e.appendChild(a)}catch{let a=document.createElement("p");a.style.color="var(--danger-color)",a.textContent="Impossible de r\xE9cup\xE9rer les membres du groupe",e.appendChild(a)}return e}async function je(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");if(r.textContent="Administration",n.appendChild(r),q==null||B?.needsGroup){let a=document.createElement("p");return a.textContent="Aucun groupe actif",n.appendChild(a),n}try{let a=await x("/context");if(!a){let f=document.createElement("p");return f.textContent="Aucun groupe actif",n.appendChild(f),n}let[o,t]=await Promise.all([x(`/groups/${q}/members`),x("/users")]),c=document.createElement("h4");c.textContent="Tableau de bord du groupe",c.style.marginTop="10px",n.appendChild(c);let s=document.createElement("div"),l=a.invitation_code,m=document.createElement("span");m.textContent=`Code d'invitation : ${l}`,s.appendChild(m);let d=document.createElement("button");d.textContent="Copier",d.style.marginLeft="8px",d.onclick=()=>navigator.clipboard.writeText(l),s.appendChild(d);let i=document.createElement("button");i.textContent="Renouveler",i.style.marginLeft="8px",i.onclick=async()=>{try{l=(await x("/groups/renew-code","POST")).invitationCode,m.textContent=`Code d'invitation : ${l}`}catch(f){alert(f.message)}},s.appendChild(i),n.appendChild(s);let p=document.createElement("table");p.className="user-table";let y=document.createElement("thead");y.innerHTML="<tr><th>Membre</th><th>R\xF4le</th><th>Actions</th></tr>",p.appendChild(y);let E=document.createElement("tbody");o.forEach(f=>{let g=document.createElement("tr"),w=document.createElement("td");w.textContent=f.username;let N=document.createElement("td"),P=document.createElement("select");["user","moderator","admin"].forEach(V=>{let R=document.createElement("option");R.value=V,R.textContent=V,f.role===V&&(R.selected=!0),P.appendChild(R)}),f.userId===B.id&&(P.disabled=!0),P.onchange=async()=>{try{await x(`/groups/${q}/members`,"PUT",{id:f.id,role:P.value})}catch(V){alert(V.message)}},N.appendChild(P);let j=document.createElement("td"),M=document.createElement("button");M.textContent=f.userId===B.id?"Quitter":"Retirer",M.onclick=async()=>{let V=f.userId===B.id?"Quitter le groupe ?":"Supprimer ce membre ?";if(confirm(V))try{await x(`/groups/${q}/members`,"DELETE",{userId:f.userId}),f.userId===B.id?(alert("Quitter le groupe"),B.needsGroup=!0,X()):(g.remove(),alert("Membre supprim\xE9"))}catch(R){alert(R.message)}},j.appendChild(M),g.appendChild(w),g.appendChild(N),g.appendChild(j),E.appendChild(g)}),p.appendChild(E),n.appendChild(p);let b=new Set(o.map(f=>f.userId)),u=t.filter(f=>!b.has(f.id));if(u.length>0){let f=document.createElement("div"),g=document.createElement("select");u.forEach(N=>{let P=document.createElement("option");P.value=N.id,P.textContent=N.username,g.appendChild(P)}),f.appendChild(g);let w=document.createElement("button");w.textContent="Ajouter",w.style.marginLeft="8px",w.onclick=async()=>{try{let N=Number(g.value);await x(`/groups/${q}/members`,"POST",{userId:N,role:"user"}),Q(e)}catch(N){alert(N.message)}},f.appendChild(w),n.appendChild(f)}let C=document.createElement("div"),h=document.createElement("input");h.type="email",h.placeholder="adresse e-mail",C.appendChild(h);let k=document.createElement("button");k.textContent="Inviter",k.style.marginLeft="8px",k.onclick=async()=>{let f=h.value.trim();if(f)try{let g=await x(`/groups/${q}/invite`,"POST",{email:f});g.temporaryPassword&&alert(`Mot de passe temporaire : ${g.temporaryPassword}`),Q(e)}catch(g){alert(g.message)}},C.appendChild(k),n.appendChild(C);let T=document.createElement("h4");T.textContent="Gestion des utilisateurs",T.style.marginTop="30px",n.appendChild(T);let D=document.createElement("table");D.className="user-table";let S=document.createElement("thead");S.innerHTML="<tr><th>Utilisateur</th><th>R\xF4le</th></tr>",D.appendChild(S);let A=document.createElement("tbody"),v={};t.forEach(f=>{v[f.id]=f.role;let g=document.createElement("tr"),w=document.createElement("td");w.textContent=f.username;let N=document.createElement("td"),P=document.createElement("select");["user","moderator","admin"].forEach(j=>{let M=document.createElement("option");M.value=j,M.textContent=j,f.role===j&&(M.selected=!0),P.appendChild(M)}),f.id===B.id&&(P.disabled=!0),P.dataset.userId=f.id,N.appendChild(P),g.appendChild(w),g.appendChild(N),A.appendChild(g)}),D.appendChild(A),n.appendChild(D);let L=document.createElement("button");L.className="btn-primary",L.style.marginTop="10px",L.textContent="Enregistrer les r\xF4les",L.onclick=async()=>{try{let f=[];A.querySelectorAll("select").forEach(g=>{let w=Number(g.dataset.userId),N=g.value;v[w]!==N&&f.push({id:w,role:N})});for(let g of f)await x(`/users/${g.id}`,"PUT",{role:g.role});alert("R\xF4les mis \xE0 jour"),Q(e)}catch(f){alert(f.message)}},n.appendChild(L)}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les membres",n.appendChild(o)}return n}async function Q(e){e.innerHTML="";let n=document.createElement("h2");if(n.className="section-title",n.textContent="Param\xE8tres",e.appendChild(n),B){let d=document.createElement("p");d.className="user-info",d.textContent=`Utilisateur connect\xE9: ${B.username}`,e.appendChild(d)}let r=document.createElement("div");r.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let a=document.createElement("button");a.className="logout-btn",a.textContent="Se d\xE9connecter",a.onclick=se,r.appendChild(a);let o=document.createElement("button");o.id="delete-account-btn",o.className="delete-account-btn",o.textContent="Supprimer mon compte",o.onclick=ye,r.appendChild(o);let t;try{t=await x("/settings")}catch{let i=document.createElement("p");i.style.color="var(--danger-color)",i.textContent="Impossible de r\xE9cup\xE9rer les param\xE8tres",e.appendChild(i),e.appendChild(r);return}let c={...t},s=Ae(c);e.appendChild(s);try{await W();let d=await Ie();e.appendChild(d)}catch(d){console.error("Failed to load groups or members",d)}let l=$e(c);e.appendChild(l);let m=Me();if(e.appendChild(m),e.appendChild(r),pe()){let d=await je(e);e.appendChild(d)}}window.addEventListener("DOMContentLoaded",we)});Ve();})();
