(()=>{var oe=(e,n)=>()=>(e&&(n=e(e=0)),n);var be=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports);function ce(){R.rehearsalsCache=[]}var R,K=oe(()=>{R={currentUser:null,currentPage:"home",rehearsalsCache:[],groupsCache:[],activeGroupId:null,agendaDate:new Date}});async function w(e,n="GET",r){let a={method:n,credentials:"same-origin"};r!==void 0&&(a.headers={"Content-Type":"application/json"},a.body=JSON.stringify(r));let t=await fetch("/api"+e,a),o;try{o=await t.json()}catch{o=null}if(t.status===401)throw R.currentUser=null,new Error(o?.error||"Non authentifi\xE9");if(t.status===403&&o&&o.error==="No membership")throw R.currentUser&&(R.currentUser.needsGroup=!0),new Error("No membership");if(t.status===404&&e==="/context"&&n==="GET")return null;if(!t.ok)throw new Error(o&&o.error||"Erreur API");return o}function ge(e){return w(`/rehearsals/${e}/partitions`)}async function pe(e,n,r){let a=new FormData;a.append("file",n),r&&a.append("displayName",r);let t=await fetch(`/api/rehearsals/${e}/partitions`,{method:"POST",body:a,credentials:"same-origin"}),o;try{o=await t.json()}catch{o=null}if(t.status===401)throw R.currentUser=null,new Error(o?.error||"Non authentifi\xE9");if(!t.ok)throw new Error(o&&o.error||"Erreur API");return o}function me(e,n){return w(`/rehearsals/${e}/partitions/${n}`,"DELETE")}async function U(){let e=await w("/rehearsals"),n=await Promise.allSettled(e.map(a=>ge(a.id))),r=[];n.forEach((a,t)=>{let o=e[t];a.status==="fulfilled"?r.push({...o,partitions:a.value}):console.error(`Erreur lors de la r\xE9cup\xE9ration des partitions pour le morceau ${o.id}`,a.reason)}),R.rehearsalsCache=r}var le=oe(()=>{K();setInterval(()=>{R.currentUser&&U().catch(()=>{})},5*60*1e3)});async function _(){try{let e=await w("/me");if(R.currentUser=e,!e.needsGroup){let n=await w("/settings");X(n.darkMode),re(n.template||"classic"),document.title=`${n.groupName} \u2013 BandTrack`;let r=document.getElementById("group-name");r&&(r.textContent=n.groupName)}}catch{R.currentUser=null}}function X(e){let n=document.body;e?n.classList.add("dark"):n.classList.remove("dark")}function re(e){let n=document.body;n.classList.forEach(r=>{r.startsWith("template-")&&n.classList.remove(r)}),n.classList.add("template-"+e)}async function de(){try{await w("/logout","POST"),R.currentUser=null}catch(e){alert(e.message)}}var ue=oe(()=>{K();le()});var je=be(()=>{K();le();ue();var P=null,j="home",I=[],Z=[],q=null,H=new Date;Object.defineProperties(R,{currentUser:{get:()=>P,set:e=>P=e},currentPage:{get:()=>j,set:e=>j=e},rehearsalsCache:{get:()=>I,set:e=>I=e},groupsCache:{get:()=>Z,set:e=>Z=e},activeGroupId:{get:()=>q,set:e=>q=e},agendaDate:{get:()=>H,set:e=>H=e}});document.addEventListener("click",e=>{let n=document.getElementById("profile-menu"),r=document.getElementById("profile-btn");n&&!n.classList.contains("hidden")&&!n.contains(e.target)&&e.target!==r&&!r?.contains(e.target)&&(n.classList.add("hidden"),n.classList.remove("block","open"),r?.classList.remove("open"))});function ee(){let e=document.getElementById("profile-menu"),n=document.getElementById("profile-btn");!e||!n||(e.classList.toggle("hidden"),e.classList.toggle("block"),e.classList.toggle("open"),n.classList.toggle("open"))}function ne(){return P&&(P.membershipRole==="admin"||P.membershipRole==="moderator")}function ie(){return P&&P.membershipRole==="admin"}function te(e){if(!e)return"";let n=new Date(e);return isNaN(n)?e:n.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short",hour12:!1})}async function fe(){if(confirm("\xCAtes-vous s\xFBr de vouloir supprimer votre compte ?"))try{await w("/me","DELETE"),P=null,Q()}catch(n){alert(n.message)}}async function he(e){await w("/context","PUT",{groupId:Number(e)}),localStorage.setItem("activeGroupId",String(e)),q=Number(e),ce(),await _()}async function W(e){if(!P)return;let n=document.getElementById("group-select"),r=document.getElementById("create-group-btn"),a=document.getElementById("join-group-btn");r&&(r.onclick=()=>ye()),a&&(a.onclick=()=>Ee());try{Z=await w("/groups");let t=e||localStorage.getItem("activeGroupId");Z.some(o=>String(o.id)===String(t))||(t=Z[0]?Z[0].id:null),n&&(n.innerHTML="",Z.forEach(o=>{let c=document.createElement("option");c.value=o.id,c.textContent=o.name,n.appendChild(c)}),t&&(n.value=t),n.onchange=async()=>{await he(n.value),z(document.getElementById("app"))}),t&&await he(t)}catch(t){console.error(t)}}function ye(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let r=document.createElement("h3");r.textContent="Cr\xE9er un groupe",n.appendChild(r);let a=document.createElement("form");a.onsubmit=p=>p.preventDefault();let t=document.createElement("label");t.textContent="Nom du groupe";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%",a.appendChild(t),a.appendChild(o),n.appendChild(a);let c=document.createElement("div");c.className="modal-actions";let i=document.createElement("button");i.className="btn-secondary",i.textContent="Annuler",i.onclick=()=>e.remove();let d=document.createElement("button");d.className="btn-primary",d.textContent="Cr\xE9er",d.onclick=async()=>{let p=o.value.trim();if(p)try{let l=await w("/groups","POST",{name:p});alert("Code d'invitation : "+l.invitationCode),e.remove(),await W(l.id),z(document.getElementById("app"))}catch(l){alert(l.message)}},c.appendChild(i),c.appendChild(d),n.appendChild(c),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>o.focus(),50)}function Ee(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let r=document.createElement("h3");r.textContent="Rejoindre un groupe",n.appendChild(r);let a=document.createElement("form");a.onsubmit=s=>s.preventDefault();let t=document.createElement("label");t.textContent="Code d'invitation";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%";let c=document.createElement("label");c.textContent="Surnom";let i=document.createElement("input");i.type="text",i.style.width="100%",a.appendChild(t),a.appendChild(o),a.appendChild(c),a.appendChild(i),n.appendChild(a);let d=document.createElement("div");d.className="modal-actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Annuler",p.onclick=()=>e.remove();let l=document.createElement("button");l.className="btn-primary",l.textContent="Rejoindre",l.onclick=async()=>{let s=o.value.trim(),m=i.value.trim();if(s)try{let y=await w("/groups/join","POST",{code:s,nickname:m});e.remove(),await W(y.groupId),z(document.getElementById("app"))}catch(y){alert(y.message)}},d.appendChild(p),d.appendChild(l),n.appendChild(d),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>o.focus(),50)}async function xe(){await _(),P&&await W(),Q()}function Q(){let e=document.getElementById("app");if(P)P.needsGroup?we(e):z(e);else{let n=document.getElementById("group-name");n&&(n.textContent=""),ce(),Ne(e)}}function we(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let r=document.createElement("h2");r.textContent="Rejoindre ou cr\xE9er un groupe",n.appendChild(r);let a=document.createElement("p");a.textContent="Vous devez s\xE9lectionner ou cr\xE9er un groupe pour continuer.",n.appendChild(a);let t=document.createElement("p");t.textContent="Pour rejoindre un groupe existant, munissez-vous de son code d'invitation ou demandez \xE0 un administrateur de vous ajouter directement.",n.appendChild(t);let o=document.createElement("div"),c=document.createElement("button");c.className="btn-primary",c.textContent="Cr\xE9er un groupe",c.onclick=()=>ye(),o.appendChild(c);let i=document.createElement("button");i.className="btn-secondary",i.style.marginLeft="10px",i.textContent="Rejoindre un groupe",i.onclick=()=>Ee(),o.appendChild(i),n.appendChild(o);let d=document.createElement("button");d.id="delete-account-btn-group-setup",d.className="delete-account-btn",d.textContent="Supprimer mon compte",d.onclick=fe,n.appendChild(d),e.appendChild(n)}function Ne(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let r=!1;function a(){n.innerHTML="";let t=document.createElement("h2");t.textContent=r?"Inscription":"Connexion",n.appendChild(t);let o=document.createElement("form");o.onsubmit=async C=>{C.preventDefault(),r?await x():await v()};let c=document.createElement("label");c.textContent="Nom d\u2019utilisateur";let i=document.createElement("input");i.type="text",i.required=!0;let d=document.createElement("label");d.textContent="Mot de passe";let p=document.createElement("input");p.type="password",p.required=!0,o.appendChild(c),o.appendChild(i),o.appendChild(d),o.appendChild(p);let l;if(r){let C=document.createElement("label");C.textContent="Confirmer le mot de passe",l=document.createElement("input"),l.type="password",l.required=!0,o.appendChild(C),o.appendChild(l)}let s=document.createElement("div");s.style.color="var(--danger-color)",s.style.marginTop="12px",o.appendChild(s);let m=document.createElement("button");m.className="btn-primary",m.style.marginTop="20px",m.textContent=r?"S\u2019inscrire":"Se connecter",o.appendChild(m);let y=document.createElement("a");y.className="link",y.textContent=r?"D\xE9j\xE0 un compte ? Se connecter":"Cr\xE9er un compte",y.onclick=C=>{C.preventDefault(),r=!r,a()},n.appendChild(o),n.appendChild(y),e.appendChild(n);async function x(){let C=i.value.trim(),f=p.value,E=l?l.value:"";if(!C||!f){s.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}if(f!==E){s.textContent="Les mots de passe ne correspondent pas";return}try{await w("/register","POST",{username:C,password:f}),await _(),j="home",await W(),Q()}catch(N){s.textContent=N.message}}async function v(){let C=i.value.trim(),f=p.value;if(!C||!f){s.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}try{await w("/login","POST",{username:C,password:f}),await _(),j="home",await W(),Q()}catch(E){s.textContent=E.message}}}a()}async function ke(e){e.innerHTML="";let n=document.createElement("div");n.className="home-container",e.appendChild(n);let r="Aucune prestation pr\xE9vue";try{let d=await w("/performances"),p=new Date,l=d.filter(s=>new Date(s.date)>=p);if(l.sort((s,m)=>new Date(s.date)-new Date(m.date)),l.length>0){let s=l[0];r=`${s.name} (${te(s.date)})`}}catch{r="Impossible de r\xE9cup\xE9rer les prestations"}let a=document.createElement("p"),t=document.createElement("strong");t.textContent="Prochaine prestation :",a.appendChild(t),a.appendChild(document.createTextNode(" "+r)),n.appendChild(a);let o="\u2014";try{let p=(await w("/agenda")).filter(m=>m.type==="rehearsal"),l=new Date,s=p.filter(m=>new Date(m.date)>=l);if(s.sort((m,y)=>new Date(m.date)-new Date(y.date)),s.length>0){let m=s[0];o=`${te(m.date)}${m.location?" \u2013 "+m.location:""}`}}catch{}let c=document.createElement("p"),i=document.createElement("strong");i.textContent="Prochaine r\xE9p\xE9tition :",c.appendChild(i),c.appendChild(document.createTextNode(" "+o)),n.appendChild(c)}async function z(e){e.innerHTML="";let n=document.getElementById("profile-btn"),r=document.getElementById("profile-menu"),a=document.getElementById("menu-performances"),t=document.getElementById("menu-settings"),o=document.getElementById("menu-logout"),c=document.getElementById("theme-toggle");n&&r&&(n.onclick=l=>{l.stopPropagation(),ee()}),c&&(c.textContent=document.body.classList.contains("dark")?"\u2600\uFE0F":"\u{1F319}",c.onclick=async()=>{document.body.classList.toggle("dark");let l=document.body.classList.contains("dark");c.textContent=l?"\u2600\uFE0F":"\u{1F319}";try{let m={...await w("/settings"),darkMode:l};await w("/settings","PUT",m),X(m.darkMode)}catch(s){console.error(s)}}),a&&(a.onclick=()=>{j!=="performances"&&(j="performances",z(e)),r?.classList.contains("hidden")||ee()}),t&&(t.onclick=()=>{j!=="settings"&&(j="settings",z(e)),r?.classList.contains("hidden")||ee()}),o&&(o.onclick=async()=>{r?.classList.contains("hidden")||ee(),await de()});let i=document.createElement("div");i.className="page",e.appendChild(i);let d=document.createElement("div");if(d.className="nav-bar",[{key:"home",label:"Home",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>'},{key:"suggestions",label:"Suggestions",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"/></svg>'},{key:"rehearsals",label:"R\xE9p\xE8tes",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"/></svg>'},{key:"performances",label:"Prestations",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>'},{key:"agenda",label:"Agenda",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z"/></svg>'}].forEach(l=>{let s=document.createElement("button");s.innerHTML=`${l.icon}<span>${l.label}</span>`,s.className=j===l.key?"active":"",s.onclick=()=>{j!==l.key&&(j=l.key,z(e))},d.appendChild(s)}),e.appendChild(d),j==="home")ke(i);else if(j==="suggestions")F(i);else if(j==="rehearsals"){try{await U()}catch{}Y(i)}else if(j==="performances"){try{await U()}catch{}ae(i)}else if(j==="agenda"){try{await U()}catch{}G(i)}else j==="settings"&&J(i)}async function F(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux sugg\xE9r\xE9s",n.className="section-title",e.appendChild(n);let r=[];try{r=await w("/suggestions")}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les suggestions",e.appendChild(o);return}if(r.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucune proposition pour l\u2019instant",e.appendChild(t)}r.forEach(t=>{let o=document.createElement("div");o.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-pink-50";let c=document.createElement("div");c.className="card-header";let i=document.createElement("h3");i.textContent=t.title,i.onclick=()=>{o.classList.toggle("collapsed")},c.appendChild(i);let d=document.createElement("div");d.className="like-info";let p=document.createElement("span");p.textContent=`\u2764\uFE0F ${t.likes||0}`;let l=document.createElement("button");l.className="like-btn",l.textContent="\u{1F44D}",l.onclick=async v=>{v.stopPropagation(),l.disabled=!0,s.disabled=!0;try{let C=await w(`/suggestions/${t.id}/vote`,"POST");p.textContent=`\u2764\uFE0F ${C.likes}`,await F(e)}catch(C){alert(C.message),l.disabled=!1,s.disabled=!1}};let s=document.createElement("button");s.className="like-btn",s.textContent="\u{1F44E}",s.onclick=async v=>{v.stopPropagation(),l.disabled=!0,s.disabled=!0;try{let C=await w(`/suggestions/${t.id}/vote`,"DELETE");p.textContent=`\u2764\uFE0F ${C.likes}`,await F(e)}catch(C){alert(C.message),l.disabled=!1,s.disabled=!1}},d.appendChild(p),d.appendChild(l),d.appendChild(s),c.appendChild(d),o.appendChild(c);let m=document.createElement("div");if(m.className="card-details",t.author){let v=document.createElement("p");v.style.fontStyle="italic",v.textContent="Auteur : "+t.author,m.appendChild(v)}if(t.versionOf){let v=document.createElement("p");v.style.fontStyle="italic",v.textContent="Version de : "+t.versionOf,m.appendChild(v)}let y=t.youtube||t.url;if(y){let v=document.createElement("a");v.href=y,v.target="_blank",v.rel="noopener noreferrer",v.textContent=y,m.appendChild(v)}let x=document.createElement("p");if(x.style.fontSize="12px",x.style.color="var(--text-color)",x.textContent=`Ajout\xE9 par ${t.creator}`,m.appendChild(x),P&&(ne()||t.creatorId===P.id||t.creator===P.username)){let v=document.createElement("div");v.className="actions";let C=document.createElement("button");C.className="btn-secondary",C.textContent="Modifier",C.onclick=N=>{N.stopPropagation(),Le(t,e)},v.appendChild(C);let f=document.createElement("button");f.className="btn-primary",f.textContent="Passer en r\xE9p\xE9tition",f.onclick=async N=>{N.stopPropagation();try{let k=await w(`/suggestions/${t.id}/to-rehearsal`,"POST");I.push(k),F(e)}catch(k){alert(k.message)}},v.appendChild(f);let E=document.createElement("button");E.className="btn-danger",E.textContent="Supprimer",E.onclick=async N=>{if(N.stopPropagation(),!!confirm("Supprimer cette suggestion ?"))try{await w(`/suggestions/${t.id}`,"DELETE"),F(e)}catch(k){alert(k.message)}},v.appendChild(E),m.appendChild(v)}o.appendChild(m),e.appendChild(o)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau",a.textContent="+",a.onclick=()=>Te(e),e.appendChild(a)}function Te(e){let n=document.createElement("div");n.className="modal";let r=document.createElement("div");r.className="modal-content";let a=document.createElement("h3");a.textContent="Ajouter une suggestion",r.appendChild(a);let t=document.createElement("form");t.onsubmit=C=>{C.preventDefault()};let o=document.createElement("label");o.textContent="Titre";let c=document.createElement("input");c.type="text",c.required=!0,c.style.width="100%";let i=document.createElement("label");i.textContent="Auteur";let d=document.createElement("input");d.type="text",d.style.width="100%";let p=document.createElement("label");p.textContent="Version de";let l=document.createElement("input");l.type="text",l.style.width="100%";let s=document.createElement("label");s.textContent="Lien YouTube";let m=document.createElement("input");m.type="url",m.style.width="100%",t.appendChild(o),t.appendChild(c),t.appendChild(i),t.appendChild(d),t.appendChild(p),t.appendChild(l),t.appendChild(s),t.appendChild(m),r.appendChild(t);let y=document.createElement("div");y.className="modal-actions";let x=document.createElement("button");x.className="btn-secondary",x.textContent="Annuler",x.onclick=()=>{n.parentNode&&n.parentNode.removeChild(n)};let v=document.createElement("button");v.className="btn-primary",v.textContent="Ajouter",v.onclick=async C=>{C.preventDefault();let f=c.value.trim(),E=d.value.trim(),N=l.value.trim(),k=m.value.trim();if(f)try{await w("/suggestions","POST",{title:f,author:E,youtube:k,versionOf:N}),n.parentNode&&n.parentNode.removeChild(n),F(e)}catch(B){alert(B.message)}},y.appendChild(x),y.appendChild(v),r.appendChild(y),n.appendChild(r),document.body.appendChild(n),setTimeout(()=>c.focus(),50)}function Le(e,n){let r=document.createElement("div");r.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Modifier la suggestion",a.appendChild(t);let o=document.createElement("form");o.onsubmit=f=>f.preventDefault();let c=document.createElement("label");c.textContent="Titre";let i=document.createElement("input");i.type="text",i.required=!0,i.style.width="100%",i.value=e.title;let d=document.createElement("label");d.textContent="Auteur";let p=document.createElement("input");p.type="text",p.style.width="100%",p.value=e.author||"";let l=document.createElement("label");l.textContent="Version de";let s=document.createElement("input");s.type="text",s.style.width="100%",s.value=e.versionOf||"";let m=document.createElement("label");m.textContent="Lien YouTube";let y=document.createElement("input");y.type="url",y.style.width="100%",y.value=e.youtube||e.url||"",o.appendChild(c),o.appendChild(i),o.appendChild(d),o.appendChild(p),o.appendChild(l),o.appendChild(s),o.appendChild(m),o.appendChild(y),a.appendChild(o);let x=document.createElement("div");x.className="modal-actions";let v=document.createElement("button");v.className="btn-secondary",v.textContent="Annuler",v.onclick=()=>{r.parentNode&&r.parentNode.removeChild(r)};let C=document.createElement("button");C.className="btn-primary",C.textContent="Enregistrer",C.onclick=async f=>{f.preventDefault();let E=i.value.trim(),N=p.value.trim(),k=s.value.trim(),B=y.value.trim();if(E)try{await w(`/suggestions/${e.id}`,"PUT",{title:E,author:N,versionOf:k,youtube:B}),r.parentNode&&r.parentNode.removeChild(r),F(n)}catch(S){alert(S.message)}},x.appendChild(v),x.appendChild(C),a.appendChild(x),r.appendChild(a),document.body.appendChild(r),setTimeout(()=>i.focus(),50)}async function Y(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux en cours de travail",n.className="section-title",e.appendChild(n);let r=I;if(r.length===0)try{await U(),r=I}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les r\xE9p\xE9titions",e.appendChild(o);return}if(r.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucun morceau en r\xE9p\xE9tition",e.appendChild(t)}r.forEach(t=>{let o=document.createElement("div");o.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-blue-50";let c=t.levels[P.username]!=null?t.levels[P.username]:0,i=document.createElement("div");i.className="card-header";let d=document.createElement("h3");d.textContent=t.title,d.onclick=()=>{o.classList.toggle("collapsed")},i.appendChild(d);let p=document.createElement("span");p.className="level-badge",p.textContent=c,i.appendChild(p),o.appendChild(i);let l=document.createElement("div");if(l.className="card-details",t.author){let h=document.createElement("p");h.style.fontStyle="italic",h.textContent="Auteur : "+t.author,l.appendChild(h)}if(t.youtube){let h=document.createElement("a");h.href=t.youtube,h.target="_blank",h.rel="noopener noreferrer",h.textContent=t.youtube,l.appendChild(h)}let s=document.createElement("div");s.style.marginTop="8px";let m=document.createElement("label");m.textContent=`Votre niveau (${c}/10)`,m.className="level-display";let y=document.createElement("input");y.type="range",y.min=0,y.max=10,y.step=1,y.value=c;function x(h){let L=h/10,T=Math.round(255*(1-L)),u=Math.round(255*L);y.style.background=`linear-gradient(to right, rgb(${T},${u},80) ${h/10*100}%, var(--border-color) ${h/10*100}%)`}x(c),y.oninput=async()=>{let h=Number(y.value);m.textContent=`Votre niveau (${h}/10)`,p.textContent=h,x(h);try{await w(`/rehearsals/${t.id}`,"PUT",{level:h})}catch(L){alert(L.message)}},s.appendChild(m),s.appendChild(y),l.appendChild(s);let v=document.createElement("label");v.textContent="Vos notes";let C=document.createElement("textarea");C.value=t.notes&&t.notes[P.username]||"",C.onchange=async()=>{try{await w(`/rehearsals/${t.id}`,"PUT",{note:C.value})}catch(h){alert(h.message)}},l.appendChild(v),l.appendChild(C);let f=document.createElement("div");f.style.marginTop="8px",(t.audioNotes&&t.audioNotes[P.username]||[]).forEach((h,L)=>{let T=document.createElement("div");if(h.title){let g=document.createElement("div");g.textContent=h.title,T.appendChild(g)}let u=document.createElement("audio");u.controls=!0,u.src=h.audio,T.appendChild(u);let b=document.createElement("button");b.className="btn-danger",b.textContent="Supprimer audio",b.style.marginLeft="8px",b.onclick=async g=>{if(g.preventDefault(),!!confirm("Supprimer la note audio\xA0?"))try{await w(`/rehearsals/${t.id}`,"PUT",{audioIndex:L}),Y(e)}catch(D){alert(D.message)}},T.appendChild(b),f.appendChild(T)});let N=document.createElement("input");N.type="text",N.placeholder="Titre de la note",N.style.display="block",N.style.marginTop="8px";let k=document.createElement("input");k.type="file",k.accept="audio/*",k.style.display="none";let B=document.createElement("button");if(B.className="btn-secondary",B.textContent="Ajouter une note audio",B.onclick=h=>{h.preventDefault(),k.click()},k.onchange=async()=>{let h=k.files[0];if(!h)return;if(h.size>5*1024*1024){alert("Le fichier audio est trop volumineux (max 5\xA0Mo).");return}let L=new FileReader;L.onload=async T=>{let u=(T.target?.result||"").toString();try{await w(`/rehearsals/${t.id}`,"PUT",{audio:u,audioTitle:N.value}),Y(e)}catch(b){alert(b.message)}},L.readAsDataURL(h)},f.appendChild(N),f.appendChild(B),f.appendChild(k),l.appendChild(f),P){let h=document.createElement("div");h.style.marginTop="8px";let L=document.createElement("label");L.textContent="Partition(s)",h.appendChild(L);let T=document.createElement("div");(t.partitions||[]).forEach(g=>{let D=document.createElement("div"),A=document.createElement("span");A.textContent=`${g.displayName} \u2013 ${g.uploader} \u2013 ${te(g.date)}`,D.appendChild(A);let $=document.createElement("a");if($.href=g.downloadUrl,$.textContent="T\xE9l\xE9charger",$.target="_blank",$.rel="noopener noreferrer",$.className="btn-secondary",$.style.marginLeft="8px",D.appendChild($),g.uploader===P.username||ie()){let M=document.createElement("button");M.className="btn-danger",M.textContent="Supprimer",M.style.marginLeft="8px",M.onclick=async V=>{if(V.preventDefault(),!!confirm("Supprimer cette partition\xA0?"))try{await me(t.id,g.id),await U(),Y(e)}catch(O){alert(O.message)}},D.appendChild(M)}T.appendChild(D)}),h.appendChild(T);let u=document.createElement("input");u.type="file",u.accept="application/pdf",u.style.display="none";let b=document.createElement("button");b.className="btn-secondary",b.textContent="D\xE9poser une partition",b.onclick=g=>{g.preventDefault(),u.click()},u.onchange=async()=>{let g=u.files[0];if(g)try{await pe(t.id,g,g.name),await U(),Y(e)}catch(D){alert(D.message)}},h.appendChild(b),h.appendChild(u),l.appendChild(h)}let S=Object.keys(t.levels||{}).filter(h=>h.toLowerCase()!==P.username.toLowerCase());if(S.length>0){let h=document.createElement("div");h.style.marginTop="12px";let L=document.createElement("p");L.textContent="Autres membres :",L.style.fontStyle="italic",h.appendChild(L),S.forEach(T=>{let u=document.createElement("div");u.style.marginBottom="4px";let b=t.levels[T],g=t.notes&&t.notes[T]?t.notes[T]:"",D=document.createElement("p");D.style.margin="0";let A=document.createElement("strong");A.textContent=T,D.appendChild(A),D.appendChild(document.createTextNode(` \u2013 Niveau ${b}/10${g?" \u2013 "+g:""}`)),u.appendChild(D),(t.audioNotes&&t.audioNotes[T]||[]).forEach(M=>{let V=document.createElement("audio");if(V.controls=!0,V.src=M.audio,V.style.display="block",V.style.marginTop="4px",M.title){let O=document.createElement("div");O.textContent=M.title,O.style.marginTop="4px",u.appendChild(O)}u.appendChild(V)}),h.appendChild(u)}),l.appendChild(h)}if(P&&(ne()||P.id===t.creatorId)){let h=document.createElement("div");h.className="actions";let L=document.createElement("button");L.className="btn-secondary",L.textContent="Modifier",L.onclick=b=>{b.stopPropagation(),De(t,e)},h.appendChild(L);let T=document.createElement("button");T.className="btn-primary",T.textContent="Remettre dans J\u2019aime",T.onclick=async b=>{b.stopPropagation();try{await w(`/rehearsals/${t.id}/to-suggestion`,"POST"),Y(e)}catch(g){alert(g.message)}},h.appendChild(T);let u=document.createElement("button");u.className="btn-danger",u.textContent="Supprimer",u.onclick=async b=>{if(b.stopPropagation(),!!confirm("Supprimer ce morceau ?"))try{await w(`/rehearsals/${t.id}`,"DELETE"),I=I.filter(g=>g.id!==t.id),Y(e)}catch(g){alert(g.message)}},h.appendChild(u),l.appendChild(h)}o.appendChild(l),e.appendChild(o)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau en r\xE9p\xE9tition",a.textContent="+",a.onclick=()=>Se(e),e.appendChild(a)}function Se(e,n){let r=document.createElement("div");r.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Ajouter un morceau",a.appendChild(t);let o=document.createElement("form");o.onsubmit=N=>N.preventDefault();let c=document.createElement("label");c.textContent="Titre";let i=document.createElement("input");i.type="text",i.required=!0,i.style.width="100%";let d=document.createElement("label");d.textContent="Auteur";let p=document.createElement("input");p.type="text",p.style.width="100%";let l=document.createElement("label");l.textContent="Lien YouTube";let s=document.createElement("input");s.type="url",s.style.width="100%";let m=document.createElement("label");m.textContent="Lien Spotify";let y=document.createElement("input");y.type="url",y.style.width="100%";let x=document.createElement("label");x.textContent="Version de";let v=document.createElement("input");v.type="text",v.style.width="100%",o.appendChild(c),o.appendChild(i),o.appendChild(d),o.appendChild(p),o.appendChild(l),o.appendChild(s),o.appendChild(m),o.appendChild(y),o.appendChild(x),o.appendChild(v),a.appendChild(o);let C=document.createElement("div");C.className="modal-actions";let f=document.createElement("button");f.className="btn-secondary",f.textContent="Annuler",f.onclick=()=>{r.parentNode&&r.parentNode.removeChild(r)};let E=document.createElement("button");E.className="btn-primary",E.textContent="Ajouter",E.onclick=async N=>{N.preventDefault();let k=i.value.trim();if(!k)return;let B=p.value.trim(),S=s.value.trim(),h=y.value.trim(),L=v.value.trim();try{let T=await w("/rehearsals","POST",{title:k,author:B,youtube:S,spotify:h,versionOf:L});r.parentNode&&r.parentNode.removeChild(r),I.push(T),typeof n=="function"?n():Y(e)}catch(T){alert(T.message)}},C.appendChild(f),C.appendChild(E),a.appendChild(C),r.appendChild(a),document.body.appendChild(r),setTimeout(()=>i.focus(),50)}function De(e,n,r){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier le morceau",t.appendChild(o);let c=document.createElement("form");c.onsubmit=k=>k.preventDefault();let i=document.createElement("label");i.textContent="Titre";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.title;let p=document.createElement("label");p.textContent="Auteur";let l=document.createElement("input");l.type="text",l.style.width="100%",l.value=e.author||"";let s=document.createElement("label");s.textContent="Lien YouTube";let m=document.createElement("input");m.type="url",m.style.width="100%",m.value=e.youtube||"";let y=document.createElement("label");y.textContent="Lien Spotify";let x=document.createElement("input");x.type="url",x.style.width="100%",x.value=e.spotify||"";let v=document.createElement("label");v.textContent="Version de";let C=document.createElement("input");C.type="text",C.style.width="100%",C.value=e.versionOf||"",c.appendChild(i),c.appendChild(d),c.appendChild(p),c.appendChild(l),c.appendChild(s),c.appendChild(m),c.appendChild(y),c.appendChild(x),c.appendChild(v),c.appendChild(C),t.appendChild(c);let f=document.createElement("div");f.className="modal-actions";let E=document.createElement("button");E.className="btn-secondary",E.textContent="Annuler",E.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let N=document.createElement("button");N.className="btn-primary",N.textContent="Enregistrer",N.onclick=async k=>{k.preventDefault();let B=d.value.trim(),S=l.value.trim(),h=m.value.trim(),L=x.value.trim(),T=C.value.trim();if(B)try{await w(`/rehearsals/${e.id}`,"PUT",{title:B,author:S,youtube:h,spotify:L,versionOf:T}),a.parentNode&&a.parentNode.removeChild(a);let u=I.findIndex(b=>b.id===e.id);u!==-1&&(I[u]={...I[u],title:B,author:S||null,youtube:h||null,spotify:L||null,versionOf:T||null}),typeof r=="function"?r():Y(n)}catch(u){alert(u.message)}},f.appendChild(E),f.appendChild(N),t.appendChild(f),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function ae(e){e.innerHTML="";let n=document.createElement("h2");n.className="section-title",n.textContent="Prestations",e.appendChild(n);let r=[];try{r=await w("/performances")}catch{let p=document.createElement("p");p.style.color="var(--danger-color)",p.textContent="Impossible de r\xE9cup\xE9rer les prestations",e.appendChild(p);return}if(I.length===0)try{await U()}catch{}let a=new Date,t=r.filter(d=>new Date(d.date)>=a),o=r.filter(d=>new Date(d.date)<a);function c(d,p){let l=document.createElement("div");if(l.className="section-title",l.textContent=d,e.appendChild(l),p.length===0){let s=document.createElement("p");s.textContent="Aucune prestation",e.appendChild(s);return}p.forEach(s=>{let m=document.createElement("div");m.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-green-50";let y=document.createElement("h3");y.textContent=s.name,y.onclick=()=>{m.classList.toggle("collapsed")},m.appendChild(y);let x=document.createElement("div");x.className="card-details";let v=document.createElement("p");if(v.textContent="Date : "+te(s.date),x.appendChild(v),s.location){let C=document.createElement("p");C.textContent="Lieu : "+s.location,x.appendChild(C)}if(s.songs&&s.songs.length>0){let C=document.createElement("ul");s.songs.forEach(f=>{let E=I.find(k=>k.id===f),N=document.createElement("li");N.textContent=E?E.title:"\u2014",C.appendChild(N)}),x.appendChild(C)}if(P&&(ne()||P.id===s.creatorId)){let C=document.createElement("div");C.className="actions";let f=document.createElement("button");f.className="btn-secondary",f.textContent="Modifier",f.onclick=N=>{N.stopPropagation(),ve(s,e)},C.appendChild(f);let E=document.createElement("button");E.className="btn-danger",E.textContent="Supprimer",E.onclick=async N=>{if(N.stopPropagation(),!!confirm("Supprimer cette prestation ?"))try{await w(`/performances/${s.id}`,"DELETE"),ae(e)}catch(k){alert(k.message)}},C.appendChild(E),x.appendChild(C)}m.appendChild(x),e.appendChild(m)})}c("\xC0 venir",t),c("Pass\xE9es",o);let i=document.createElement("div");i.className="fab",i.title="Ajouter une prestation",i.textContent="+",i.onclick=()=>se(e),e.appendChild(i)}async function G(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Agenda",n.className="section-title",e.appendChild(n);let r=document.createElement("div");r.className="calendar-nav";let a=document.createElement("button");a.textContent="<",a.onclick=()=>{H.setMonth(H.getMonth()-1),G(e)};let t=document.createElement("button");t.textContent=">",t.onclick=()=>{H.setMonth(H.getMonth()+1),G(e)};let o=document.createElement("span");o.textContent=H.toLocaleDateString(void 0,{month:"long",year:"numeric"}),r.appendChild(a),r.appendChild(o),r.appendChild(t),e.appendChild(r);let c=document.createElement("div");c.className="actions";let i=document.createElement("button");i.className="btn-secondary",i.textContent="Nouvelle r\xE9p\xE9tition",i.onclick=()=>Ce(e,()=>G(e));let d=document.createElement("button");d.className="btn-secondary",d.textContent="Nouvelle prestation",d.onclick=()=>se(e,()=>G(e)),c.appendChild(i),c.appendChild(d),e.appendChild(c);let p=[];try{let f=H.getFullYear(),E=H.getMonth()+1,N=String(E).padStart(2,"0"),k=`${f}-${N}-01`,B=`${f}-${N}-31`;p=await w(`/agenda?start=${k}&end=${B}`)}catch{let E=document.createElement("p");E.style.color="var(--danger-color)",E.textContent="Impossible de r\xE9cup\xE9rer l'agenda",e.appendChild(E);return}p.sort((f,E)=>f.date.localeCompare(E.date));let l=document.createElement("div");l.className="calendar-grid",["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(f=>{let E=document.createElement("div");E.className="calendar-day-name",E.textContent=f,l.appendChild(E)});let m=H.getFullYear(),y=H.getMonth(),v=(new Date(m,y,1).getDay()+6)%7;for(let f=0;f<v;f++){let E=document.createElement("div");E.className="calendar-cell empty",l.appendChild(E)}let C=new Date(m,y+1,0).getDate();for(let f=1;f<=C;f++){let E=document.createElement("div");E.className="calendar-cell";let N=document.createElement("div");N.className="calendar-date",N.textContent=f,E.appendChild(N);let k=`${m}-${String(y+1).padStart(2,"0")}-${String(f).padStart(2,"0")}`,B=p.filter(S=>S.date?.startsWith(k));B.forEach(S=>{let h=document.createElement("div");h.className=`calendar-event ${S.type==="performance"?"performance":"rehearsal"}`;let L=S.title||S.location||"",T=S.type==="performance"?"Prestation":"R\xE9p\xE9tition";h.textContent=L||T,h.onclick=async u=>{if(u.preventDefault(),u.stopPropagation(),S.type==="performance")try{I.length===0&&await U();let g=(await w("/performances")).find(D=>D.id===S.id);g&&ve(g,e,()=>G(e))}catch(b){alert(b.message)}else Be(S,e,()=>G(e))},E.appendChild(h)}),B.length===0&&(E.onclick=async()=>{if(!ne())return;if(confirm("Ajouter une prestation ? (Annuler pour une r\xE9p\xE9tition)")){try{I.length===0&&await U()}catch{}se(e,()=>G(e),k)}else Ce(e,()=>G(e),`${k}T20:00`)}),l.appendChild(E)}e.appendChild(l)}function Ce(e,n,r){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter une r\xE9p\xE9tition",t.appendChild(o);let c=document.createElement("form");c.onsubmit=x=>x.preventDefault();let i=document.createElement("label");i.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",r&&(d.value=r);let p=document.createElement("label");p.textContent="Lieu";let l=document.createElement("input");l.type="text",l.style.width="100%",c.appendChild(i),c.appendChild(d),c.appendChild(p),c.appendChild(l),t.appendChild(c);let s=document.createElement("div");s.className="modal-actions";let m=document.createElement("button");m.className="btn-secondary",m.textContent="Annuler",m.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let y=document.createElement("button");y.className="btn-primary",y.textContent="Ajouter",y.onclick=async x=>{x.preventDefault();let v=d.value;if(!v)return;let C=l.value.trim();try{await w("/agenda","POST",{type:"rehearsal",date:v,location:C}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"&&n()}catch(f){alert(f.message)}},s.appendChild(m),s.appendChild(y),t.appendChild(s),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function se(e,n,r){try{await U()}catch(k){alert(k.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter une prestation",t.appendChild(o);let c=document.createElement("form");c.onsubmit=k=>k.preventDefault();let i=document.createElement("label");i.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%";let p=document.createElement("label");p.textContent="Date";let l=document.createElement("input");l.type="date",l.required=!0,l.style.width="100%",r&&(l.value=r);let s=document.createElement("label");s.textContent="Heure";let m=document.createElement("input");m.type="time",m.required=!0,m.style.width="100%";let y=document.createElement("label");y.textContent="Lieu";let x=document.createElement("input");x.type="text",x.style.width="100%";let v=document.createElement("label");v.textContent="Morceaux jou\xE9s";let C=document.createElement("div");C.className="select-list",I.forEach(k=>{let B=document.createElement("label");B.style.display="flex",B.style.justifyContent="space-between",B.style.alignItems="center";let S=document.createElement("input");S.type="checkbox",S.value=k.id;let h=document.createElement("span");h.textContent=k.title,h.style.marginLeft="4px";let L=document.createElement("span");L.appendChild(S),L.appendChild(h);let T=document.createElement("span");T.className="level-badge";let u=Object.values(k.levels||{}).map(Number),b=u.length>0?u.reduce((g,D)=>g+D,0)/u.length:0;T.textContent=b.toFixed(1),B.appendChild(L),B.appendChild(T),C.appendChild(B)}),c.appendChild(i),c.appendChild(d),c.appendChild(p),c.appendChild(l),c.appendChild(s),c.appendChild(m),c.appendChild(y),c.appendChild(x),c.appendChild(v),c.appendChild(C),t.appendChild(c);let f=document.createElement("div");f.className="modal-actions";let E=document.createElement("button");E.className="btn-secondary",E.textContent="Annuler",E.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let N=document.createElement("button");N.className="btn-primary",N.textContent="Ajouter",N.onclick=async k=>{k.preventDefault();let B=d.value.trim(),S=l.value,h=m.value,L=x.value.trim();if(!B||!S||!h)return;let T=`${S}T${h}`,u=[];C.querySelectorAll('input[type="checkbox"]').forEach(g=>{g.checked&&u.push(Number(g.value))});let b=!1;for(let g of u){let D=I.find(A=>A.id===g);if(D){let A=Object.values(D.levels||{}).map(Number);if((A.length?Math.min(...A):0)<=6){b=!0;break}}}if(!(b&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Ajouter quand m\xEAme ?")))try{await w("/performances","POST",{name:B,date:T,location:L,songs:u}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"?n():ae(e)}catch(g){alert(g.message)}},f.appendChild(E),f.appendChild(N),t.appendChild(f),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Be(e,n,r){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la r\xE9p\xE9tition",t.appendChild(o);let c=document.createElement("form");c.onsubmit=x=>x.preventDefault();let i=document.createElement("label");i.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",d.value=e.date||"";let p=document.createElement("label");p.textContent="Lieu";let l=document.createElement("input");l.type="text",l.style.width="100%",l.value=e.location||"",c.appendChild(i),c.appendChild(d),c.appendChild(p),c.appendChild(l),t.appendChild(c);let s=document.createElement("div");s.className="modal-actions";let m=document.createElement("button");m.className="btn-secondary",m.textContent="Annuler",m.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let y=document.createElement("button");y.className="btn-primary",y.textContent="Enregistrer",y.onclick=async x=>{x.preventDefault();let v=d.value;if(!v)return;let C=l.value.trim();try{await w(`/agenda/${e.id}`,"PUT",{type:"rehearsal",date:v,location:C}),a.parentNode&&a.parentNode.removeChild(a),typeof r=="function"&&r()}catch(f){alert(f.message)}},s.appendChild(m),s.appendChild(y),t.appendChild(s),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function ve(e,n,r){try{await U()}catch(S){alert(S.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la prestation",t.appendChild(o);let c=document.createElement("form");c.onsubmit=S=>S.preventDefault();let i=document.createElement("label");i.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.name;let p=document.createElement("label");p.textContent="Date";let l=document.createElement("input");l.type="date",l.required=!0,l.style.width="100%";let[s,m]=(e.date||"").split("T");l.value=s;let y=document.createElement("label");y.textContent="Heure";let x=document.createElement("input");x.type="time",x.required=!0,x.style.width="100%",x.value=(m||"").slice(0,5);let v=document.createElement("label");v.textContent="Lieu";let C=document.createElement("input");C.type="text",C.style.width="100%",C.value=e.location||"";let f=document.createElement("label");f.textContent="Morceaux jou\xE9s";let E=document.createElement("div");E.className="select-list",I.forEach(S=>{let h=document.createElement("label");h.style.display="flex",h.style.justifyContent="space-between",h.style.alignItems="center";let L=document.createElement("input");L.type="checkbox",L.value=S.id,e.songs.includes(S.id)&&(L.checked=!0);let T=document.createElement("span");T.textContent=S.title,T.style.marginLeft="4px";let u=document.createElement("span");u.appendChild(L),u.appendChild(T);let b=document.createElement("span");b.className="level-badge";let g=Object.values(S.levels||{}).map(Number),D=g.length>0?g.reduce((A,$)=>A+$,0)/g.length:0;b.textContent=D.toFixed(1),h.appendChild(u),h.appendChild(b),E.appendChild(h)}),c.appendChild(i),c.appendChild(d),c.appendChild(p),c.appendChild(l),c.appendChild(y),c.appendChild(x),c.appendChild(v),c.appendChild(C),c.appendChild(f),c.appendChild(E),t.appendChild(c);let N=document.createElement("div");N.className="modal-actions";let k=document.createElement("button");k.className="btn-secondary",k.textContent="Annuler",k.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let B=document.createElement("button");B.className="btn-primary",B.textContent="Enregistrer",B.onclick=async S=>{S.preventDefault();let h=d.value.trim(),L=l.value,T=x.value,u=C.value.trim();if(!h||!L||!T)return;let b=`${L}T${T}`,g=[];E.querySelectorAll('input[type="checkbox"]').forEach(A=>{A.checked&&g.push(Number(A.value))});let D=!1;for(let A of g){let $=I.find(M=>M.id===A);if($){let M=Object.values($.levels||{}).map(Number);if((M.length?Math.min(...M):0)<=6){D=!0;break}}}if(!(D&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Enregistrer quand m\xEAme ?")))try{await w(`/performances/${e.id}`,"PUT",{name:h,date:b,location:u,songs:g}),a.parentNode&&a.parentNode.removeChild(a),typeof r=="function"?r():ae(n)}catch(A){alert(A.message)}},N.appendChild(k),N.appendChild(B),t.appendChild(N),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Pe(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");r.textContent="Groupes",n.appendChild(r);let a=document.createElement("select");a.id="group-select",n.appendChild(a);let t=document.createElement("div");t.style.marginTop="10px";let o=document.createElement("button");o.id="create-group-btn",o.className="btn-secondary",o.textContent="Cr\xE9er",t.appendChild(o);let c=document.createElement("button");c.id="join-group-btn",c.className="btn-secondary",c.textContent="Rejoindre",c.style.marginLeft="8px",t.appendChild(c);let i=document.createElement("button");if(i.id="rename-group-btn",i.className="btn-secondary",i.textContent="Renommer",i.style.marginLeft="8px",i.onclick=async()=>{let d=prompt("Nouveau nom du groupe",e.groupName);if(!d||d.trim()===""||d===e.groupName)return;let p=d.trim(),l=e.id||P.groupId;try{await w(`/groups/${l}`,"PUT",{name:p}),e.groupName=p,document.title=`${e.groupName} \u2013 BandTrack`;let s=document.getElementById("group-name");s&&(s.textContent=e.groupName),await W(l),await J(document.getElementById("app"))}catch(s){alert(s.message)}},t.appendChild(i),n.appendChild(t),ie()){let d=document.createElement("div");d.style.marginTop="8px";let p=e.invitationCode,l=document.createElement("span");l.textContent=`Code d'invitation : ${p}`,d.appendChild(l);let s=document.createElement("button");s.textContent="Copier",s.style.marginLeft="8px",s.onclick=()=>navigator.clipboard.writeText(p),d.appendChild(s);let m=document.createElement("button");m.textContent="Renouveler",m.style.marginLeft="8px",m.onclick=async()=>{try{p=(await w("/groups/renew-code","POST")).invitationCode,l.textContent=`Code d'invitation : ${p}`}catch(y){alert(y.message)}},d.appendChild(m),n.appendChild(d)}return n}function Ae(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");n.textContent="Mot de passe",e.appendChild(n);let r=document.createElement("form");r.onsubmit=p=>p.preventDefault();let a=document.createElement("label");a.textContent="Mot de passe actuel";let t=document.createElement("input");t.type="password",t.required=!0,t.style.width="100%";let o=document.createElement("label");o.textContent="Nouveau mot de passe";let c=document.createElement("input");c.type="password",c.required=!0,c.style.width="100%";let i=document.createElement("button");i.className="btn-primary",i.type="submit",i.textContent="Modifier",i.style.marginTop="8px";let d=document.createElement("p");return d.style.marginTop="8px",r.appendChild(a),r.appendChild(t),r.appendChild(o),r.appendChild(c),r.appendChild(i),r.appendChild(d),r.onsubmit=async p=>{p.preventDefault(),d.textContent="";try{await w("/password","PUT",{oldPassword:t.value,newPassword:c.value}),d.style.color="green",d.textContent="Mot de passe mis \xE0 jour",t.value="",c.value=""}catch(l){d.style.color="var(--danger-color)",d.textContent=l.message}},e.appendChild(r),e}function Me(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");r.textContent="Th\xE8me",n.appendChild(r);let a=document.createElement("div"),t=document.createElement("label");t.textContent="Mode sombre",t.style.marginRight="8px";let o=document.createElement("input");o.type="checkbox",o.checked=e.darkMode,o.onchange=async()=>{e.darkMode=o.checked;try{await w("/settings","PUT",e),X(o.checked)}catch(l){alert(l.message)}},a.appendChild(t),a.appendChild(o),n.appendChild(a);let c=document.createElement("div");c.style.marginTop="20px";let i=document.createElement("label");i.textContent="Template (design)",i.style.marginRight="8px";let d=document.createElement("select");return[{value:"classic",label:"Classique"},{value:"groove",label:"Groove"},{value:"violet",label:"Violet"},{value:"imgbg",label:"Image"}].forEach(l=>{let s=document.createElement("option");s.value=l.value,s.textContent=l.label,d.appendChild(s)}),d.value=e.template||"classic",d.onchange=async()=>{let l=d.value;e.template=l;try{await w("/settings","PUT",e),re(l)}catch(s){alert(s.message)}},c.appendChild(i),c.appendChild(d),n.appendChild(c),n}async function $e(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");if(n.textContent="Membres",e.appendChild(n),q==null||P?.needsGroup){let r=document.createElement("p");return r.textContent="Aucun groupe actif",e.appendChild(r),e}try{let r=await w(`/groups/${q}/members`),a=document.createElement("table");a.className="user-table";let t=document.createElement("thead");t.innerHTML="<tr><th>Membre</th><th>R\xF4le</th></tr>",a.appendChild(t);let o=document.createElement("tbody");r.forEach(c=>{let i=document.createElement("tr"),d=document.createElement("td");d.textContent=c.username;let p=document.createElement("td");p.textContent=c.role,i.appendChild(d),i.appendChild(p),o.appendChild(i)}),a.appendChild(o),e.appendChild(a)}catch{let a=document.createElement("p");a.style.color="var(--danger-color)",a.textContent="Impossible de r\xE9cup\xE9rer les membres du groupe",e.appendChild(a)}return e}async function Ie(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");if(r.textContent="Administration",n.appendChild(r),q==null||P?.needsGroup){let a=document.createElement("p");return a.textContent="Aucun groupe actif",n.appendChild(a),n}try{let a=await w("/context");if(!a){let u=document.createElement("p");return u.textContent="Aucun groupe actif",n.appendChild(u),n}let[t,o]=await Promise.all([w(`/groups/${q}/members`),w("/users")]),c=document.createElement("h4");c.textContent="Tableau de bord du groupe",c.style.marginTop="10px",n.appendChild(c);let i=document.createElement("div"),d=a.invitation_code,p=document.createElement("span");p.textContent=`Code d'invitation : ${d}`,i.appendChild(p);let l=document.createElement("button");l.textContent="Copier",l.style.marginLeft="8px",l.onclick=()=>navigator.clipboard.writeText(d),i.appendChild(l);let s=document.createElement("button");s.textContent="Renouveler",s.style.marginLeft="8px",s.onclick=async()=>{try{d=(await w("/groups/renew-code","POST")).invitationCode,p.textContent=`Code d'invitation : ${d}`}catch(u){alert(u.message)}},i.appendChild(s),n.appendChild(i);let m=document.createElement("table");m.className="user-table";let y=document.createElement("thead");y.innerHTML="<tr><th>Membre</th><th>R\xF4le</th><th>Actions</th></tr>",m.appendChild(y);let x=document.createElement("tbody");t.forEach(u=>{let b=document.createElement("tr"),g=document.createElement("td");g.textContent=u.username;let D=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach(V=>{let O=document.createElement("option");O.value=V,O.textContent=V,u.role===V&&(O.selected=!0),A.appendChild(O)}),u.userId===P.id&&(A.disabled=!0),A.onchange=async()=>{try{await w(`/groups/${q}/members`,"PUT",{id:u.id,role:A.value})}catch(V){alert(V.message)}},D.appendChild(A);let $=document.createElement("td"),M=document.createElement("button");M.textContent=u.userId===P.id?"Quitter":"Retirer",M.onclick=async()=>{let V=u.userId===P.id?"Quitter le groupe ?":"Supprimer ce membre ?";if(confirm(V))try{await w(`/groups/${q}/members`,"DELETE",{userId:u.userId}),u.userId===P.id?(alert("Quitter le groupe"),P.needsGroup=!0,Q()):(b.remove(),alert("Membre supprim\xE9"))}catch(O){alert(O.message)}},$.appendChild(M),b.appendChild(g),b.appendChild(D),b.appendChild($),x.appendChild(b)}),m.appendChild(x),n.appendChild(m);let v=new Set(t.map(u=>u.userId)),C=o.filter(u=>!v.has(u.id));if(C.length>0){let u=document.createElement("div"),b=document.createElement("select");C.forEach(D=>{let A=document.createElement("option");A.value=D.id,A.textContent=D.username,b.appendChild(A)}),u.appendChild(b);let g=document.createElement("button");g.textContent="Ajouter",g.style.marginLeft="8px",g.onclick=async()=>{try{let D=Number(b.value);await w(`/groups/${q}/members`,"POST",{userId:D,role:"user"}),J(e)}catch(D){alert(D.message)}},u.appendChild(g),n.appendChild(u)}let f=document.createElement("div"),E=document.createElement("input");E.type="email",E.placeholder="adresse e-mail",f.appendChild(E);let N=document.createElement("button");N.textContent="Inviter",N.style.marginLeft="8px",N.onclick=async()=>{let u=E.value.trim();if(u)try{let b=await w(`/groups/${q}/invite`,"POST",{email:u});b.temporaryPassword&&alert(`Mot de passe temporaire : ${b.temporaryPassword}`),J(e)}catch(b){alert(b.message)}},f.appendChild(N),n.appendChild(f);let k=document.createElement("h4");k.textContent="Gestion des utilisateurs",k.style.marginTop="30px",n.appendChild(k);let B=document.createElement("table");B.className="user-table";let S=document.createElement("thead");S.innerHTML="<tr><th>Utilisateur</th><th>R\xF4le</th></tr>",B.appendChild(S);let h=document.createElement("tbody"),L={};o.forEach(u=>{L[u.id]=u.role;let b=document.createElement("tr"),g=document.createElement("td");g.textContent=u.username;let D=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach($=>{let M=document.createElement("option");M.value=$,M.textContent=$,u.role===$&&(M.selected=!0),A.appendChild(M)}),u.id===P.id&&(A.disabled=!0),A.dataset.userId=u.id,D.appendChild(A),b.appendChild(g),b.appendChild(D),h.appendChild(b)}),B.appendChild(h),n.appendChild(B);let T=document.createElement("button");T.className="btn-primary",T.style.marginTop="10px",T.textContent="Enregistrer les r\xF4les",T.onclick=async()=>{try{let u=[];h.querySelectorAll("select").forEach(b=>{let g=Number(b.dataset.userId),D=b.value;L[g]!==D&&u.push({id:g,role:D})});for(let b of u)await w(`/users/${b.id}`,"PUT",{role:b.role});alert("R\xF4les mis \xE0 jour"),J(e)}catch(u){alert(u.message)}},n.appendChild(T)}catch{let t=document.createElement("p");t.style.color="var(--danger-color)",t.textContent="Impossible de r\xE9cup\xE9rer les membres",n.appendChild(t)}return n}async function J(e){e.innerHTML="";let n=document.createElement("h2");if(n.className="section-title",n.textContent="Param\xE8tres",e.appendChild(n),P){let l=document.createElement("p");l.className="user-info",l.textContent=`Utilisateur connect\xE9: ${P.username}`,e.appendChild(l)}let r=document.createElement("div");r.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let a=document.createElement("button");a.className="logout-btn",a.textContent="Se d\xE9connecter",a.onclick=de,r.appendChild(a);let t=document.createElement("button");t.id="delete-account-btn",t.className="delete-account-btn",t.textContent="Supprimer mon compte",t.onclick=fe,r.appendChild(t);let o;try{o=await w("/settings")}catch{let s=document.createElement("p");s.style.color="var(--danger-color)",s.textContent="Impossible de r\xE9cup\xE9rer les param\xE8tres",e.appendChild(s),e.appendChild(r);return}let c={...o},i=Pe(c);e.appendChild(i);try{await W();let l=await $e();e.appendChild(l)}catch(l){console.error("Failed to load groups or members",l)}let d=Me(c);e.appendChild(d);let p=Ae();if(e.appendChild(p),e.appendChild(r),ie()){let l=await Ie(e);e.appendChild(l)}}window.addEventListener("DOMContentLoaded",xe)});je();})();
