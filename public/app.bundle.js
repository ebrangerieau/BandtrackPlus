(()=>{var oe=(e,n)=>()=>(e&&(n=e(e=0)),n);var be=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports);function ce(){R.rehearsalsCache=[]}var R,K=oe(()=>{R={currentUser:null,currentPage:"home",rehearsalsCache:[],groupsCache:[],activeGroupId:null,agendaDate:new Date}});async function w(e,n="GET",l){let a={method:n,credentials:"same-origin"};l!==void 0&&(a.headers={"Content-Type":"application/json"},a.body=JSON.stringify(l));let t=await fetch("/api"+e,a),o;try{o=await t.json()}catch{o=null}if(t.status===401)throw R.currentUser=null,new Error(o?.error||"Non authentifi\xE9");if(t.status===403&&o&&o.error==="No membership")throw R.currentUser&&(R.currentUser.needsGroup=!0),new Error("No membership");if(t.status===404&&e==="/context"&&n==="GET")return null;if(!t.ok)throw new Error(o&&o.error||"Erreur API");return o}function ge(e){return w(`/rehearsals/${e}/partitions`)}async function pe(e,n,l){let a=new FormData;a.append("file",n),l&&a.append("displayName",l);let t=await fetch(`/api/rehearsals/${e}/partitions`,{method:"POST",body:a,credentials:"same-origin"}),o;try{o=await t.json()}catch{o=null}if(t.status===401)throw R.currentUser=null,new Error(o?.error||"Non authentifi\xE9");if(!t.ok)throw new Error(o&&o.error||"Erreur API");return o}function me(e,n){return w(`/rehearsals/${e}/partitions/${n}`,"DELETE")}async function U(){let e=await w("/rehearsals"),n=await Promise.allSettled(e.map(a=>ge(a.id))),l=[];n.forEach((a,t)=>{let o=e[t];a.status==="fulfilled"?l.push({...o,partitions:a.value}):console.error(`Erreur lors de la r\xE9cup\xE9ration des partitions pour le morceau ${o.id}`,a.reason)}),R.rehearsalsCache=l}var le=oe(()=>{K();setInterval(()=>{R.currentUser&&U().catch(()=>{})},5*60*1e3)});async function _(){try{let e=await w("/me");if(R.currentUser=e,!e.needsGroup){let n=await w("/settings");X(n.darkMode),re(n.template||"classic"),document.title=`${n.groupName} \u2013 BandTrack`;let l=document.getElementById("group-name");l&&(l.textContent=n.groupName)}}catch{R.currentUser=null}}function X(e){let n=document.body;e?n.classList.add("dark"):n.classList.remove("dark")}function re(e){let n=document.body;n.classList.forEach(l=>{l.startsWith("template-")&&n.classList.remove(l)}),n.classList.add("template-"+e)}async function de(){try{await w("/logout","POST"),R.currentUser=null}catch(e){alert(e.message)}}var ue=oe(()=>{K();le()});var je=be(()=>{K();le();ue();var P=null,j="home",I=[],Z=[],q=null,H=new Date;Object.defineProperties(R,{currentUser:{get:()=>P,set:e=>P=e},currentPage:{get:()=>j,set:e=>j=e},rehearsalsCache:{get:()=>I,set:e=>I=e},groupsCache:{get:()=>Z,set:e=>Z=e},activeGroupId:{get:()=>q,set:e=>q=e},agendaDate:{get:()=>H,set:e=>H=e}});document.addEventListener("click",e=>{let n=document.getElementById("profile-menu"),l=document.getElementById("profile-btn");n&&!n.classList.contains("hidden")&&!n.contains(e.target)&&e.target!==l&&!l?.contains(e.target)&&(n.classList.add("hidden"),n.classList.remove("block","open"),l?.classList.remove("open"))});function ee(){let e=document.getElementById("profile-menu"),n=document.getElementById("profile-btn");!e||!n||(e.classList.toggle("hidden"),e.classList.toggle("block"),e.classList.toggle("open"),n.classList.toggle("open"))}function ne(){return P&&(P.membershipRole==="admin"||P.membershipRole==="moderator")}function ie(){return P&&P.membershipRole==="admin"}function te(e){if(!e)return"";let n=new Date(e);return isNaN(n)?e:n.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short",hour12:!1})}async function fe(){if(confirm("\xCAtes-vous s\xFBr de vouloir supprimer votre compte ?"))try{await w("/me","DELETE"),P=null,Q()}catch(n){alert(n.message)}}async function he(e){await w("/context","PUT",{groupId:Number(e)}),localStorage.setItem("activeGroupId",String(e)),q=Number(e),ce(),await _()}async function W(e){if(!P)return;let n=document.getElementById("group-select"),l=document.getElementById("create-group-btn"),a=document.getElementById("join-group-btn");l&&(l.onclick=()=>ye()),a&&(a.onclick=()=>Ee());try{Z=await w("/groups");let t=e||localStorage.getItem("activeGroupId");Z.some(o=>String(o.id)===String(t))||(t=Z[0]?Z[0].id:null),n&&(n.innerHTML="",Z.forEach(o=>{let c=document.createElement("option");c.value=o.id,c.textContent=o.name,n.appendChild(c)}),t&&(n.value=t),n.onchange=async()=>{await he(n.value),z(document.getElementById("app"))}),t&&await he(t)}catch(t){console.error(t)}}function ye(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let l=document.createElement("h3");l.textContent="Cr\xE9er un groupe",n.appendChild(l);let a=document.createElement("form");a.onsubmit=p=>p.preventDefault();let t=document.createElement("label");t.textContent="Nom du groupe";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%",a.appendChild(t),a.appendChild(o),n.appendChild(a);let c=document.createElement("div");c.className="modal-actions";let s=document.createElement("button");s.className="btn-secondary",s.textContent="Annuler",s.onclick=()=>e.remove();let d=document.createElement("button");d.className="btn-primary",d.textContent="Cr\xE9er",d.onclick=async()=>{let p=o.value.trim();if(p)try{let r=await w("/groups","POST",{name:p});alert("Code d'invitation : "+r.invitationCode),e.remove(),await W(r.id),z(document.getElementById("app"))}catch(r){alert(r.message)}},c.appendChild(s),c.appendChild(d),n.appendChild(c),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>o.focus(),50)}function Ee(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let l=document.createElement("h3");l.textContent="Rejoindre un groupe",n.appendChild(l);let a=document.createElement("form");a.onsubmit=i=>i.preventDefault();let t=document.createElement("label");t.textContent="Code d'invitation";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%";let c=document.createElement("label");c.textContent="Surnom";let s=document.createElement("input");s.type="text",s.style.width="100%",a.appendChild(t),a.appendChild(o),a.appendChild(c),a.appendChild(s),n.appendChild(a);let d=document.createElement("div");d.className="modal-actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Annuler",p.onclick=()=>e.remove();let r=document.createElement("button");r.className="btn-primary",r.textContent="Rejoindre",r.onclick=async()=>{let i=o.value.trim(),C=s.value.trim();if(i)try{let f=await w("/groups/join","POST",{code:i,nickname:C});e.remove(),await W(f.groupId),z(document.getElementById("app"))}catch(f){alert(f.message)}},d.appendChild(p),d.appendChild(r),n.appendChild(d),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>o.focus(),50)}async function xe(){await _(),P&&await W(),Q()}function Q(){let e=document.getElementById("app");if(P)P.needsGroup?we(e):z(e);else{let n=document.getElementById("group-name");n&&(n.textContent=""),ce(),Ne(e)}}function we(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let l=document.createElement("h2");l.textContent="Rejoindre ou cr\xE9er un groupe",n.appendChild(l);let a=document.createElement("p");a.textContent="Vous devez s\xE9lectionner ou cr\xE9er un groupe pour continuer.",n.appendChild(a);let t=document.createElement("p");t.textContent="Pour rejoindre un groupe existant, munissez-vous de son code d'invitation ou demandez \xE0 un administrateur de vous ajouter directement.",n.appendChild(t);let o=document.createElement("div"),c=document.createElement("button");c.className="btn-primary",c.textContent="Cr\xE9er un groupe",c.onclick=()=>ye(),o.appendChild(c);let s=document.createElement("button");s.className="btn-secondary",s.style.marginLeft="10px",s.textContent="Rejoindre un groupe",s.onclick=()=>Ee(),o.appendChild(s),n.appendChild(o);let d=document.createElement("button");d.id="delete-account-btn-group-setup",d.className="delete-account-btn",d.textContent="Supprimer mon compte",d.onclick=fe,n.appendChild(d),e.appendChild(n)}function Ne(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let l=!1;function a(){n.innerHTML="";let t=document.createElement("h2");t.textContent=l?"Inscription":"Connexion",n.appendChild(t);let o=document.createElement("form");o.onsubmit=async u=>{u.preventDefault(),l?await v():await y()};let c=document.createElement("label");c.textContent="Nom d\u2019utilisateur";let s=document.createElement("input");s.type="text",s.required=!0;let d=document.createElement("label");d.textContent="Mot de passe";let p=document.createElement("input");p.type="password",p.required=!0,o.appendChild(c),o.appendChild(s),o.appendChild(d),o.appendChild(p);let r;if(l){let u=document.createElement("label");u.textContent="Confirmer le mot de passe",r=document.createElement("input"),r.type="password",r.required=!0,o.appendChild(u),o.appendChild(r)}let i=document.createElement("div");i.style.color="var(--danger-color)",i.style.marginTop="12px",o.appendChild(i);let C=document.createElement("button");C.className="btn-primary",C.style.marginTop="20px",C.textContent=l?"S\u2019inscrire":"Se connecter",o.appendChild(C);let f=document.createElement("a");f.className="link",f.textContent=l?"D\xE9j\xE0 un compte ? Se connecter":"Cr\xE9er un compte",f.onclick=u=>{u.preventDefault(),l=!l,a()},n.appendChild(o),n.appendChild(f),e.appendChild(n);async function v(){let u=s.value.trim(),E=p.value,b=r?r.value:"";if(!u||!E){i.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}if(E!==b){i.textContent="Les mots de passe ne correspondent pas";return}try{await w("/register","POST",{username:u,password:E}),await _(),j="home",await W(),Q()}catch(N){i.textContent=N.message}}async function y(){let u=s.value.trim(),E=p.value;if(!u||!E){i.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}try{await w("/login","POST",{username:u,password:E}),await _(),j="home",await W(),Q()}catch(b){i.textContent=b.message}}}a()}async function ke(e){e.innerHTML="";let n=document.createElement("div");n.className="home-container",e.appendChild(n);let l=document.createElement("p"),a=P?P.username:"";l.appendChild(document.createTextNode("Salut "));let t=document.createElement("strong");t.textContent=a,l.appendChild(t),l.appendChild(document.createTextNode(", voici o\xF9 en est votre groupe aujourd'hui...")),n.appendChild(l);let o="Aucune prestation pr\xE9vue";try{let i=await w("/performances"),C=new Date,f=i.filter(v=>new Date(v.date)>=C);if(f.sort((v,y)=>new Date(v.date)-new Date(y.date)),f.length>0){let v=f[0];o=`${v.name} (${te(v.date)})`}}catch{o="Impossible de r\xE9cup\xE9rer les prestations"}let c=document.createElement("p"),s=document.createElement("strong");s.textContent="Prochaine prestation :",c.appendChild(s),c.appendChild(document.createTextNode(" "+o)),n.appendChild(c);let d="\u2014";try{let C=(await w("/agenda")).filter(y=>y.type==="rehearsal"),f=new Date,v=C.filter(y=>new Date(y.date)>=f);if(v.sort((y,u)=>new Date(y.date)-new Date(u.date)),v.length>0){let y=v[0];d=`${te(y.date)}${y.location?" \u2013 "+y.location:""}`}}catch{}let p=document.createElement("p"),r=document.createElement("strong");r.textContent="Prochaine r\xE9p\xE9tition :",p.appendChild(r),p.appendChild(document.createTextNode(" "+d)),n.appendChild(p)}async function z(e){e.innerHTML="";let n=document.getElementById("profile-btn"),l=document.getElementById("profile-menu"),a=document.getElementById("menu-performances"),t=document.getElementById("menu-settings"),o=document.getElementById("menu-logout"),c=document.getElementById("theme-toggle");n&&l&&(n.onclick=r=>{r.stopPropagation(),ee()}),c&&(c.textContent=document.body.classList.contains("dark")?"\u2600\uFE0F":"\u{1F319}",c.onclick=async()=>{document.body.classList.toggle("dark");let r=document.body.classList.contains("dark");c.textContent=r?"\u2600\uFE0F":"\u{1F319}";try{let C={...await w("/settings"),darkMode:r};await w("/settings","PUT",C),X(C.darkMode)}catch(i){console.error(i)}}),a&&(a.onclick=()=>{j!=="performances"&&(j="performances",z(e)),l?.classList.contains("hidden")||ee()}),t&&(t.onclick=()=>{j!=="settings"&&(j="settings",z(e)),l?.classList.contains("hidden")||ee()}),o&&(o.onclick=async()=>{l?.classList.contains("hidden")||ee(),await de()});let s=document.createElement("div");s.className="page",e.appendChild(s);let d=document.createElement("div");if(d.className="nav-bar",[{key:"home",label:"Home",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>'},{key:"suggestions",label:"Suggestions",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"/></svg>'},{key:"rehearsals",label:"R\xE9p\xE8tes",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"/></svg>'},{key:"performances",label:"Prestations",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>'},{key:"agenda",label:"Agenda",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z"/></svg>'}].forEach(r=>{let i=document.createElement("button");i.innerHTML=`${r.icon}<span>${r.label}</span>`,i.className=j===r.key?"active":"",i.onclick=()=>{j!==r.key&&(j=r.key,z(e))},d.appendChild(i)}),e.appendChild(d),j==="home")ke(s);else if(j==="suggestions")F(s);else if(j==="rehearsals"){try{await U()}catch{}Y(s)}else if(j==="performances"){try{await U()}catch{}ae(s)}else if(j==="agenda"){try{await U()}catch{}G(s)}else j==="settings"&&J(s)}async function F(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux sugg\xE9r\xE9s",n.className="section-title",e.appendChild(n);let l=[];try{l=await w("/suggestions")}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les suggestions",e.appendChild(o);return}if(l.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucune proposition pour l\u2019instant",e.appendChild(t)}l.forEach(t=>{let o=document.createElement("div");o.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-pink-50";let c=document.createElement("div");c.className="card-header";let s=document.createElement("h3");s.textContent=t.title,s.onclick=()=>{o.classList.toggle("collapsed")},c.appendChild(s);let d=document.createElement("div");d.className="like-info";let p=document.createElement("span");p.textContent=`\u2764\uFE0F ${t.likes||0}`;let r=document.createElement("button");r.className="like-btn",r.textContent="\u{1F44D}",r.onclick=async y=>{y.stopPropagation(),r.disabled=!0,i.disabled=!0;try{let u=await w(`/suggestions/${t.id}/vote`,"POST");p.textContent=`\u2764\uFE0F ${u.likes}`,await F(e)}catch(u){alert(u.message),r.disabled=!1,i.disabled=!1}};let i=document.createElement("button");i.className="like-btn",i.textContent="\u{1F44E}",i.onclick=async y=>{y.stopPropagation(),r.disabled=!0,i.disabled=!0;try{let u=await w(`/suggestions/${t.id}/vote`,"DELETE");p.textContent=`\u2764\uFE0F ${u.likes}`,await F(e)}catch(u){alert(u.message),r.disabled=!1,i.disabled=!1}},d.appendChild(p),d.appendChild(r),d.appendChild(i),c.appendChild(d),o.appendChild(c);let C=document.createElement("div");if(C.className="card-details",t.author){let y=document.createElement("p");y.style.fontStyle="italic",y.textContent="Auteur : "+t.author,C.appendChild(y)}if(t.versionOf){let y=document.createElement("p");y.style.fontStyle="italic",y.textContent="Version de : "+t.versionOf,C.appendChild(y)}let f=t.youtube||t.url;if(f){let y=document.createElement("a");y.href=f,y.target="_blank",y.rel="noopener noreferrer",y.textContent=f,C.appendChild(y)}let v=document.createElement("p");if(v.style.fontSize="12px",v.style.color="var(--text-color)",v.textContent=`Ajout\xE9 par ${t.creator}`,C.appendChild(v),P&&(ne()||t.creatorId===P.id||t.creator===P.username)){let y=document.createElement("div");y.className="actions";let u=document.createElement("button");u.className="btn-secondary",u.textContent="Modifier",u.onclick=N=>{N.stopPropagation(),Le(t,e)},y.appendChild(u);let E=document.createElement("button");E.className="btn-primary",E.textContent="Passer en r\xE9p\xE9tition",E.onclick=async N=>{N.stopPropagation();try{let k=await w(`/suggestions/${t.id}/to-rehearsal`,"POST");I.push(k),F(e)}catch(k){alert(k.message)}},y.appendChild(E);let b=document.createElement("button");b.className="btn-danger",b.textContent="Supprimer",b.onclick=async N=>{if(N.stopPropagation(),!!confirm("Supprimer cette suggestion ?"))try{await w(`/suggestions/${t.id}`,"DELETE"),F(e)}catch(k){alert(k.message)}},y.appendChild(b),C.appendChild(y)}o.appendChild(C),e.appendChild(o)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau",a.textContent="+",a.onclick=()=>Te(e),e.appendChild(a)}function Te(e){let n=document.createElement("div");n.className="modal";let l=document.createElement("div");l.className="modal-content";let a=document.createElement("h3");a.textContent="Ajouter une suggestion",l.appendChild(a);let t=document.createElement("form");t.onsubmit=u=>{u.preventDefault()};let o=document.createElement("label");o.textContent="Titre";let c=document.createElement("input");c.type="text",c.required=!0,c.style.width="100%";let s=document.createElement("label");s.textContent="Auteur";let d=document.createElement("input");d.type="text",d.style.width="100%";let p=document.createElement("label");p.textContent="Version de";let r=document.createElement("input");r.type="text",r.style.width="100%";let i=document.createElement("label");i.textContent="Lien YouTube";let C=document.createElement("input");C.type="url",C.style.width="100%",t.appendChild(o),t.appendChild(c),t.appendChild(s),t.appendChild(d),t.appendChild(p),t.appendChild(r),t.appendChild(i),t.appendChild(C),l.appendChild(t);let f=document.createElement("div");f.className="modal-actions";let v=document.createElement("button");v.className="btn-secondary",v.textContent="Annuler",v.onclick=()=>{n.parentNode&&n.parentNode.removeChild(n)};let y=document.createElement("button");y.className="btn-primary",y.textContent="Ajouter",y.onclick=async u=>{u.preventDefault();let E=c.value.trim(),b=d.value.trim(),N=r.value.trim(),k=C.value.trim();if(E)try{await w("/suggestions","POST",{title:E,author:b,youtube:k,versionOf:N}),n.parentNode&&n.parentNode.removeChild(n),F(e)}catch(B){alert(B.message)}},f.appendChild(v),f.appendChild(y),l.appendChild(f),n.appendChild(l),document.body.appendChild(n),setTimeout(()=>c.focus(),50)}function Le(e,n){let l=document.createElement("div");l.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Modifier la suggestion",a.appendChild(t);let o=document.createElement("form");o.onsubmit=E=>E.preventDefault();let c=document.createElement("label");c.textContent="Titre";let s=document.createElement("input");s.type="text",s.required=!0,s.style.width="100%",s.value=e.title;let d=document.createElement("label");d.textContent="Auteur";let p=document.createElement("input");p.type="text",p.style.width="100%",p.value=e.author||"";let r=document.createElement("label");r.textContent="Version de";let i=document.createElement("input");i.type="text",i.style.width="100%",i.value=e.versionOf||"";let C=document.createElement("label");C.textContent="Lien YouTube";let f=document.createElement("input");f.type="url",f.style.width="100%",f.value=e.youtube||e.url||"",o.appendChild(c),o.appendChild(s),o.appendChild(d),o.appendChild(p),o.appendChild(r),o.appendChild(i),o.appendChild(C),o.appendChild(f),a.appendChild(o);let v=document.createElement("div");v.className="modal-actions";let y=document.createElement("button");y.className="btn-secondary",y.textContent="Annuler",y.onclick=()=>{l.parentNode&&l.parentNode.removeChild(l)};let u=document.createElement("button");u.className="btn-primary",u.textContent="Enregistrer",u.onclick=async E=>{E.preventDefault();let b=s.value.trim(),N=p.value.trim(),k=i.value.trim(),B=f.value.trim();if(b)try{await w(`/suggestions/${e.id}`,"PUT",{title:b,author:N,versionOf:k,youtube:B}),l.parentNode&&l.parentNode.removeChild(l),F(n)}catch(S){alert(S.message)}},v.appendChild(y),v.appendChild(u),a.appendChild(v),l.appendChild(a),document.body.appendChild(l),setTimeout(()=>s.focus(),50)}async function Y(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux en cours de travail",n.className="section-title",e.appendChild(n);let l=I;if(l.length===0)try{await U(),l=I}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les r\xE9p\xE9titions",e.appendChild(o);return}if(l.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucun morceau en r\xE9p\xE9tition",e.appendChild(t)}l.forEach(t=>{let o=document.createElement("div");o.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-blue-50";let c=t.levels[P.username]!=null?t.levels[P.username]:0,s=document.createElement("div");s.className="card-header";let d=document.createElement("h3");d.textContent=t.title,d.onclick=()=>{o.classList.toggle("collapsed")},s.appendChild(d);let p=document.createElement("span");p.className="level-badge",p.textContent=c,s.appendChild(p),o.appendChild(s);let r=document.createElement("div");if(r.className="card-details",t.author){let h=document.createElement("p");h.style.fontStyle="italic",h.textContent="Auteur : "+t.author,r.appendChild(h)}if(t.youtube){let h=document.createElement("a");h.href=t.youtube,h.target="_blank",h.rel="noopener noreferrer",h.textContent=t.youtube,r.appendChild(h)}let i=document.createElement("div");i.style.marginTop="8px";let C=document.createElement("label");C.textContent=`Votre niveau (${c}/10)`,C.className="level-display";let f=document.createElement("input");f.type="range",f.min=0,f.max=10,f.step=1,f.value=c;function v(h){let L=h/10,T=Math.round(255*(1-L)),m=Math.round(255*L);f.style.background=`linear-gradient(to right, rgb(${T},${m},80) ${h/10*100}%, var(--border-color) ${h/10*100}%)`}v(c),f.oninput=async()=>{let h=Number(f.value);C.textContent=`Votre niveau (${h}/10)`,p.textContent=h,v(h);try{await w(`/rehearsals/${t.id}`,"PUT",{level:h})}catch(L){alert(L.message)}},i.appendChild(C),i.appendChild(f),r.appendChild(i);let y=document.createElement("label");y.textContent="Vos notes";let u=document.createElement("textarea");u.value=t.notes&&t.notes[P.username]||"",u.onchange=async()=>{try{await w(`/rehearsals/${t.id}`,"PUT",{note:u.value})}catch(h){alert(h.message)}},r.appendChild(y),r.appendChild(u);let E=document.createElement("div");E.style.marginTop="8px",(t.audioNotes&&t.audioNotes[P.username]||[]).forEach((h,L)=>{let T=document.createElement("div");if(h.title){let x=document.createElement("div");x.textContent=h.title,T.appendChild(x)}let m=document.createElement("audio");m.controls=!0,m.src=h.audio,T.appendChild(m);let g=document.createElement("button");g.className="btn-danger",g.textContent="Supprimer audio",g.style.marginLeft="8px",g.onclick=async x=>{if(x.preventDefault(),!!confirm("Supprimer la note audio\xA0?"))try{await w(`/rehearsals/${t.id}`,"PUT",{audioIndex:L}),Y(e)}catch(D){alert(D.message)}},T.appendChild(g),E.appendChild(T)});let N=document.createElement("input");N.type="text",N.placeholder="Titre de la note",N.style.display="block",N.style.marginTop="8px";let k=document.createElement("input");k.type="file",k.accept="audio/*",k.style.display="none";let B=document.createElement("button");if(B.className="btn-secondary",B.textContent="Ajouter une note audio",B.onclick=h=>{h.preventDefault(),k.click()},k.onchange=async()=>{let h=k.files[0];if(!h)return;if(h.size>5*1024*1024){alert("Le fichier audio est trop volumineux (max 5\xA0Mo).");return}let L=new FileReader;L.onload=async T=>{let m=(T.target?.result||"").toString();try{await w(`/rehearsals/${t.id}`,"PUT",{audio:m,audioTitle:N.value}),Y(e)}catch(g){alert(g.message)}},L.readAsDataURL(h)},E.appendChild(N),E.appendChild(B),E.appendChild(k),r.appendChild(E),P){let h=document.createElement("div");h.style.marginTop="8px";let L=document.createElement("label");L.textContent="Partition(s)",h.appendChild(L);let T=document.createElement("div");(t.partitions||[]).forEach(x=>{let D=document.createElement("div"),A=document.createElement("span");A.textContent=`${x.displayName} \u2013 ${x.uploader} \u2013 ${te(x.date)}`,D.appendChild(A);let $=document.createElement("a");if($.href=x.downloadUrl,$.textContent="T\xE9l\xE9charger",$.target="_blank",$.rel="noopener noreferrer",$.className="btn-secondary",$.style.marginLeft="8px",D.appendChild($),x.uploader===P.username||ie()){let M=document.createElement("button");M.className="btn-danger",M.textContent="Supprimer",M.style.marginLeft="8px",M.onclick=async V=>{if(V.preventDefault(),!!confirm("Supprimer cette partition\xA0?"))try{await me(t.id,x.id),await U(),Y(e)}catch(O){alert(O.message)}},D.appendChild(M)}T.appendChild(D)}),h.appendChild(T);let m=document.createElement("input");m.type="file",m.accept="application/pdf",m.style.display="none";let g=document.createElement("button");g.className="btn-secondary",g.textContent="D\xE9poser une partition",g.onclick=x=>{x.preventDefault(),m.click()},m.onchange=async()=>{let x=m.files[0];if(x)try{await pe(t.id,x,x.name),await U(),Y(e)}catch(D){alert(D.message)}},h.appendChild(g),h.appendChild(m),r.appendChild(h)}let S=Object.keys(t.levels||{}).filter(h=>h.toLowerCase()!==P.username.toLowerCase());if(S.length>0){let h=document.createElement("div");h.style.marginTop="12px";let L=document.createElement("p");L.textContent="Autres membres :",L.style.fontStyle="italic",h.appendChild(L),S.forEach(T=>{let m=document.createElement("div");m.style.marginBottom="4px";let g=t.levels[T],x=t.notes&&t.notes[T]?t.notes[T]:"",D=document.createElement("p");D.style.margin="0";let A=document.createElement("strong");A.textContent=T,D.appendChild(A),D.appendChild(document.createTextNode(` \u2013 Niveau ${g}/10${x?" \u2013 "+x:""}`)),m.appendChild(D),(t.audioNotes&&t.audioNotes[T]||[]).forEach(M=>{let V=document.createElement("audio");if(V.controls=!0,V.src=M.audio,V.style.display="block",V.style.marginTop="4px",M.title){let O=document.createElement("div");O.textContent=M.title,O.style.marginTop="4px",m.appendChild(O)}m.appendChild(V)}),h.appendChild(m)}),r.appendChild(h)}if(P&&(ne()||P.id===t.creatorId)){let h=document.createElement("div");h.className="actions";let L=document.createElement("button");L.className="btn-secondary",L.textContent="Modifier",L.onclick=g=>{g.stopPropagation(),De(t,e)},h.appendChild(L);let T=document.createElement("button");T.className="btn-primary",T.textContent="Remettre dans J\u2019aime",T.onclick=async g=>{g.stopPropagation();try{await w(`/rehearsals/${t.id}/to-suggestion`,"POST"),Y(e)}catch(x){alert(x.message)}},h.appendChild(T);let m=document.createElement("button");m.className="btn-danger",m.textContent="Supprimer",m.onclick=async g=>{if(g.stopPropagation(),!!confirm("Supprimer ce morceau ?"))try{await w(`/rehearsals/${t.id}`,"DELETE"),I=I.filter(x=>x.id!==t.id),Y(e)}catch(x){alert(x.message)}},h.appendChild(m),r.appendChild(h)}o.appendChild(r),e.appendChild(o)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau en r\xE9p\xE9tition",a.textContent="+",a.onclick=()=>Se(e),e.appendChild(a)}function Se(e,n){let l=document.createElement("div");l.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Ajouter un morceau",a.appendChild(t);let o=document.createElement("form");o.onsubmit=N=>N.preventDefault();let c=document.createElement("label");c.textContent="Titre";let s=document.createElement("input");s.type="text",s.required=!0,s.style.width="100%";let d=document.createElement("label");d.textContent="Auteur";let p=document.createElement("input");p.type="text",p.style.width="100%";let r=document.createElement("label");r.textContent="Lien YouTube";let i=document.createElement("input");i.type="url",i.style.width="100%";let C=document.createElement("label");C.textContent="Lien Spotify";let f=document.createElement("input");f.type="url",f.style.width="100%";let v=document.createElement("label");v.textContent="Version de";let y=document.createElement("input");y.type="text",y.style.width="100%",o.appendChild(c),o.appendChild(s),o.appendChild(d),o.appendChild(p),o.appendChild(r),o.appendChild(i),o.appendChild(C),o.appendChild(f),o.appendChild(v),o.appendChild(y),a.appendChild(o);let u=document.createElement("div");u.className="modal-actions";let E=document.createElement("button");E.className="btn-secondary",E.textContent="Annuler",E.onclick=()=>{l.parentNode&&l.parentNode.removeChild(l)};let b=document.createElement("button");b.className="btn-primary",b.textContent="Ajouter",b.onclick=async N=>{N.preventDefault();let k=s.value.trim();if(!k)return;let B=p.value.trim(),S=i.value.trim(),h=f.value.trim(),L=y.value.trim();try{let T=await w("/rehearsals","POST",{title:k,author:B,youtube:S,spotify:h,versionOf:L});l.parentNode&&l.parentNode.removeChild(l),I.push(T),typeof n=="function"?n():Y(e)}catch(T){alert(T.message)}},u.appendChild(E),u.appendChild(b),a.appendChild(u),l.appendChild(a),document.body.appendChild(l),setTimeout(()=>s.focus(),50)}function De(e,n,l){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier le morceau",t.appendChild(o);let c=document.createElement("form");c.onsubmit=k=>k.preventDefault();let s=document.createElement("label");s.textContent="Titre";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.title;let p=document.createElement("label");p.textContent="Auteur";let r=document.createElement("input");r.type="text",r.style.width="100%",r.value=e.author||"";let i=document.createElement("label");i.textContent="Lien YouTube";let C=document.createElement("input");C.type="url",C.style.width="100%",C.value=e.youtube||"";let f=document.createElement("label");f.textContent="Lien Spotify";let v=document.createElement("input");v.type="url",v.style.width="100%",v.value=e.spotify||"";let y=document.createElement("label");y.textContent="Version de";let u=document.createElement("input");u.type="text",u.style.width="100%",u.value=e.versionOf||"",c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(r),c.appendChild(i),c.appendChild(C),c.appendChild(f),c.appendChild(v),c.appendChild(y),c.appendChild(u),t.appendChild(c);let E=document.createElement("div");E.className="modal-actions";let b=document.createElement("button");b.className="btn-secondary",b.textContent="Annuler",b.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let N=document.createElement("button");N.className="btn-primary",N.textContent="Enregistrer",N.onclick=async k=>{k.preventDefault();let B=d.value.trim(),S=r.value.trim(),h=C.value.trim(),L=v.value.trim(),T=u.value.trim();if(B)try{await w(`/rehearsals/${e.id}`,"PUT",{title:B,author:S,youtube:h,spotify:L,versionOf:T}),a.parentNode&&a.parentNode.removeChild(a);let m=I.findIndex(g=>g.id===e.id);m!==-1&&(I[m]={...I[m],title:B,author:S||null,youtube:h||null,spotify:L||null,versionOf:T||null}),typeof l=="function"?l():Y(n)}catch(m){alert(m.message)}},E.appendChild(b),E.appendChild(N),t.appendChild(E),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function ae(e){e.innerHTML="";let n=document.createElement("h2");n.className="section-title",n.textContent="Prestations",e.appendChild(n);let l=[];try{l=await w("/performances")}catch{let p=document.createElement("p");p.style.color="var(--danger-color)",p.textContent="Impossible de r\xE9cup\xE9rer les prestations",e.appendChild(p);return}if(I.length===0)try{await U()}catch{}let a=new Date,t=l.filter(d=>new Date(d.date)>=a),o=l.filter(d=>new Date(d.date)<a);function c(d,p){let r=document.createElement("div");if(r.className="section-title",r.textContent=d,e.appendChild(r),p.length===0){let i=document.createElement("p");i.textContent="Aucune prestation",e.appendChild(i);return}p.forEach(i=>{let C=document.createElement("div");C.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-green-50";let f=document.createElement("h3");f.textContent=i.name,f.onclick=()=>{C.classList.toggle("collapsed")},C.appendChild(f);let v=document.createElement("div");v.className="card-details";let y=document.createElement("p");if(y.textContent="Date : "+te(i.date),v.appendChild(y),i.location){let u=document.createElement("p");u.textContent="Lieu : "+i.location,v.appendChild(u)}if(i.songs&&i.songs.length>0){let u=document.createElement("ul");i.songs.forEach(E=>{let b=I.find(k=>k.id===E),N=document.createElement("li");N.textContent=b?b.title:"\u2014",u.appendChild(N)}),v.appendChild(u)}if(P&&(ne()||P.id===i.creatorId)){let u=document.createElement("div");u.className="actions";let E=document.createElement("button");E.className="btn-secondary",E.textContent="Modifier",E.onclick=N=>{N.stopPropagation(),ve(i,e)},u.appendChild(E);let b=document.createElement("button");b.className="btn-danger",b.textContent="Supprimer",b.onclick=async N=>{if(N.stopPropagation(),!!confirm("Supprimer cette prestation ?"))try{await w(`/performances/${i.id}`,"DELETE"),ae(e)}catch(k){alert(k.message)}},u.appendChild(b),v.appendChild(u)}C.appendChild(v),e.appendChild(C)})}c("\xC0 venir",t),c("Pass\xE9es",o);let s=document.createElement("div");s.className="fab",s.title="Ajouter une prestation",s.textContent="+",s.onclick=()=>se(e),e.appendChild(s)}async function G(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Agenda",n.className="section-title",e.appendChild(n);let l=document.createElement("div");l.className="calendar-nav";let a=document.createElement("button");a.textContent="<",a.onclick=()=>{H.setMonth(H.getMonth()-1),G(e)};let t=document.createElement("button");t.textContent=">",t.onclick=()=>{H.setMonth(H.getMonth()+1),G(e)};let o=document.createElement("span");o.textContent=H.toLocaleDateString(void 0,{month:"long",year:"numeric"}),l.appendChild(a),l.appendChild(o),l.appendChild(t),e.appendChild(l);let c=document.createElement("div");c.className="actions";let s=document.createElement("button");s.className="btn-secondary",s.textContent="Nouvelle r\xE9p\xE9tition",s.onclick=()=>Ce(e,()=>G(e));let d=document.createElement("button");d.className="btn-secondary",d.textContent="Nouvelle prestation",d.onclick=()=>se(e,()=>G(e)),c.appendChild(s),c.appendChild(d),e.appendChild(c);let p=[];try{let E=H.getFullYear(),b=H.getMonth()+1,N=String(b).padStart(2,"0"),k=`${E}-${N}-01`,B=`${E}-${N}-31`;p=await w(`/agenda?start=${k}&end=${B}`)}catch{let b=document.createElement("p");b.style.color="var(--danger-color)",b.textContent="Impossible de r\xE9cup\xE9rer l'agenda",e.appendChild(b);return}p.sort((E,b)=>E.date.localeCompare(b.date));let r=document.createElement("div");r.className="calendar-grid",["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(E=>{let b=document.createElement("div");b.className="calendar-day-name",b.textContent=E,r.appendChild(b)});let C=H.getFullYear(),f=H.getMonth(),y=(new Date(C,f,1).getDay()+6)%7;for(let E=0;E<y;E++){let b=document.createElement("div");b.className="calendar-cell empty",r.appendChild(b)}let u=new Date(C,f+1,0).getDate();for(let E=1;E<=u;E++){let b=document.createElement("div");b.className="calendar-cell";let N=document.createElement("div");N.className="calendar-date",N.textContent=E,b.appendChild(N);let k=`${C}-${String(f+1).padStart(2,"0")}-${String(E).padStart(2,"0")}`,B=p.filter(S=>S.date?.startsWith(k));B.forEach(S=>{let h=document.createElement("div");h.className=`calendar-event ${S.type==="performance"?"performance":"rehearsal"}`;let L=S.title||S.location||"",T=S.type==="performance"?"Prestation":"R\xE9p\xE9tition";h.textContent=L||T,h.onclick=async m=>{if(m.preventDefault(),m.stopPropagation(),S.type==="performance")try{I.length===0&&await U();let x=(await w("/performances")).find(D=>D.id===S.id);x&&ve(x,e,()=>G(e))}catch(g){alert(g.message)}else Be(S,e,()=>G(e))},b.appendChild(h)}),B.length===0&&(b.onclick=async()=>{if(!ne())return;if(confirm("Ajouter une prestation ? (Annuler pour une r\xE9p\xE9tition)")){try{I.length===0&&await U()}catch{}se(e,()=>G(e),k)}else Ce(e,()=>G(e),`${k}T20:00`)}),r.appendChild(b)}e.appendChild(r)}function Ce(e,n,l){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter une r\xE9p\xE9tition",t.appendChild(o);let c=document.createElement("form");c.onsubmit=v=>v.preventDefault();let s=document.createElement("label");s.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",l&&(d.value=l);let p=document.createElement("label");p.textContent="Lieu";let r=document.createElement("input");r.type="text",r.style.width="100%",c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(r),t.appendChild(c);let i=document.createElement("div");i.className="modal-actions";let C=document.createElement("button");C.className="btn-secondary",C.textContent="Annuler",C.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let f=document.createElement("button");f.className="btn-primary",f.textContent="Ajouter",f.onclick=async v=>{v.preventDefault();let y=d.value;if(!y)return;let u=r.value.trim();try{await w("/agenda","POST",{type:"rehearsal",date:y,location:u}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"&&n()}catch(E){alert(E.message)}},i.appendChild(C),i.appendChild(f),t.appendChild(i),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function se(e,n,l){try{await U()}catch(k){alert(k.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter une prestation",t.appendChild(o);let c=document.createElement("form");c.onsubmit=k=>k.preventDefault();let s=document.createElement("label");s.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%";let p=document.createElement("label");p.textContent="Date";let r=document.createElement("input");r.type="date",r.required=!0,r.style.width="100%",l&&(r.value=l);let i=document.createElement("label");i.textContent="Heure";let C=document.createElement("input");C.type="time",C.required=!0,C.style.width="100%";let f=document.createElement("label");f.textContent="Lieu";let v=document.createElement("input");v.type="text",v.style.width="100%";let y=document.createElement("label");y.textContent="Morceaux jou\xE9s";let u=document.createElement("div");u.className="select-list",I.forEach(k=>{let B=document.createElement("label");B.style.display="flex",B.style.justifyContent="space-between",B.style.alignItems="center";let S=document.createElement("input");S.type="checkbox",S.value=k.id;let h=document.createElement("span");h.textContent=k.title,h.style.marginLeft="4px";let L=document.createElement("span");L.appendChild(S),L.appendChild(h);let T=document.createElement("span");T.className="level-badge";let m=Object.values(k.levels||{}).map(Number),g=m.length>0?m.reduce((x,D)=>x+D,0)/m.length:0;T.textContent=g.toFixed(1),B.appendChild(L),B.appendChild(T),u.appendChild(B)}),c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(r),c.appendChild(i),c.appendChild(C),c.appendChild(f),c.appendChild(v),c.appendChild(y),c.appendChild(u),t.appendChild(c);let E=document.createElement("div");E.className="modal-actions";let b=document.createElement("button");b.className="btn-secondary",b.textContent="Annuler",b.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let N=document.createElement("button");N.className="btn-primary",N.textContent="Ajouter",N.onclick=async k=>{k.preventDefault();let B=d.value.trim(),S=r.value,h=C.value,L=v.value.trim();if(!B||!S||!h)return;let T=`${S}T${h}`,m=[];u.querySelectorAll('input[type="checkbox"]').forEach(x=>{x.checked&&m.push(Number(x.value))});let g=!1;for(let x of m){let D=I.find(A=>A.id===x);if(D){let A=Object.values(D.levels||{}).map(Number);if((A.length?Math.min(...A):0)<=6){g=!0;break}}}if(!(g&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Ajouter quand m\xEAme ?")))try{await w("/performances","POST",{name:B,date:T,location:L,songs:m}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"?n():ae(e)}catch(x){alert(x.message)}},E.appendChild(b),E.appendChild(N),t.appendChild(E),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Be(e,n,l){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la r\xE9p\xE9tition",t.appendChild(o);let c=document.createElement("form");c.onsubmit=v=>v.preventDefault();let s=document.createElement("label");s.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",d.value=e.date||"";let p=document.createElement("label");p.textContent="Lieu";let r=document.createElement("input");r.type="text",r.style.width="100%",r.value=e.location||"",c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(r),t.appendChild(c);let i=document.createElement("div");i.className="modal-actions";let C=document.createElement("button");C.className="btn-secondary",C.textContent="Annuler",C.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let f=document.createElement("button");f.className="btn-primary",f.textContent="Enregistrer",f.onclick=async v=>{v.preventDefault();let y=d.value;if(!y)return;let u=r.value.trim();try{await w(`/agenda/${e.id}`,"PUT",{type:"rehearsal",date:y,location:u}),a.parentNode&&a.parentNode.removeChild(a),typeof l=="function"&&l()}catch(E){alert(E.message)}},i.appendChild(C),i.appendChild(f),t.appendChild(i),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function ve(e,n,l){try{await U()}catch(S){alert(S.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la prestation",t.appendChild(o);let c=document.createElement("form");c.onsubmit=S=>S.preventDefault();let s=document.createElement("label");s.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.name;let p=document.createElement("label");p.textContent="Date";let r=document.createElement("input");r.type="date",r.required=!0,r.style.width="100%";let[i,C]=(e.date||"").split("T");r.value=i;let f=document.createElement("label");f.textContent="Heure";let v=document.createElement("input");v.type="time",v.required=!0,v.style.width="100%",v.value=(C||"").slice(0,5);let y=document.createElement("label");y.textContent="Lieu";let u=document.createElement("input");u.type="text",u.style.width="100%",u.value=e.location||"";let E=document.createElement("label");E.textContent="Morceaux jou\xE9s";let b=document.createElement("div");b.className="select-list",I.forEach(S=>{let h=document.createElement("label");h.style.display="flex",h.style.justifyContent="space-between",h.style.alignItems="center";let L=document.createElement("input");L.type="checkbox",L.value=S.id,e.songs.includes(S.id)&&(L.checked=!0);let T=document.createElement("span");T.textContent=S.title,T.style.marginLeft="4px";let m=document.createElement("span");m.appendChild(L),m.appendChild(T);let g=document.createElement("span");g.className="level-badge";let x=Object.values(S.levels||{}).map(Number),D=x.length>0?x.reduce((A,$)=>A+$,0)/x.length:0;g.textContent=D.toFixed(1),h.appendChild(m),h.appendChild(g),b.appendChild(h)}),c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(r),c.appendChild(f),c.appendChild(v),c.appendChild(y),c.appendChild(u),c.appendChild(E),c.appendChild(b),t.appendChild(c);let N=document.createElement("div");N.className="modal-actions";let k=document.createElement("button");k.className="btn-secondary",k.textContent="Annuler",k.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let B=document.createElement("button");B.className="btn-primary",B.textContent="Enregistrer",B.onclick=async S=>{S.preventDefault();let h=d.value.trim(),L=r.value,T=v.value,m=u.value.trim();if(!h||!L||!T)return;let g=`${L}T${T}`,x=[];b.querySelectorAll('input[type="checkbox"]').forEach(A=>{A.checked&&x.push(Number(A.value))});let D=!1;for(let A of x){let $=I.find(M=>M.id===A);if($){let M=Object.values($.levels||{}).map(Number);if((M.length?Math.min(...M):0)<=6){D=!0;break}}}if(!(D&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Enregistrer quand m\xEAme ?")))try{await w(`/performances/${e.id}`,"PUT",{name:h,date:g,location:m,songs:x}),a.parentNode&&a.parentNode.removeChild(a),typeof l=="function"?l():ae(n)}catch(A){alert(A.message)}},N.appendChild(k),N.appendChild(B),t.appendChild(N),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Pe(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let l=document.createElement("h3");l.textContent="Groupes",n.appendChild(l);let a=document.createElement("select");a.id="group-select",n.appendChild(a);let t=document.createElement("div");t.style.marginTop="10px";let o=document.createElement("button");o.id="create-group-btn",o.className="btn-secondary",o.textContent="Cr\xE9er",t.appendChild(o);let c=document.createElement("button");c.id="join-group-btn",c.className="btn-secondary",c.textContent="Rejoindre",c.style.marginLeft="8px",t.appendChild(c);let s=document.createElement("button");if(s.id="rename-group-btn",s.className="btn-secondary",s.textContent="Renommer",s.style.marginLeft="8px",s.onclick=async()=>{let d=prompt("Nouveau nom du groupe",e.groupName);if(!d||d.trim()===""||d===e.groupName)return;let p=d.trim(),r=e.id||P.groupId;try{await w(`/groups/${r}`,"PUT",{name:p}),e.groupName=p,document.title=`${e.groupName} \u2013 BandTrack`;let i=document.getElementById("group-name");i&&(i.textContent=e.groupName),await W(r),await J(document.getElementById("app"))}catch(i){alert(i.message)}},t.appendChild(s),n.appendChild(t),ie()){let d=document.createElement("div");d.style.marginTop="8px";let p=e.invitationCode,r=document.createElement("span");r.textContent=`Code d'invitation : ${p}`,d.appendChild(r);let i=document.createElement("button");i.textContent="Copier",i.style.marginLeft="8px",i.onclick=()=>navigator.clipboard.writeText(p),d.appendChild(i);let C=document.createElement("button");C.textContent="Renouveler",C.style.marginLeft="8px",C.onclick=async()=>{try{p=(await w("/groups/renew-code","POST")).invitationCode,r.textContent=`Code d'invitation : ${p}`}catch(f){alert(f.message)}},d.appendChild(C),n.appendChild(d)}return n}function Ae(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");n.textContent="Mot de passe",e.appendChild(n);let l=document.createElement("form");l.onsubmit=p=>p.preventDefault();let a=document.createElement("label");a.textContent="Mot de passe actuel";let t=document.createElement("input");t.type="password",t.required=!0,t.style.width="100%";let o=document.createElement("label");o.textContent="Nouveau mot de passe";let c=document.createElement("input");c.type="password",c.required=!0,c.style.width="100%";let s=document.createElement("button");s.className="btn-primary",s.type="submit",s.textContent="Modifier",s.style.marginTop="8px";let d=document.createElement("p");return d.style.marginTop="8px",l.appendChild(a),l.appendChild(t),l.appendChild(o),l.appendChild(c),l.appendChild(s),l.appendChild(d),l.onsubmit=async p=>{p.preventDefault(),d.textContent="";try{await w("/password","PUT",{oldPassword:t.value,newPassword:c.value}),d.style.color="green",d.textContent="Mot de passe mis \xE0 jour",t.value="",c.value=""}catch(r){d.style.color="var(--danger-color)",d.textContent=r.message}},e.appendChild(l),e}function Me(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let l=document.createElement("h3");l.textContent="Th\xE8me",n.appendChild(l);let a=document.createElement("div"),t=document.createElement("label");t.textContent="Mode sombre",t.style.marginRight="8px";let o=document.createElement("input");o.type="checkbox",o.checked=e.darkMode,o.onchange=async()=>{e.darkMode=o.checked;try{await w("/settings","PUT",e),X(o.checked)}catch(r){alert(r.message)}},a.appendChild(t),a.appendChild(o),n.appendChild(a);let c=document.createElement("div");c.style.marginTop="20px";let s=document.createElement("label");s.textContent="Template (design)",s.style.marginRight="8px";let d=document.createElement("select");return[{value:"classic",label:"Classique"},{value:"groove",label:"Groove"},{value:"violet",label:"Violet"},{value:"imgbg",label:"Image"}].forEach(r=>{let i=document.createElement("option");i.value=r.value,i.textContent=r.label,d.appendChild(i)}),d.value=e.template||"classic",d.onchange=async()=>{let r=d.value;e.template=r;try{await w("/settings","PUT",e),re(r)}catch(i){alert(i.message)}},c.appendChild(s),c.appendChild(d),n.appendChild(c),n}async function $e(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");if(n.textContent="Membres",e.appendChild(n),q==null||P?.needsGroup){let l=document.createElement("p");return l.textContent="Aucun groupe actif",e.appendChild(l),e}try{let l=await w(`/groups/${q}/members`),a=document.createElement("table");a.className="user-table";let t=document.createElement("thead");t.innerHTML="<tr><th>Membre</th><th>R\xF4le</th></tr>",a.appendChild(t);let o=document.createElement("tbody");l.forEach(c=>{let s=document.createElement("tr"),d=document.createElement("td");d.textContent=c.username;let p=document.createElement("td");p.textContent=c.role,s.appendChild(d),s.appendChild(p),o.appendChild(s)}),a.appendChild(o),e.appendChild(a)}catch{let a=document.createElement("p");a.style.color="var(--danger-color)",a.textContent="Impossible de r\xE9cup\xE9rer les membres du groupe",e.appendChild(a)}return e}async function Ie(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let l=document.createElement("h3");if(l.textContent="Administration",n.appendChild(l),q==null||P?.needsGroup){let a=document.createElement("p");return a.textContent="Aucun groupe actif",n.appendChild(a),n}try{let a=await w("/context");if(!a){let m=document.createElement("p");return m.textContent="Aucun groupe actif",n.appendChild(m),n}let[t,o]=await Promise.all([w(`/groups/${q}/members`),w("/users")]),c=document.createElement("h4");c.textContent="Tableau de bord du groupe",c.style.marginTop="10px",n.appendChild(c);let s=document.createElement("div"),d=a.invitation_code,p=document.createElement("span");p.textContent=`Code d'invitation : ${d}`,s.appendChild(p);let r=document.createElement("button");r.textContent="Copier",r.style.marginLeft="8px",r.onclick=()=>navigator.clipboard.writeText(d),s.appendChild(r);let i=document.createElement("button");i.textContent="Renouveler",i.style.marginLeft="8px",i.onclick=async()=>{try{d=(await w("/groups/renew-code","POST")).invitationCode,p.textContent=`Code d'invitation : ${d}`}catch(m){alert(m.message)}},s.appendChild(i),n.appendChild(s);let C=document.createElement("table");C.className="user-table";let f=document.createElement("thead");f.innerHTML="<tr><th>Membre</th><th>R\xF4le</th><th>Actions</th></tr>",C.appendChild(f);let v=document.createElement("tbody");t.forEach(m=>{let g=document.createElement("tr"),x=document.createElement("td");x.textContent=m.username;let D=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach(V=>{let O=document.createElement("option");O.value=V,O.textContent=V,m.role===V&&(O.selected=!0),A.appendChild(O)}),m.userId===P.id&&(A.disabled=!0),A.onchange=async()=>{try{await w(`/groups/${q}/members`,"PUT",{id:m.id,role:A.value})}catch(V){alert(V.message)}},D.appendChild(A);let $=document.createElement("td"),M=document.createElement("button");M.textContent=m.userId===P.id?"Quitter":"Retirer",M.onclick=async()=>{let V=m.userId===P.id?"Quitter le groupe ?":"Supprimer ce membre ?";if(confirm(V))try{await w(`/groups/${q}/members`,"DELETE",{userId:m.userId}),m.userId===P.id?(alert("Quitter le groupe"),P.needsGroup=!0,Q()):(g.remove(),alert("Membre supprim\xE9"))}catch(O){alert(O.message)}},$.appendChild(M),g.appendChild(x),g.appendChild(D),g.appendChild($),v.appendChild(g)}),C.appendChild(v),n.appendChild(C);let y=new Set(t.map(m=>m.userId)),u=o.filter(m=>!y.has(m.id));if(u.length>0){let m=document.createElement("div"),g=document.createElement("select");u.forEach(D=>{let A=document.createElement("option");A.value=D.id,A.textContent=D.username,g.appendChild(A)}),m.appendChild(g);let x=document.createElement("button");x.textContent="Ajouter",x.style.marginLeft="8px",x.onclick=async()=>{try{let D=Number(g.value);await w(`/groups/${q}/members`,"POST",{userId:D,role:"user"}),J(e)}catch(D){alert(D.message)}},m.appendChild(x),n.appendChild(m)}let E=document.createElement("div"),b=document.createElement("input");b.type="email",b.placeholder="adresse e-mail",E.appendChild(b);let N=document.createElement("button");N.textContent="Inviter",N.style.marginLeft="8px",N.onclick=async()=>{let m=b.value.trim();if(m)try{let g=await w(`/groups/${q}/invite`,"POST",{email:m});g.temporaryPassword&&alert(`Mot de passe temporaire : ${g.temporaryPassword}`),J(e)}catch(g){alert(g.message)}},E.appendChild(N),n.appendChild(E);let k=document.createElement("h4");k.textContent="Gestion des utilisateurs",k.style.marginTop="30px",n.appendChild(k);let B=document.createElement("table");B.className="user-table";let S=document.createElement("thead");S.innerHTML="<tr><th>Utilisateur</th><th>R\xF4le</th></tr>",B.appendChild(S);let h=document.createElement("tbody"),L={};o.forEach(m=>{L[m.id]=m.role;let g=document.createElement("tr"),x=document.createElement("td");x.textContent=m.username;let D=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach($=>{let M=document.createElement("option");M.value=$,M.textContent=$,m.role===$&&(M.selected=!0),A.appendChild(M)}),m.id===P.id&&(A.disabled=!0),A.dataset.userId=m.id,D.appendChild(A),g.appendChild(x),g.appendChild(D),h.appendChild(g)}),B.appendChild(h),n.appendChild(B);let T=document.createElement("button");T.className="btn-primary",T.style.marginTop="10px",T.textContent="Enregistrer les r\xF4les",T.onclick=async()=>{try{let m=[];h.querySelectorAll("select").forEach(g=>{let x=Number(g.dataset.userId),D=g.value;L[x]!==D&&m.push({id:x,role:D})});for(let g of m)await w(`/users/${g.id}`,"PUT",{role:g.role});alert("R\xF4les mis \xE0 jour"),J(e)}catch(m){alert(m.message)}},n.appendChild(T)}catch{let t=document.createElement("p");t.style.color="var(--danger-color)",t.textContent="Impossible de r\xE9cup\xE9rer les membres",n.appendChild(t)}return n}async function J(e){e.innerHTML="";let n=document.createElement("h2");if(n.className="section-title",n.textContent="Param\xE8tres",e.appendChild(n),P){let r=document.createElement("p");r.className="user-info",r.textContent=`Utilisateur connect\xE9: ${P.username}`,e.appendChild(r)}let l=document.createElement("div");l.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let a=document.createElement("button");a.className="logout-btn",a.textContent="Se d\xE9connecter",a.onclick=de,l.appendChild(a);let t=document.createElement("button");t.id="delete-account-btn",t.className="delete-account-btn",t.textContent="Supprimer mon compte",t.onclick=fe,l.appendChild(t);let o;try{o=await w("/settings")}catch{let i=document.createElement("p");i.style.color="var(--danger-color)",i.textContent="Impossible de r\xE9cup\xE9rer les param\xE8tres",e.appendChild(i),e.appendChild(l);return}let c={...o},s=Pe(c);e.appendChild(s);try{await W();let r=await $e();e.appendChild(r)}catch(r){console.error("Failed to load groups or members",r)}let d=Me(c);e.appendChild(d);let p=Ae();if(e.appendChild(p),e.appendChild(l),ie()){let r=await Ie(e);e.appendChild(r)}}window.addEventListener("DOMContentLoaded",xe)});je();})();
