(()=>{var ne=(e,n)=>()=>(e&&(n=e(e=0)),n);var fe=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports);function ae(){V.rehearsalsCache=[]}var V,X=ne(()=>{V={currentUser:null,currentPage:"home",rehearsalsCache:[],groupsCache:[],activeGroupId:null,agendaDate:new Date}});async function N(e,n="GET",c){let a={method:n,credentials:"same-origin"};c!==void 0&&(a.headers={"Content-Type":"application/json"},a.body=JSON.stringify(c));let t=await fetch("/api"+e,a),l;try{l=await t.json()}catch{l=null}if(t.status===401)throw V.currentUser=null,new Error(l?.error||"Non authentifi\xE9");if(t.status===403&&l&&l.error==="No membership")throw V.currentUser&&(V.currentUser.needsGroup=!0),new Error("No membership");if(t.status===404&&e==="/context"&&n==="GET")return null;if(!t.ok)throw new Error(l&&l.error||"Erreur API");return l}async function O(){V.rehearsalsCache=await N("/rehearsals")}var oe=ne(()=>{X();setInterval(()=>{V.currentUser&&O().catch(()=>{})},5*60*1e3)});async function J(){try{let e=await N("/me");if(V.currentUser=e,!e.needsGroup){let n=await N("/settings");ce(n.darkMode),le(n.template||"classic"),document.title=`${n.groupName} \u2013 BandTrack`;let c=document.getElementById("group-name");c&&(c.textContent=n.groupName)}}catch{V.currentUser=null}}function ce(e){let n=document.body;e?n.classList.add("dark"):n.classList.remove("dark")}function le(e){let n=document.body;n.classList.forEach(c=>{c.startsWith("template-")&&n.classList.remove(c)}),n.classList.add("template-"+e)}async function de(){try{await N("/logout","POST"),V.currentUser=null}catch(e){alert(e.message)}}var ie=ne(()=>{X();oe()});var $e=fe(()=>{X();oe();ie();var B=null,I="home",$=[],Y=[],q=null,U=new Date;Object.defineProperties(V,{currentUser:{get:()=>B,set:e=>B=e},currentPage:{get:()=>I,set:e=>I=e},rehearsalsCache:{get:()=>$,set:e=>$=e},groupsCache:{get:()=>Y,set:e=>Y=e},activeGroupId:{get:()=>q,set:e=>q=e},agendaDate:{get:()=>U,set:e=>U=e}});document.addEventListener("click",e=>{let n=document.getElementById("profile-menu"),c=document.getElementById("hamburger");n&&!n.classList.contains("hidden")&&!n.contains(e.target)&&e.target!==c&&!c?.contains(e.target)&&(n.classList.add("hidden"),n.classList.remove("block","open"),c?.classList.remove("open"))});function Z(){let e=document.getElementById("profile-menu"),n=document.getElementById("hamburger");if(!e||!n)return;e.classList.toggle("hidden"),e.classList.toggle("block"),e.classList.toggle("open"),n.classList.toggle("open");let c=n.querySelectorAll("span");c.length===3&&(c[0].classList.toggle("translate-y-1.5"),c[0].classList.toggle("rotate-45"),c[1].classList.toggle("opacity-0"),c[2].classList.toggle("-translate-y-1.5"),c[2].classList.toggle("-rotate-45"))}function ee(){return B&&(B.membershipRole==="admin"||B.membershipRole==="moderator")}function ue(){return B&&B.membershipRole==="admin"}function re(e){if(!e)return"";let n=new Date(e);return isNaN(n)?e:n.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short",hour12:!1})}async function he(){if(confirm("\xCAtes-vous s\xFBr de vouloir supprimer votre compte ?"))try{await N("/me","DELETE"),B=null,K()}catch(n){alert(n.message)}}async function me(e){await N("/context","PUT",{groupId:Number(e)}),localStorage.setItem("activeGroupId",String(e)),q=Number(e),ae(),await J()}async function _(e){if(!B)return;let n=document.getElementById("group-select"),c=document.getElementById("create-group-btn"),a=document.getElementById("join-group-btn");c&&(c.onclick=()=>Ce()),a&&(a.onclick=()=>ye());try{Y=await N("/groups");let t=e||localStorage.getItem("activeGroupId");Y.some(l=>String(l.id)===String(t))||(t=Y[0]?Y[0].id:null),n&&(n.innerHTML="",Y.forEach(l=>{let o=document.createElement("option");o.value=l.id,o.textContent=l.name,n.appendChild(o)}),t&&(n.value=t),n.onchange=async()=>{await me(n.value),W(document.getElementById("app"))}),t&&await me(t)}catch(t){console.error(t)}}function Ce(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let c=document.createElement("h3");c.textContent="Cr\xE9er un groupe",n.appendChild(c);let a=document.createElement("form");a.onsubmit=m=>m.preventDefault();let t=document.createElement("label");t.textContent="Nom du groupe";let l=document.createElement("input");l.type="text",l.required=!0,l.style.width="100%",a.appendChild(t),a.appendChild(l),n.appendChild(a);let o=document.createElement("div");o.className="modal-actions";let i=document.createElement("button");i.className="btn-secondary",i.textContent="Annuler",i.onclick=()=>e.remove();let d=document.createElement("button");d.className="btn-primary",d.textContent="Cr\xE9er",d.onclick=async()=>{let m=l.value.trim();if(m)try{let r=await N("/groups","POST",{name:m});alert("Code d'invitation : "+r.invitationCode),e.remove(),await _(r.id),W(document.getElementById("app"))}catch(r){alert(r.message)}},o.appendChild(i),o.appendChild(d),n.appendChild(o),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>l.focus(),50)}function ye(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let c=document.createElement("h3");c.textContent="Rejoindre un groupe",n.appendChild(c);let a=document.createElement("form");a.onsubmit=s=>s.preventDefault();let t=document.createElement("label");t.textContent="Code d'invitation";let l=document.createElement("input");l.type="text",l.required=!0,l.style.width="100%";let o=document.createElement("label");o.textContent="Surnom";let i=document.createElement("input");i.type="text",i.style.width="100%",a.appendChild(t),a.appendChild(l),a.appendChild(o),a.appendChild(i),n.appendChild(a);let d=document.createElement("div");d.className="modal-actions";let m=document.createElement("button");m.className="btn-secondary",m.textContent="Annuler",m.onclick=()=>e.remove();let r=document.createElement("button");r.className="btn-primary",r.textContent="Rejoindre",r.onclick=async()=>{let s=l.value.trim(),p=i.value.trim();if(s)try{let E=await N("/groups/join","POST",{code:s,nickname:p});e.remove(),await _(E.groupId),W(document.getElementById("app"))}catch(E){alert(E.message)}},d.appendChild(m),d.appendChild(r),n.appendChild(d),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>l.focus(),50)}async function be(){await J(),B&&await _(),K()}function K(){let e=document.getElementById("app");if(B)B.needsGroup?ge(e):W(e);else{let n=document.getElementById("group-name");n&&(n.textContent=""),ae(),ve(e)}}function ge(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let c=document.createElement("h2");c.textContent="Rejoindre ou cr\xE9er un groupe",n.appendChild(c);let a=document.createElement("p");a.textContent="Vous devez s\xE9lectionner ou cr\xE9er un groupe pour continuer.",n.appendChild(a);let t=document.createElement("p");t.textContent="Pour rejoindre un groupe existant, munissez-vous de son code d'invitation ou demandez \xE0 un administrateur de vous ajouter directement.",n.appendChild(t);let l=document.createElement("div"),o=document.createElement("button");o.className="btn-primary",o.textContent="Cr\xE9er un groupe",o.onclick=()=>Ce(),l.appendChild(o);let i=document.createElement("button");i.className="btn-secondary",i.style.marginLeft="10px",i.textContent="Rejoindre un groupe",i.onclick=()=>ye(),l.appendChild(i),n.appendChild(l);let d=document.createElement("button");d.id="delete-account-btn-group-setup",d.className="delete-account-btn",d.textContent="Supprimer mon compte",d.onclick=he,n.appendChild(d),e.appendChild(n)}function ve(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let c=!1;function a(){n.innerHTML="";let t=document.createElement("h2");t.textContent=c?"Inscription":"Connexion",n.appendChild(t);let l=document.createElement("form");l.onsubmit=async u=>{u.preventDefault(),c?await g():await b()};let o=document.createElement("label");o.textContent="Nom d\u2019utilisateur";let i=document.createElement("input");i.type="text",i.required=!0;let d=document.createElement("label");d.textContent="Mot de passe";let m=document.createElement("input");m.type="password",m.required=!0,l.appendChild(o),l.appendChild(i),l.appendChild(d),l.appendChild(m);let r;if(c){let u=document.createElement("label");u.textContent="Confirmer le mot de passe",r=document.createElement("input"),r.type="password",r.required=!0,l.appendChild(u),l.appendChild(r)}let s=document.createElement("div");s.style.color="var(--danger-color)",s.style.marginTop="12px",l.appendChild(s);let p=document.createElement("button");p.className="btn-primary",p.style.marginTop="20px",p.textContent=c?"S\u2019inscrire":"Se connecter",l.appendChild(p);let E=document.createElement("a");E.className="link",E.textContent=c?"D\xE9j\xE0 un compte ? Se connecter":"Cr\xE9er un compte",E.onclick=u=>{u.preventDefault(),c=!c,a()},n.appendChild(l),n.appendChild(E),e.appendChild(n);async function g(){let u=i.value.trim(),y=m.value,f=r?r.value:"";if(!u||!y){s.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}if(y!==f){s.textContent="Les mots de passe ne correspondent pas";return}try{await N("/register","POST",{username:u,password:y}),await J(),I="home",await _(),K()}catch(v){s.textContent=v.message}}async function b(){let u=i.value.trim(),y=m.value;if(!u||!y){s.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}try{await N("/login","POST",{username:u,password:y}),await J(),I="home",await _(),K()}catch(f){s.textContent=f.message}}}a()}async function xe(e){e.innerHTML="";let n=document.createElement("div");n.className="home-container",e.appendChild(n);let c="Aucune prestation pr\xE9vue";try{let d=await N("/performances"),m=new Date,r=d.filter(s=>new Date(s.date)>=m);if(r.sort((s,p)=>new Date(s.date)-new Date(p.date)),r.length>0){let s=r[0];c=`${s.name} (${re(s.date)})`}}catch{c="Impossible de r\xE9cup\xE9rer les prestations"}let a=document.createElement("p"),t=document.createElement("strong");t.textContent="Prochaine prestation :",a.appendChild(t),a.appendChild(document.createTextNode(" "+c)),n.appendChild(a);let l="\u2014";try{let m=(await N("/agenda")).filter(p=>p.type==="rehearsal"),r=new Date,s=m.filter(p=>new Date(p.date)>=r);if(s.sort((p,E)=>new Date(p.date)-new Date(E.date)),s.length>0){let p=s[0];l=`${re(p.date)}${p.location?" \u2013 "+p.location:""}`}}catch{}let o=document.createElement("p"),i=document.createElement("strong");i.textContent="Prochaine r\xE9p\xE9tition :",o.appendChild(i),o.appendChild(document.createTextNode(" "+l)),n.appendChild(o)}async function W(e){e.innerHTML="";let n=document.getElementById("hamburger"),c=document.getElementById("profile-menu"),a=document.getElementById("menu-performances"),t=document.getElementById("menu-settings"),l=document.getElementById("menu-logout");n&&c&&(n.onclick=m=>{m.stopPropagation(),Z()}),a&&(a.onclick=()=>{I!=="performances"&&(I="performances",W(e)),c?.classList.contains("hidden")||Z()}),t&&(t.onclick=()=>{I!=="settings"&&(I="settings",W(e)),c?.classList.contains("hidden")||Z()}),l&&(l.onclick=async()=>{c?.classList.contains("hidden")||Z(),await de()});let o=document.createElement("div");o.className="page",e.appendChild(o);let i=document.createElement("div");if(i.className="nav-bar",[{key:"home",label:"Accueil"},{key:"suggestions",label:"Propositions"},{key:"rehearsals",label:"En cours"},{key:"agenda",label:"Agenda"}].forEach(m=>{let r=document.createElement("button");r.textContent=m.label,r.className=I===m.key?"active":"",r.onclick=()=>{I!==m.key&&(I=m.key,W(e))},i.appendChild(r)}),e.appendChild(i),I==="home")xe(o);else if(I==="suggestions")F(o);else if(I==="rehearsals"){try{await O()}catch{}z(o)}else if(I==="performances"){try{await O()}catch{}te(o)}else if(I==="agenda"){try{await O()}catch{}H(o)}else I==="settings"&&Q(o)}async function F(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux sugg\xE9r\xE9s",n.className="section-title",e.appendChild(n);let c=[];try{c=await N("/suggestions")}catch{let l=document.createElement("p");l.style.color="var(--danger-color)",l.textContent="Impossible de r\xE9cup\xE9rer les suggestions",e.appendChild(l);return}if(c.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucune proposition pour l\u2019instant",e.appendChild(t)}c.forEach(t=>{let l=document.createElement("div");l.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-pink-50";let o=document.createElement("div");o.className="card-header";let i=document.createElement("h3");i.textContent=t.title,i.onclick=()=>{l.classList.toggle("collapsed")},o.appendChild(i);let d=document.createElement("div");d.className="like-info";let m=document.createElement("span");m.textContent=`\u2764\uFE0F ${t.likes||0}`;let r=document.createElement("button");r.className="like-btn",r.textContent="\u{1F44D}",r.onclick=async b=>{b.stopPropagation(),r.disabled=!0,s.disabled=!0;try{let u=await N(`/suggestions/${t.id}/vote`,"POST");m.textContent=`\u2764\uFE0F ${u.likes}`,await F(e)}catch(u){alert(u.message),r.disabled=!1,s.disabled=!1}};let s=document.createElement("button");s.className="like-btn",s.textContent="\u{1F44E}",s.onclick=async b=>{b.stopPropagation(),r.disabled=!0,s.disabled=!0;try{let u=await N(`/suggestions/${t.id}/vote`,"DELETE");m.textContent=`\u2764\uFE0F ${u.likes}`,await F(e)}catch(u){alert(u.message),r.disabled=!1,s.disabled=!1}},d.appendChild(m),d.appendChild(r),d.appendChild(s),o.appendChild(d),l.appendChild(o);let p=document.createElement("div");if(p.className="card-details",t.author){let b=document.createElement("p");b.style.fontStyle="italic",b.textContent="Auteur : "+t.author,p.appendChild(b)}if(t.versionOf){let b=document.createElement("p");b.style.fontStyle="italic",b.textContent="Version de : "+t.versionOf,p.appendChild(b)}let E=t.youtube||t.url;if(E){let b=document.createElement("a");b.href=E,b.target="_blank",b.rel="noopener noreferrer",b.textContent=E,p.appendChild(b)}let g=document.createElement("p");if(g.style.fontSize="12px",g.style.color="var(--text-color)",g.textContent=`Ajout\xE9 par ${t.creator}`,p.appendChild(g),B&&(ee()||t.creatorId===B.id||t.creator===B.username)){let b=document.createElement("div");b.className="actions";let u=document.createElement("button");u.className="btn-secondary",u.textContent="Modifier",u.onclick=v=>{v.stopPropagation(),we(t,e)},b.appendChild(u);let y=document.createElement("button");y.className="btn-primary",y.textContent="Passer en r\xE9p\xE9tition",y.onclick=async v=>{v.stopPropagation();try{let w=await N(`/suggestions/${t.id}/to-rehearsal`,"POST");$.push(w),F(e)}catch(w){alert(w.message)}},b.appendChild(y);let f=document.createElement("button");f.className="btn-danger",f.textContent="Supprimer",f.onclick=async v=>{if(v.stopPropagation(),!!confirm("Supprimer cette suggestion ?"))try{await N(`/suggestions/${t.id}`,"DELETE"),F(e)}catch(w){alert(w.message)}},b.appendChild(f),p.appendChild(b)}l.appendChild(p),e.appendChild(l)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau",a.textContent="+",a.onclick=()=>Ne(e),e.appendChild(a)}function Ne(e){let n=document.createElement("div");n.className="modal";let c=document.createElement("div");c.className="modal-content";let a=document.createElement("h3");a.textContent="Ajouter une suggestion",c.appendChild(a);let t=document.createElement("form");t.onsubmit=u=>{u.preventDefault()};let l=document.createElement("label");l.textContent="Titre";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%";let i=document.createElement("label");i.textContent="Auteur";let d=document.createElement("input");d.type="text",d.style.width="100%";let m=document.createElement("label");m.textContent="Version de";let r=document.createElement("input");r.type="text",r.style.width="100%";let s=document.createElement("label");s.textContent="Lien YouTube";let p=document.createElement("input");p.type="url",p.style.width="100%",t.appendChild(l),t.appendChild(o),t.appendChild(i),t.appendChild(d),t.appendChild(m),t.appendChild(r),t.appendChild(s),t.appendChild(p),c.appendChild(t);let E=document.createElement("div");E.className="modal-actions";let g=document.createElement("button");g.className="btn-secondary",g.textContent="Annuler",g.onclick=()=>{n.parentNode&&n.parentNode.removeChild(n)};let b=document.createElement("button");b.className="btn-primary",b.textContent="Ajouter",b.onclick=async u=>{u.preventDefault();let y=o.value.trim(),f=d.value.trim(),v=r.value.trim(),w=p.value.trim();if(y)try{await N("/suggestions","POST",{title:y,author:f,youtube:w,versionOf:v}),n.parentNode&&n.parentNode.removeChild(n),F(e)}catch(S){alert(S.message)}},E.appendChild(g),E.appendChild(b),c.appendChild(E),n.appendChild(c),document.body.appendChild(n),setTimeout(()=>o.focus(),50)}function we(e,n){let c=document.createElement("div");c.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Modifier la suggestion",a.appendChild(t);let l=document.createElement("form");l.onsubmit=y=>y.preventDefault();let o=document.createElement("label");o.textContent="Titre";let i=document.createElement("input");i.type="text",i.required=!0,i.style.width="100%",i.value=e.title;let d=document.createElement("label");d.textContent="Auteur";let m=document.createElement("input");m.type="text",m.style.width="100%",m.value=e.author||"";let r=document.createElement("label");r.textContent="Version de";let s=document.createElement("input");s.type="text",s.style.width="100%",s.value=e.versionOf||"";let p=document.createElement("label");p.textContent="Lien YouTube";let E=document.createElement("input");E.type="url",E.style.width="100%",E.value=e.youtube||e.url||"",l.appendChild(o),l.appendChild(i),l.appendChild(d),l.appendChild(m),l.appendChild(r),l.appendChild(s),l.appendChild(p),l.appendChild(E),a.appendChild(l);let g=document.createElement("div");g.className="modal-actions";let b=document.createElement("button");b.className="btn-secondary",b.textContent="Annuler",b.onclick=()=>{c.parentNode&&c.parentNode.removeChild(c)};let u=document.createElement("button");u.className="btn-primary",u.textContent="Enregistrer",u.onclick=async y=>{y.preventDefault();let f=i.value.trim(),v=m.value.trim(),w=s.value.trim(),S=E.value.trim();if(f)try{await N(`/suggestions/${e.id}`,"PUT",{title:f,author:v,versionOf:w,youtube:S}),c.parentNode&&c.parentNode.removeChild(c),F(n)}catch(D){alert(D.message)}},g.appendChild(b),g.appendChild(u),a.appendChild(g),c.appendChild(a),document.body.appendChild(c),setTimeout(()=>i.focus(),50)}async function z(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux en cours de travail",n.className="section-title",e.appendChild(n);let c=$;if(c.length===0)try{await O(),c=$}catch{let l=document.createElement("p");l.style.color="var(--danger-color)",l.textContent="Impossible de r\xE9cup\xE9rer les r\xE9p\xE9titions",e.appendChild(l);return}if(c.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucun morceau en r\xE9p\xE9tition",e.appendChild(t)}c.forEach(t=>{let l=document.createElement("div");l.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-blue-50";let o=t.levels[B.username]!=null?t.levels[B.username]:0,i=document.createElement("div");i.className="card-header";let d=document.createElement("h3");d.textContent=t.title,d.onclick=()=>{l.classList.toggle("collapsed")},i.appendChild(d);let m=document.createElement("span");m.className="level-badge",m.textContent=o,i.appendChild(m),l.appendChild(i);let r=document.createElement("div");if(r.className="card-details",t.author){let C=document.createElement("p");C.style.fontStyle="italic",C.textContent="Auteur : "+t.author,r.appendChild(C)}if(t.youtube){let C=document.createElement("a");C.href=t.youtube,C.target="_blank",C.rel="noopener noreferrer",C.textContent=t.youtube,r.appendChild(C)}let s=document.createElement("div");s.style.marginTop="8px";let p=document.createElement("label");p.textContent=`Votre niveau (${o}/10)`,p.className="level-display";let E=document.createElement("input");E.type="range",E.min=0,E.max=10,E.step=1,E.value=o;function g(C){let L=C/10,T=Math.round(255*(1-L)),h=Math.round(255*L);E.style.background=`linear-gradient(to right, rgb(${T},${h},80) ${C/10*100}%, var(--border-color) ${C/10*100}%)`}g(o),E.oninput=async()=>{let C=Number(E.value);p.textContent=`Votre niveau (${C}/10)`,m.textContent=C,g(C);try{await N(`/rehearsals/${t.id}`,"PUT",{level:C})}catch(L){alert(L.message)}},s.appendChild(p),s.appendChild(E),r.appendChild(s);let b=document.createElement("label");b.textContent="Vos notes";let u=document.createElement("textarea");u.value=t.notes&&t.notes[B.username]||"",u.onchange=async()=>{try{await N(`/rehearsals/${t.id}`,"PUT",{note:u.value})}catch(C){alert(C.message)}},r.appendChild(b),r.appendChild(u);let y=document.createElement("div");y.style.marginTop="8px",(t.audioNotes&&t.audioNotes[B.username]||[]).forEach((C,L)=>{let T=document.createElement("div");if(C.title){let k=document.createElement("div");k.textContent=C.title,T.appendChild(k)}let h=document.createElement("audio");h.controls=!0,h.src=C.audio,T.appendChild(h);let x=document.createElement("button");x.className="btn-danger",x.textContent="Supprimer audio",x.style.marginLeft="8px",x.onclick=async k=>{if(k.preventDefault(),!!confirm("Supprimer la note audio\xA0?"))try{await N(`/rehearsals/${t.id}`,"PUT",{audioIndex:L}),z(e)}catch(P){alert(P.message)}},T.appendChild(x),y.appendChild(T)});let v=document.createElement("input");v.type="text",v.placeholder="Titre de la note",v.style.display="block",v.style.marginTop="8px";let w=document.createElement("input");w.type="file",w.accept="audio/*",w.style.display="none";let S=document.createElement("button");S.className="btn-secondary",S.textContent="Ajouter une note audio",S.onclick=C=>{C.preventDefault(),w.click()},w.onchange=async()=>{let C=w.files[0];if(!C)return;if(C.size>5*1024*1024){alert("Le fichier audio est trop volumineux (max 5\xA0Mo).");return}let L=new FileReader;L.onload=async T=>{let h=(T.target?.result||"").toString();try{await N(`/rehearsals/${t.id}`,"PUT",{audio:h,audioTitle:v.value}),z(e)}catch(x){alert(x.message)}},L.readAsDataURL(C)},y.appendChild(v),y.appendChild(S),y.appendChild(w),r.appendChild(y);let D=Object.keys(t.levels||{}).filter(C=>C.toLowerCase()!==B.username.toLowerCase());if(D.length>0){let C=document.createElement("div");C.style.marginTop="12px";let L=document.createElement("p");L.textContent="Autres membres :",L.style.fontStyle="italic",C.appendChild(L),D.forEach(T=>{let h=document.createElement("div");h.style.marginBottom="4px";let x=t.levels[T],k=t.notes&&t.notes[T]?t.notes[T]:"",P=document.createElement("p");P.style.margin="0";let A=document.createElement("strong");A.textContent=T,P.appendChild(A),P.appendChild(document.createTextNode(` \u2013 Niveau ${x}/10${k?" \u2013 "+k:""}`)),h.appendChild(P),(t.audioNotes&&t.audioNotes[T]||[]).forEach(M=>{let j=document.createElement("audio");if(j.controls=!0,j.src=M.audio,j.style.display="block",j.style.marginTop="4px",M.title){let G=document.createElement("div");G.textContent=M.title,G.style.marginTop="4px",h.appendChild(G)}h.appendChild(j)}),C.appendChild(h)}),r.appendChild(C)}if(B&&(ee()||B.id===t.creatorId)){let C=document.createElement("div");C.className="actions";let L=document.createElement("button");L.className="btn-secondary",L.textContent="Modifier",L.onclick=x=>{x.stopPropagation(),ke(t,e)},C.appendChild(L);let T=document.createElement("button");T.className="btn-primary",T.textContent="Remettre dans J\u2019aime",T.onclick=async x=>{x.stopPropagation();try{await N(`/rehearsals/${t.id}/to-suggestion`,"POST"),z(e)}catch(k){alert(k.message)}},C.appendChild(T);let h=document.createElement("button");h.className="btn-danger",h.textContent="Supprimer",h.onclick=async x=>{if(x.stopPropagation(),!!confirm("Supprimer ce morceau ?"))try{await N(`/rehearsals/${t.id}`,"DELETE"),$=$.filter(k=>k.id!==t.id),z(e)}catch(k){alert(k.message)}},C.appendChild(h),r.appendChild(C)}l.appendChild(r),e.appendChild(l)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau en r\xE9p\xE9tition",a.textContent="+",a.onclick=()=>Te(e),e.appendChild(a)}function Te(e,n){let c=document.createElement("div");c.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Ajouter un morceau",a.appendChild(t);let l=document.createElement("form");l.onsubmit=v=>v.preventDefault();let o=document.createElement("label");o.textContent="Titre";let i=document.createElement("input");i.type="text",i.required=!0,i.style.width="100%";let d=document.createElement("label");d.textContent="Auteur";let m=document.createElement("input");m.type="text",m.style.width="100%";let r=document.createElement("label");r.textContent="Lien YouTube";let s=document.createElement("input");s.type="url",s.style.width="100%";let p=document.createElement("label");p.textContent="Lien Spotify";let E=document.createElement("input");E.type="url",E.style.width="100%";let g=document.createElement("label");g.textContent="Version de";let b=document.createElement("input");b.type="text",b.style.width="100%",l.appendChild(o),l.appendChild(i),l.appendChild(d),l.appendChild(m),l.appendChild(r),l.appendChild(s),l.appendChild(p),l.appendChild(E),l.appendChild(g),l.appendChild(b),a.appendChild(l);let u=document.createElement("div");u.className="modal-actions";let y=document.createElement("button");y.className="btn-secondary",y.textContent="Annuler",y.onclick=()=>{c.parentNode&&c.parentNode.removeChild(c)};let f=document.createElement("button");f.className="btn-primary",f.textContent="Ajouter",f.onclick=async v=>{v.preventDefault();let w=i.value.trim();if(!w)return;let S=m.value.trim(),D=s.value.trim(),C=E.value.trim(),L=b.value.trim();try{let T=await N("/rehearsals","POST",{title:w,author:S,youtube:D,spotify:C,versionOf:L});c.parentNode&&c.parentNode.removeChild(c),$.push(T),typeof n=="function"?n():z(e)}catch(T){alert(T.message)}},u.appendChild(y),u.appendChild(f),a.appendChild(u),c.appendChild(a),document.body.appendChild(c),setTimeout(()=>i.focus(),50)}function ke(e,n,c){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let l=document.createElement("h3");l.textContent="Modifier le morceau",t.appendChild(l);let o=document.createElement("form");o.onsubmit=w=>w.preventDefault();let i=document.createElement("label");i.textContent="Titre";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.title;let m=document.createElement("label");m.textContent="Auteur";let r=document.createElement("input");r.type="text",r.style.width="100%",r.value=e.author||"";let s=document.createElement("label");s.textContent="Lien YouTube";let p=document.createElement("input");p.type="url",p.style.width="100%",p.value=e.youtube||"";let E=document.createElement("label");E.textContent="Lien Spotify";let g=document.createElement("input");g.type="url",g.style.width="100%",g.value=e.spotify||"";let b=document.createElement("label");b.textContent="Version de";let u=document.createElement("input");u.type="text",u.style.width="100%",u.value=e.versionOf||"",o.appendChild(i),o.appendChild(d),o.appendChild(m),o.appendChild(r),o.appendChild(s),o.appendChild(p),o.appendChild(E),o.appendChild(g),o.appendChild(b),o.appendChild(u),t.appendChild(o);let y=document.createElement("div");y.className="modal-actions";let f=document.createElement("button");f.className="btn-secondary",f.textContent="Annuler",f.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let v=document.createElement("button");v.className="btn-primary",v.textContent="Enregistrer",v.onclick=async w=>{w.preventDefault();let S=d.value.trim(),D=r.value.trim(),C=p.value.trim(),L=g.value.trim(),T=u.value.trim();if(S)try{await N(`/rehearsals/${e.id}`,"PUT",{title:S,author:D,youtube:C,spotify:L,versionOf:T}),a.parentNode&&a.parentNode.removeChild(a);let h=$.findIndex(x=>x.id===e.id);h!==-1&&($[h]={...$[h],title:S,author:D||null,youtube:C||null,spotify:L||null,versionOf:T||null}),typeof c=="function"?c():z(n)}catch(h){alert(h.message)}},y.appendChild(f),y.appendChild(v),t.appendChild(y),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function te(e){e.innerHTML="";let n=document.createElement("h2");n.className="section-title",n.textContent="Prestations",e.appendChild(n);let c=[];try{c=await N("/performances")}catch{let m=document.createElement("p");m.style.color="var(--danger-color)",m.textContent="Impossible de r\xE9cup\xE9rer les prestations",e.appendChild(m);return}if($.length===0)try{await O()}catch{}let a=new Date,t=c.filter(d=>new Date(d.date)>=a),l=c.filter(d=>new Date(d.date)<a);function o(d,m){let r=document.createElement("div");if(r.className="section-title",r.textContent=d,e.appendChild(r),m.length===0){let s=document.createElement("p");s.textContent="Aucune prestation",e.appendChild(s);return}m.forEach(s=>{let p=document.createElement("div");p.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-green-50";let E=document.createElement("h3");E.textContent=s.name,E.onclick=()=>{p.classList.toggle("collapsed")},p.appendChild(E);let g=document.createElement("div");g.className="card-details";let b=document.createElement("p");if(b.textContent="Date : "+re(s.date),g.appendChild(b),s.location){let u=document.createElement("p");u.textContent="Lieu : "+s.location,g.appendChild(u)}if(s.songs&&s.songs.length>0){let u=document.createElement("ul");s.songs.forEach(y=>{let f=$.find(w=>w.id===y),v=document.createElement("li");v.textContent=f?f.title:"\u2014",u.appendChild(v)}),g.appendChild(u)}if(B&&(ee()||B.id===s.creatorId)){let u=document.createElement("div");u.className="actions";let y=document.createElement("button");y.className="btn-secondary",y.textContent="Modifier",y.onclick=v=>{v.stopPropagation(),Ee(s,e)},u.appendChild(y);let f=document.createElement("button");f.className="btn-danger",f.textContent="Supprimer",f.onclick=async v=>{if(v.stopPropagation(),!!confirm("Supprimer cette prestation ?"))try{await N(`/performances/${s.id}`,"DELETE"),te(e)}catch(w){alert(w.message)}},u.appendChild(f),g.appendChild(u)}p.appendChild(g),e.appendChild(p)})}o("\xC0 venir",t),o("Pass\xE9es",l);let i=document.createElement("div");i.className="fab",i.title="Ajouter une prestation",i.textContent="+",i.onclick=()=>se(e),e.appendChild(i)}async function H(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Agenda",n.className="section-title",e.appendChild(n);let c=document.createElement("div");c.className="calendar-nav";let a=document.createElement("button");a.textContent="<",a.onclick=()=>{U.setMonth(U.getMonth()-1),H(e)};let t=document.createElement("button");t.textContent=">",t.onclick=()=>{U.setMonth(U.getMonth()+1),H(e)};let l=document.createElement("span");l.textContent=U.toLocaleDateString(void 0,{month:"long",year:"numeric"}),c.appendChild(a),c.appendChild(l),c.appendChild(t),e.appendChild(c);let o=document.createElement("div");o.className="actions";let i=document.createElement("button");i.className="btn-secondary",i.textContent="Nouvelle r\xE9p\xE9tition",i.onclick=()=>pe(e,()=>H(e));let d=document.createElement("button");d.className="btn-secondary",d.textContent="Nouvelle prestation",d.onclick=()=>se(e,()=>H(e)),o.appendChild(i),o.appendChild(d),e.appendChild(o);let m=[];try{let y=U.getFullYear(),f=U.getMonth()+1,v=String(f).padStart(2,"0"),w=`${y}-${v}-01`,S=`${y}-${v}-31`;m=await N(`/agenda?start=${w}&end=${S}`)}catch{let f=document.createElement("p");f.style.color="var(--danger-color)",f.textContent="Impossible de r\xE9cup\xE9rer l'agenda",e.appendChild(f);return}m.sort((y,f)=>y.date.localeCompare(f.date));let r=document.createElement("div");r.className="calendar-grid",["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(y=>{let f=document.createElement("div");f.className="calendar-day-name",f.textContent=y,r.appendChild(f)});let p=U.getFullYear(),E=U.getMonth(),b=(new Date(p,E,1).getDay()+6)%7;for(let y=0;y<b;y++){let f=document.createElement("div");f.className="calendar-cell empty",r.appendChild(f)}let u=new Date(p,E+1,0).getDate();for(let y=1;y<=u;y++){let f=document.createElement("div");f.className="calendar-cell";let v=document.createElement("div");v.className="calendar-date",v.textContent=y,f.appendChild(v);let w=`${p}-${String(E+1).padStart(2,"0")}-${String(y).padStart(2,"0")}`,S=m.filter(D=>D.date?.startsWith(w));S.forEach(D=>{let C=document.createElement("div");C.className=`calendar-event ${D.type==="performance"?"performance":"rehearsal"}`;let L=D.title||D.location||"",T=D.type==="performance"?"Prestation":"R\xE9p\xE9tition";C.textContent=L||T,C.onclick=async h=>{if(h.preventDefault(),h.stopPropagation(),D.type==="performance")try{$.length===0&&await O();let k=(await N("/performances")).find(P=>P.id===D.id);k&&Ee(k,e,()=>H(e))}catch(x){alert(x.message)}else Le(D,e,()=>H(e))},f.appendChild(C)}),S.length===0&&(f.onclick=async()=>{if(!ee())return;if(confirm("Ajouter une prestation ? (Annuler pour une r\xE9p\xE9tition)")){try{$.length===0&&await O()}catch{}se(e,()=>H(e),w)}else pe(e,()=>H(e),`${w}T20:00`)}),r.appendChild(f)}e.appendChild(r)}function pe(e,n,c){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let l=document.createElement("h3");l.textContent="Ajouter une r\xE9p\xE9tition",t.appendChild(l);let o=document.createElement("form");o.onsubmit=g=>g.preventDefault();let i=document.createElement("label");i.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",c&&(d.value=c);let m=document.createElement("label");m.textContent="Lieu";let r=document.createElement("input");r.type="text",r.style.width="100%",o.appendChild(i),o.appendChild(d),o.appendChild(m),o.appendChild(r),t.appendChild(o);let s=document.createElement("div");s.className="modal-actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Annuler",p.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let E=document.createElement("button");E.className="btn-primary",E.textContent="Ajouter",E.onclick=async g=>{g.preventDefault();let b=d.value;if(!b)return;let u=r.value.trim();try{await N("/agenda","POST",{type:"rehearsal",date:b,location:u}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"&&n()}catch(y){alert(y.message)}},s.appendChild(p),s.appendChild(E),t.appendChild(s),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function se(e,n,c){try{await O()}catch(w){alert(w.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let l=document.createElement("h3");l.textContent="Ajouter une prestation",t.appendChild(l);let o=document.createElement("form");o.onsubmit=w=>w.preventDefault();let i=document.createElement("label");i.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%";let m=document.createElement("label");m.textContent="Date";let r=document.createElement("input");r.type="date",r.required=!0,r.style.width="100%",c&&(r.value=c);let s=document.createElement("label");s.textContent="Heure";let p=document.createElement("input");p.type="time",p.required=!0,p.style.width="100%";let E=document.createElement("label");E.textContent="Lieu";let g=document.createElement("input");g.type="text",g.style.width="100%";let b=document.createElement("label");b.textContent="Morceaux jou\xE9s";let u=document.createElement("div");u.className="select-list",$.forEach(w=>{let S=document.createElement("label");S.style.display="flex",S.style.justifyContent="space-between",S.style.alignItems="center";let D=document.createElement("input");D.type="checkbox",D.value=w.id;let C=document.createElement("span");C.textContent=w.title,C.style.marginLeft="4px";let L=document.createElement("span");L.appendChild(D),L.appendChild(C);let T=document.createElement("span");T.className="level-badge";let h=Object.values(w.levels||{}).map(Number),x=h.length>0?h.reduce((k,P)=>k+P,0)/h.length:0;T.textContent=x.toFixed(1),S.appendChild(L),S.appendChild(T),u.appendChild(S)}),o.appendChild(i),o.appendChild(d),o.appendChild(m),o.appendChild(r),o.appendChild(s),o.appendChild(p),o.appendChild(E),o.appendChild(g),o.appendChild(b),o.appendChild(u),t.appendChild(o);let y=document.createElement("div");y.className="modal-actions";let f=document.createElement("button");f.className="btn-secondary",f.textContent="Annuler",f.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let v=document.createElement("button");v.className="btn-primary",v.textContent="Ajouter",v.onclick=async w=>{w.preventDefault();let S=d.value.trim(),D=r.value,C=p.value,L=g.value.trim();if(!S||!D||!C)return;let T=`${D}T${C}`,h=[];u.querySelectorAll('input[type="checkbox"]').forEach(k=>{k.checked&&h.push(Number(k.value))});let x=!1;for(let k of h){let P=$.find(A=>A.id===k);if(P){let A=Object.values(P.levels||{}).map(Number);if((A.length?Math.min(...A):0)<=6){x=!0;break}}}if(!(x&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Ajouter quand m\xEAme ?")))try{await N("/performances","POST",{name:S,date:T,location:L,songs:h}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"?n():te(e)}catch(k){alert(k.message)}},y.appendChild(f),y.appendChild(v),t.appendChild(y),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Le(e,n,c){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let l=document.createElement("h3");l.textContent="Modifier la r\xE9p\xE9tition",t.appendChild(l);let o=document.createElement("form");o.onsubmit=g=>g.preventDefault();let i=document.createElement("label");i.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",d.value=e.date||"";let m=document.createElement("label");m.textContent="Lieu";let r=document.createElement("input");r.type="text",r.style.width="100%",r.value=e.location||"",o.appendChild(i),o.appendChild(d),o.appendChild(m),o.appendChild(r),t.appendChild(o);let s=document.createElement("div");s.className="modal-actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Annuler",p.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let E=document.createElement("button");E.className="btn-primary",E.textContent="Enregistrer",E.onclick=async g=>{g.preventDefault();let b=d.value;if(!b)return;let u=r.value.trim();try{await N(`/agenda/${e.id}`,"PUT",{type:"rehearsal",date:b,location:u}),a.parentNode&&a.parentNode.removeChild(a),typeof c=="function"&&c()}catch(y){alert(y.message)}},s.appendChild(p),s.appendChild(E),t.appendChild(s),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function Ee(e,n,c){try{await O()}catch(D){alert(D.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let l=document.createElement("h3");l.textContent="Modifier la prestation",t.appendChild(l);let o=document.createElement("form");o.onsubmit=D=>D.preventDefault();let i=document.createElement("label");i.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.name;let m=document.createElement("label");m.textContent="Date";let r=document.createElement("input");r.type="date",r.required=!0,r.style.width="100%";let[s,p]=(e.date||"").split("T");r.value=s;let E=document.createElement("label");E.textContent="Heure";let g=document.createElement("input");g.type="time",g.required=!0,g.style.width="100%",g.value=(p||"").slice(0,5);let b=document.createElement("label");b.textContent="Lieu";let u=document.createElement("input");u.type="text",u.style.width="100%",u.value=e.location||"";let y=document.createElement("label");y.textContent="Morceaux jou\xE9s";let f=document.createElement("div");f.className="select-list",$.forEach(D=>{let C=document.createElement("label");C.style.display="flex",C.style.justifyContent="space-between",C.style.alignItems="center";let L=document.createElement("input");L.type="checkbox",L.value=D.id,e.songs.includes(D.id)&&(L.checked=!0);let T=document.createElement("span");T.textContent=D.title,T.style.marginLeft="4px";let h=document.createElement("span");h.appendChild(L),h.appendChild(T);let x=document.createElement("span");x.className="level-badge";let k=Object.values(D.levels||{}).map(Number),P=k.length>0?k.reduce((A,R)=>A+R,0)/k.length:0;x.textContent=P.toFixed(1),C.appendChild(h),C.appendChild(x),f.appendChild(C)}),o.appendChild(i),o.appendChild(d),o.appendChild(m),o.appendChild(r),o.appendChild(E),o.appendChild(g),o.appendChild(b),o.appendChild(u),o.appendChild(y),o.appendChild(f),t.appendChild(o);let v=document.createElement("div");v.className="modal-actions";let w=document.createElement("button");w.className="btn-secondary",w.textContent="Annuler",w.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let S=document.createElement("button");S.className="btn-primary",S.textContent="Enregistrer",S.onclick=async D=>{D.preventDefault();let C=d.value.trim(),L=r.value,T=g.value,h=u.value.trim();if(!C||!L||!T)return;let x=`${L}T${T}`,k=[];f.querySelectorAll('input[type="checkbox"]').forEach(A=>{A.checked&&k.push(Number(A.value))});let P=!1;for(let A of k){let R=$.find(M=>M.id===A);if(R){let M=Object.values(R.levels||{}).map(Number);if((M.length?Math.min(...M):0)<=6){P=!0;break}}}if(!(P&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Enregistrer quand m\xEAme ?")))try{await N(`/performances/${e.id}`,"PUT",{name:C,date:x,location:h,songs:k}),a.parentNode&&a.parentNode.removeChild(a),typeof c=="function"?c():te(n)}catch(A){alert(A.message)}},v.appendChild(w),v.appendChild(S),t.appendChild(v),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function De(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let c=document.createElement("h3");c.textContent="Groupes",n.appendChild(c);let a=document.createElement("select");a.id="group-select",n.appendChild(a);let t=document.createElement("div");t.style.marginTop="10px";let l=document.createElement("button");l.id="create-group-btn",l.className="btn-secondary",l.textContent="Cr\xE9er",t.appendChild(l);let o=document.createElement("button");o.id="join-group-btn",o.className="btn-secondary",o.textContent="Rejoindre",o.style.marginLeft="8px",t.appendChild(o);let i=document.createElement("button");if(i.id="rename-group-btn",i.className="btn-secondary",i.textContent="Renommer",i.style.marginLeft="8px",i.onclick=async()=>{let d=prompt("Nouveau nom du groupe",e.groupName);if(!d||d.trim()===""||d===e.groupName)return;let m=d.trim(),r=e.id||B.groupId;try{await N(`/groups/${r}`,"PUT",{name:m}),e.groupName=m,document.title=`${e.groupName} \u2013 BandTrack`;let s=document.getElementById("group-name");s&&(s.textContent=e.groupName),await _(r),await Q(document.getElementById("app"))}catch(s){alert(s.message)}},t.appendChild(i),n.appendChild(t),ue()){let d=document.createElement("div");d.style.marginTop="8px";let m=e.invitationCode,r=document.createElement("span");r.textContent=`Code d'invitation : ${m}`,d.appendChild(r);let s=document.createElement("button");s.textContent="Copier",s.style.marginLeft="8px",s.onclick=()=>navigator.clipboard.writeText(m),d.appendChild(s);let p=document.createElement("button");p.textContent="Renouveler",p.style.marginLeft="8px",p.onclick=async()=>{try{m=(await N("/groups/renew-code","POST")).invitationCode,r.textContent=`Code d'invitation : ${m}`}catch(E){alert(E.message)}},d.appendChild(p),n.appendChild(d)}return n}function Se(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");n.textContent="Mot de passe",e.appendChild(n);let c=document.createElement("form");c.onsubmit=m=>m.preventDefault();let a=document.createElement("label");a.textContent="Mot de passe actuel";let t=document.createElement("input");t.type="password",t.required=!0,t.style.width="100%";let l=document.createElement("label");l.textContent="Nouveau mot de passe";let o=document.createElement("input");o.type="password",o.required=!0,o.style.width="100%";let i=document.createElement("button");i.className="btn-primary",i.type="submit",i.textContent="Modifier",i.style.marginTop="8px";let d=document.createElement("p");return d.style.marginTop="8px",c.appendChild(a),c.appendChild(t),c.appendChild(l),c.appendChild(o),c.appendChild(i),c.appendChild(d),c.onsubmit=async m=>{m.preventDefault(),d.textContent="";try{await N("/password","PUT",{oldPassword:t.value,newPassword:o.value}),d.style.color="green",d.textContent="Mot de passe mis \xE0 jour",t.value="",o.value=""}catch(r){d.style.color="var(--danger-color)",d.textContent=r.message}},e.appendChild(c),e}function Be(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let c=document.createElement("h3");c.textContent="Th\xE8me",n.appendChild(c);let a=document.createElement("div"),t=document.createElement("label");t.textContent="Mode sombre",t.style.marginRight="8px";let l=document.createElement("input");l.type="checkbox",l.checked=e.darkMode,l.onchange=async()=>{e.darkMode=l.checked;try{await N("/settings","PUT",e),ce(l.checked)}catch(r){alert(r.message)}},a.appendChild(t),a.appendChild(l),n.appendChild(a);let o=document.createElement("div");o.style.marginTop="20px";let i=document.createElement("label");i.textContent="Template (design)",i.style.marginRight="8px";let d=document.createElement("select");return[{value:"classic",label:"Classique"},{value:"groove",label:"Groove"},{value:"violet",label:"Violet"},{value:"imgbg",label:"Image"}].forEach(r=>{let s=document.createElement("option");s.value=r.value,s.textContent=r.label,d.appendChild(s)}),d.value=e.template||"classic",d.onchange=async()=>{let r=d.value;e.template=r;try{await N("/settings","PUT",e),le(r)}catch(s){alert(s.message)}},o.appendChild(i),o.appendChild(d),n.appendChild(o),n}async function Pe(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");if(n.textContent="Membres",e.appendChild(n),q==null||B?.needsGroup){let c=document.createElement("p");return c.textContent="Aucun groupe actif",e.appendChild(c),e}try{let c=await N(`/groups/${q}/members`),a=document.createElement("table");a.className="user-table";let t=document.createElement("thead");t.innerHTML="<tr><th>Membre</th><th>R\xF4le</th></tr>",a.appendChild(t);let l=document.createElement("tbody");c.forEach(o=>{let i=document.createElement("tr"),d=document.createElement("td");d.textContent=o.username;let m=document.createElement("td");m.textContent=o.role,i.appendChild(d),i.appendChild(m),l.appendChild(i)}),a.appendChild(l),e.appendChild(a)}catch{let a=document.createElement("p");a.style.color="var(--danger-color)",a.textContent="Impossible de r\xE9cup\xE9rer les membres du groupe",e.appendChild(a)}return e}async function Ae(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let c=document.createElement("h3");if(c.textContent="Administration",n.appendChild(c),q==null||B?.needsGroup){let a=document.createElement("p");return a.textContent="Aucun groupe actif",n.appendChild(a),n}try{let a=await N("/context");if(!a){let h=document.createElement("p");return h.textContent="Aucun groupe actif",n.appendChild(h),n}let[t,l]=await Promise.all([N(`/groups/${q}/members`),N("/users")]),o=document.createElement("h4");o.textContent="Tableau de bord du groupe",o.style.marginTop="10px",n.appendChild(o);let i=document.createElement("div"),d=a.invitation_code,m=document.createElement("span");m.textContent=`Code d'invitation : ${d}`,i.appendChild(m);let r=document.createElement("button");r.textContent="Copier",r.style.marginLeft="8px",r.onclick=()=>navigator.clipboard.writeText(d),i.appendChild(r);let s=document.createElement("button");s.textContent="Renouveler",s.style.marginLeft="8px",s.onclick=async()=>{try{d=(await N("/groups/renew-code","POST")).invitationCode,m.textContent=`Code d'invitation : ${d}`}catch(h){alert(h.message)}},i.appendChild(s),n.appendChild(i);let p=document.createElement("table");p.className="user-table";let E=document.createElement("thead");E.innerHTML="<tr><th>Membre</th><th>R\xF4le</th><th>Actions</th></tr>",p.appendChild(E);let g=document.createElement("tbody");t.forEach(h=>{let x=document.createElement("tr"),k=document.createElement("td");k.textContent=h.username;let P=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach(j=>{let G=document.createElement("option");G.value=j,G.textContent=j,h.role===j&&(G.selected=!0),A.appendChild(G)}),h.userId===B.id&&(A.disabled=!0),A.onchange=async()=>{try{await N(`/groups/${q}/members`,"PUT",{id:h.id,role:A.value})}catch(j){alert(j.message)}},P.appendChild(A);let R=document.createElement("td"),M=document.createElement("button");M.textContent=h.userId===B.id?"Quitter":"Retirer",M.onclick=async()=>{let j=h.userId===B.id?"Quitter le groupe ?":"Supprimer ce membre ?";if(confirm(j))try{await N(`/groups/${q}/members`,"DELETE",{userId:h.userId}),h.userId===B.id?(alert("Quitter le groupe"),B.needsGroup=!0,K()):(x.remove(),alert("Membre supprim\xE9"))}catch(G){alert(G.message)}},R.appendChild(M),x.appendChild(k),x.appendChild(P),x.appendChild(R),g.appendChild(x)}),p.appendChild(g),n.appendChild(p);let b=new Set(t.map(h=>h.userId)),u=l.filter(h=>!b.has(h.id));if(u.length>0){let h=document.createElement("div"),x=document.createElement("select");u.forEach(P=>{let A=document.createElement("option");A.value=P.id,A.textContent=P.username,x.appendChild(A)}),h.appendChild(x);let k=document.createElement("button");k.textContent="Ajouter",k.style.marginLeft="8px",k.onclick=async()=>{try{let P=Number(x.value);await N(`/groups/${q}/members`,"POST",{userId:P,role:"user"}),Q(e)}catch(P){alert(P.message)}},h.appendChild(k),n.appendChild(h)}let y=document.createElement("div"),f=document.createElement("input");f.type="email",f.placeholder="adresse e-mail",y.appendChild(f);let v=document.createElement("button");v.textContent="Inviter",v.style.marginLeft="8px",v.onclick=async()=>{let h=f.value.trim();if(h)try{let x=await N(`/groups/${q}/invite`,"POST",{email:h});x.temporaryPassword&&alert(`Mot de passe temporaire : ${x.temporaryPassword}`),Q(e)}catch(x){alert(x.message)}},y.appendChild(v),n.appendChild(y);let w=document.createElement("h4");w.textContent="Gestion des utilisateurs",w.style.marginTop="30px",n.appendChild(w);let S=document.createElement("table");S.className="user-table";let D=document.createElement("thead");D.innerHTML="<tr><th>Utilisateur</th><th>R\xF4le</th></tr>",S.appendChild(D);let C=document.createElement("tbody"),L={};l.forEach(h=>{L[h.id]=h.role;let x=document.createElement("tr"),k=document.createElement("td");k.textContent=h.username;let P=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach(R=>{let M=document.createElement("option");M.value=R,M.textContent=R,h.role===R&&(M.selected=!0),A.appendChild(M)}),h.id===B.id&&(A.disabled=!0),A.dataset.userId=h.id,P.appendChild(A),x.appendChild(k),x.appendChild(P),C.appendChild(x)}),S.appendChild(C),n.appendChild(S);let T=document.createElement("button");T.className="btn-primary",T.style.marginTop="10px",T.textContent="Enregistrer les r\xF4les",T.onclick=async()=>{try{let h=[];C.querySelectorAll("select").forEach(x=>{let k=Number(x.dataset.userId),P=x.value;L[k]!==P&&h.push({id:k,role:P})});for(let x of h)await N(`/users/${x.id}`,"PUT",{role:x.role});alert("R\xF4les mis \xE0 jour"),Q(e)}catch(h){alert(h.message)}},n.appendChild(T)}catch{let t=document.createElement("p");t.style.color="var(--danger-color)",t.textContent="Impossible de r\xE9cup\xE9rer les membres",n.appendChild(t)}return n}async function Q(e){e.innerHTML="";let n=document.createElement("h2");if(n.className="section-title",n.textContent="Param\xE8tres",e.appendChild(n),B){let r=document.createElement("p");r.className="user-info",r.textContent=`Utilisateur connect\xE9: ${B.username}`,e.appendChild(r)}let c=document.createElement("div");c.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let a=document.createElement("button");a.className="logout-btn",a.textContent="Se d\xE9connecter",a.onclick=de,c.appendChild(a);let t=document.createElement("button");t.id="delete-account-btn",t.className="delete-account-btn",t.textContent="Supprimer mon compte",t.onclick=he,c.appendChild(t);let l;try{l=await N("/settings")}catch{let s=document.createElement("p");s.style.color="var(--danger-color)",s.textContent="Impossible de r\xE9cup\xE9rer les param\xE8tres",e.appendChild(s),e.appendChild(c);return}let o={...l},i=De(o);e.appendChild(i);try{await _();let r=await Pe();e.appendChild(r)}catch(r){console.error("Failed to load groups or members",r)}let d=Be(o);e.appendChild(d);let m=Se();if(e.appendChild(m),e.appendChild(c),ue()){let r=await Ae(e);e.appendChild(r)}}window.addEventListener("DOMContentLoaded",be)});$e();})();
