(()=>{var ae=(e,n)=>()=>(e&&(n=e(e=0)),n);var be=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports);function oe(){R.rehearsalsCache=[]}var R,K=ae(()=>{R={currentUser:null,currentPage:"home",rehearsalsCache:[],groupsCache:[],activeGroupId:null,agendaDate:new Date}});async function N(e,n="GET",c){let a={method:n,credentials:"same-origin"};c!==void 0&&(a.headers={"Content-Type":"application/json"},a.body=JSON.stringify(c));let t=await fetch("/api"+e,a),o;try{o=await t.json()}catch{o=null}if(t.status===401)throw R.currentUser=null,new Error(o?.error||"Non authentifi\xE9");if(t.status===403&&o&&o.error==="No membership")throw R.currentUser&&(R.currentUser.needsGroup=!0),new Error("No membership");if(t.status===404&&e==="/context"&&n==="GET")return null;if(!t.ok)throw new Error(o&&o.error||"Erreur API");return o}function ge(e){return N(`/rehearsals/${e}/partitions`)}async function pe(e,n,c){let a=new FormData;a.append("file",n),c&&a.append("displayName",c);let t=await fetch(`/api/rehearsals/${e}/partitions`,{method:"POST",body:a,credentials:"same-origin"}),o;try{o=await t.json()}catch{o=null}if(t.status===401)throw R.currentUser=null,new Error(o?.error||"Non authentifi\xE9");if(!t.ok)throw new Error(o&&o.error||"Erreur API");return o}function me(e,n){return N(`/rehearsals/${e}/partitions/${n}`,"DELETE")}async function U(){let e=await N("/rehearsals"),n=await Promise.allSettled(e.map(a=>ge(a.id))),c=[];n.forEach((a,t)=>{let o=e[t];a.status==="fulfilled"?c.push({...o,partitions:a.value}):console.error(`Erreur lors de la r\xE9cup\xE9ration des partitions pour le morceau ${o.id}`,a.reason)}),R.rehearsalsCache=c}var ce=ae(()=>{K();setInterval(()=>{R.currentUser&&U().catch(()=>{})},5*60*1e3)});async function _(){try{let e=await N("/me");if(R.currentUser=e,!e.needsGroup){let n=await N("/settings");le(n.darkMode),re(n.template||"classic"),document.title=`${n.groupName} \u2013 BandTrack`;let c=document.getElementById("group-name");c&&(c.textContent=n.groupName)}}catch{R.currentUser=null}}function le(e){let n=document.body;e?n.classList.add("dark"):n.classList.remove("dark")}function re(e){let n=document.body;n.classList.forEach(c=>{c.startsWith("template-")&&n.classList.remove(c)}),n.classList.add("template-"+e)}async function de(){try{await N("/logout","POST"),R.currentUser=null}catch(e){alert(e.message)}}var ue=ae(()=>{K();ce()});var je=be(()=>{K();ce();ue();var P=null,j="home",I=[],Z=[],q=null,H=new Date;Object.defineProperties(R,{currentUser:{get:()=>P,set:e=>P=e},currentPage:{get:()=>j,set:e=>j=e},rehearsalsCache:{get:()=>I,set:e=>I=e},groupsCache:{get:()=>Z,set:e=>Z=e},activeGroupId:{get:()=>q,set:e=>q=e},agendaDate:{get:()=>H,set:e=>H=e}});document.addEventListener("click",e=>{let n=document.getElementById("profile-menu"),c=document.getElementById("hamburger");n&&!n.classList.contains("hidden")&&!n.contains(e.target)&&e.target!==c&&!c?.contains(e.target)&&(n.classList.add("hidden"),n.classList.remove("block","open"),c?.classList.remove("open"))});function X(){let e=document.getElementById("profile-menu"),n=document.getElementById("hamburger");if(!e||!n)return;e.classList.toggle("hidden"),e.classList.toggle("block"),e.classList.toggle("open"),n.classList.toggle("open");let c=n.querySelectorAll("span");c.length===3&&(c[0].classList.toggle("translate-y-1.5"),c[0].classList.toggle("rotate-45"),c[1].classList.toggle("opacity-0"),c[2].classList.toggle("-translate-y-1.5"),c[2].classList.toggle("-rotate-45"))}function te(){return P&&(P.membershipRole==="admin"||P.membershipRole==="moderator")}function ie(){return P&&P.membershipRole==="admin"}function ee(e){if(!e)return"";let n=new Date(e);return isNaN(n)?e:n.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short",hour12:!1})}async function fe(){if(confirm("\xCAtes-vous s\xFBr de vouloir supprimer votre compte ?"))try{await N("/me","DELETE"),P=null,Q()}catch(n){alert(n.message)}}async function he(e){await N("/context","PUT",{groupId:Number(e)}),localStorage.setItem("activeGroupId",String(e)),q=Number(e),oe(),await _()}async function W(e){if(!P)return;let n=document.getElementById("group-select"),c=document.getElementById("create-group-btn"),a=document.getElementById("join-group-btn");c&&(c.onclick=()=>ye()),a&&(a.onclick=()=>Ee());try{Z=await N("/groups");let t=e||localStorage.getItem("activeGroupId");Z.some(o=>String(o.id)===String(t))||(t=Z[0]?Z[0].id:null),n&&(n.innerHTML="",Z.forEach(o=>{let l=document.createElement("option");l.value=o.id,l.textContent=o.name,n.appendChild(l)}),t&&(n.value=t),n.onchange=async()=>{await he(n.value),z(document.getElementById("app"))}),t&&await he(t)}catch(t){console.error(t)}}function ye(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let c=document.createElement("h3");c.textContent="Cr\xE9er un groupe",n.appendChild(c);let a=document.createElement("form");a.onsubmit=p=>p.preventDefault();let t=document.createElement("label");t.textContent="Nom du groupe";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%",a.appendChild(t),a.appendChild(o),n.appendChild(a);let l=document.createElement("div");l.className="modal-actions";let i=document.createElement("button");i.className="btn-secondary",i.textContent="Annuler",i.onclick=()=>e.remove();let d=document.createElement("button");d.className="btn-primary",d.textContent="Cr\xE9er",d.onclick=async()=>{let p=o.value.trim();if(p)try{let r=await N("/groups","POST",{name:p});alert("Code d'invitation : "+r.invitationCode),e.remove(),await W(r.id),z(document.getElementById("app"))}catch(r){alert(r.message)}},l.appendChild(i),l.appendChild(d),n.appendChild(l),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>o.focus(),50)}function Ee(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let c=document.createElement("h3");c.textContent="Rejoindre un groupe",n.appendChild(c);let a=document.createElement("form");a.onsubmit=s=>s.preventDefault();let t=document.createElement("label");t.textContent="Code d'invitation";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%";let l=document.createElement("label");l.textContent="Surnom";let i=document.createElement("input");i.type="text",i.style.width="100%",a.appendChild(t),a.appendChild(o),a.appendChild(l),a.appendChild(i),n.appendChild(a);let d=document.createElement("div");d.className="modal-actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Annuler",p.onclick=()=>e.remove();let r=document.createElement("button");r.className="btn-primary",r.textContent="Rejoindre",r.onclick=async()=>{let s=o.value.trim(),u=i.value.trim();if(s)try{let y=await N("/groups/join","POST",{code:s,nickname:u});e.remove(),await W(y.groupId),z(document.getElementById("app"))}catch(y){alert(y.message)}},d.appendChild(p),d.appendChild(r),n.appendChild(d),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>o.focus(),50)}async function xe(){await _(),P&&await W(),Q()}function Q(){let e=document.getElementById("app");if(P)P.needsGroup?we(e):z(e);else{let n=document.getElementById("group-name");n&&(n.textContent=""),oe(),Ne(e)}}function we(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let c=document.createElement("h2");c.textContent="Rejoindre ou cr\xE9er un groupe",n.appendChild(c);let a=document.createElement("p");a.textContent="Vous devez s\xE9lectionner ou cr\xE9er un groupe pour continuer.",n.appendChild(a);let t=document.createElement("p");t.textContent="Pour rejoindre un groupe existant, munissez-vous de son code d'invitation ou demandez \xE0 un administrateur de vous ajouter directement.",n.appendChild(t);let o=document.createElement("div"),l=document.createElement("button");l.className="btn-primary",l.textContent="Cr\xE9er un groupe",l.onclick=()=>ye(),o.appendChild(l);let i=document.createElement("button");i.className="btn-secondary",i.style.marginLeft="10px",i.textContent="Rejoindre un groupe",i.onclick=()=>Ee(),o.appendChild(i),n.appendChild(o);let d=document.createElement("button");d.id="delete-account-btn-group-setup",d.className="delete-account-btn",d.textContent="Supprimer mon compte",d.onclick=fe,n.appendChild(d),e.appendChild(n)}function Ne(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let c=!1;function a(){n.innerHTML="";let t=document.createElement("h2");t.textContent=c?"Inscription":"Connexion",n.appendChild(t);let o=document.createElement("form");o.onsubmit=async C=>{C.preventDefault(),c?await x():await v()};let l=document.createElement("label");l.textContent="Nom d\u2019utilisateur";let i=document.createElement("input");i.type="text",i.required=!0;let d=document.createElement("label");d.textContent="Mot de passe";let p=document.createElement("input");p.type="password",p.required=!0,o.appendChild(l),o.appendChild(i),o.appendChild(d),o.appendChild(p);let r;if(c){let C=document.createElement("label");C.textContent="Confirmer le mot de passe",r=document.createElement("input"),r.type="password",r.required=!0,o.appendChild(C),o.appendChild(r)}let s=document.createElement("div");s.style.color="var(--danger-color)",s.style.marginTop="12px",o.appendChild(s);let u=document.createElement("button");u.className="btn-primary",u.style.marginTop="20px",u.textContent=c?"S\u2019inscrire":"Se connecter",o.appendChild(u);let y=document.createElement("a");y.className="link",y.textContent=c?"D\xE9j\xE0 un compte ? Se connecter":"Cr\xE9er un compte",y.onclick=C=>{C.preventDefault(),c=!c,a()},n.appendChild(o),n.appendChild(y),e.appendChild(n);async function x(){let C=i.value.trim(),f=p.value,E=r?r.value:"";if(!C||!f){s.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}if(f!==E){s.textContent="Les mots de passe ne correspondent pas";return}try{await N("/register","POST",{username:C,password:f}),await _(),j="home",await W(),Q()}catch(w){s.textContent=w.message}}async function v(){let C=i.value.trim(),f=p.value;if(!C||!f){s.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}try{await N("/login","POST",{username:C,password:f}),await _(),j="home",await W(),Q()}catch(E){s.textContent=E.message}}}a()}async function ke(e){e.innerHTML="";let n=document.createElement("div");n.className="home-container",e.appendChild(n);let c="Aucune prestation pr\xE9vue";try{let d=await N("/performances"),p=new Date,r=d.filter(s=>new Date(s.date)>=p);if(r.sort((s,u)=>new Date(s.date)-new Date(u.date)),r.length>0){let s=r[0];c=`${s.name} (${ee(s.date)})`}}catch{c="Impossible de r\xE9cup\xE9rer les prestations"}let a=document.createElement("p"),t=document.createElement("strong");t.textContent="Prochaine prestation :",a.appendChild(t),a.appendChild(document.createTextNode(" "+c)),n.appendChild(a);let o="\u2014";try{let p=(await N("/agenda")).filter(u=>u.type==="rehearsal"),r=new Date,s=p.filter(u=>new Date(u.date)>=r);if(s.sort((u,y)=>new Date(u.date)-new Date(y.date)),s.length>0){let u=s[0];o=`${ee(u.date)}${u.location?" \u2013 "+u.location:""}`}}catch{}let l=document.createElement("p"),i=document.createElement("strong");i.textContent="Prochaine r\xE9p\xE9tition :",l.appendChild(i),l.appendChild(document.createTextNode(" "+o)),n.appendChild(l)}async function z(e){e.innerHTML="";let n=document.getElementById("hamburger"),c=document.getElementById("profile-menu"),a=document.getElementById("menu-performances"),t=document.getElementById("menu-settings"),o=document.getElementById("menu-logout");n&&c&&(n.onclick=p=>{p.stopPropagation(),X()}),a&&(a.onclick=()=>{j!=="performances"&&(j="performances",z(e)),c?.classList.contains("hidden")||X()}),t&&(t.onclick=()=>{j!=="settings"&&(j="settings",z(e)),c?.classList.contains("hidden")||X()}),o&&(o.onclick=async()=>{c?.classList.contains("hidden")||X(),await de()});let l=document.createElement("div");l.className="page",e.appendChild(l);let i=document.createElement("div");if(i.className="nav-bar",[{key:"home",label:"Home",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>'},{key:"suggestions",label:"Suggestions",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"/></svg>'},{key:"rehearsals",label:"R\xE9p\xE8tes",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"/></svg>'},{key:"performances",label:"Prestations",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>'},{key:"agenda",label:"Agenda",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z"/></svg>'}].forEach(p=>{let r=document.createElement("button");r.innerHTML=`${p.icon}<span>${p.label}</span>`,r.className=j===p.key?"active":"",r.onclick=()=>{j!==p.key&&(j=p.key,z(e))},i.appendChild(r)}),e.appendChild(i),j==="home")ke(l);else if(j==="suggestions")F(l);else if(j==="rehearsals"){try{await U()}catch{}Y(l)}else if(j==="performances"){try{await U()}catch{}ne(l)}else if(j==="agenda"){try{await U()}catch{}G(l)}else j==="settings"&&J(l)}async function F(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux sugg\xE9r\xE9s",n.className="section-title",e.appendChild(n);let c=[];try{c=await N("/suggestions")}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les suggestions",e.appendChild(o);return}if(c.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucune proposition pour l\u2019instant",e.appendChild(t)}c.forEach(t=>{let o=document.createElement("div");o.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-pink-50";let l=document.createElement("div");l.className="card-header";let i=document.createElement("h3");i.textContent=t.title,i.onclick=()=>{o.classList.toggle("collapsed")},l.appendChild(i);let d=document.createElement("div");d.className="like-info";let p=document.createElement("span");p.textContent=`\u2764\uFE0F ${t.likes||0}`;let r=document.createElement("button");r.className="like-btn",r.textContent="\u{1F44D}",r.onclick=async v=>{v.stopPropagation(),r.disabled=!0,s.disabled=!0;try{let C=await N(`/suggestions/${t.id}/vote`,"POST");p.textContent=`\u2764\uFE0F ${C.likes}`,await F(e)}catch(C){alert(C.message),r.disabled=!1,s.disabled=!1}};let s=document.createElement("button");s.className="like-btn",s.textContent="\u{1F44E}",s.onclick=async v=>{v.stopPropagation(),r.disabled=!0,s.disabled=!0;try{let C=await N(`/suggestions/${t.id}/vote`,"DELETE");p.textContent=`\u2764\uFE0F ${C.likes}`,await F(e)}catch(C){alert(C.message),r.disabled=!1,s.disabled=!1}},d.appendChild(p),d.appendChild(r),d.appendChild(s),l.appendChild(d),o.appendChild(l);let u=document.createElement("div");if(u.className="card-details",t.author){let v=document.createElement("p");v.style.fontStyle="italic",v.textContent="Auteur : "+t.author,u.appendChild(v)}if(t.versionOf){let v=document.createElement("p");v.style.fontStyle="italic",v.textContent="Version de : "+t.versionOf,u.appendChild(v)}let y=t.youtube||t.url;if(y){let v=document.createElement("a");v.href=y,v.target="_blank",v.rel="noopener noreferrer",v.textContent=y,u.appendChild(v)}let x=document.createElement("p");if(x.style.fontSize="12px",x.style.color="var(--text-color)",x.textContent=`Ajout\xE9 par ${t.creator}`,u.appendChild(x),P&&(te()||t.creatorId===P.id||t.creator===P.username)){let v=document.createElement("div");v.className="actions";let C=document.createElement("button");C.className="btn-secondary",C.textContent="Modifier",C.onclick=w=>{w.stopPropagation(),Le(t,e)},v.appendChild(C);let f=document.createElement("button");f.className="btn-primary",f.textContent="Passer en r\xE9p\xE9tition",f.onclick=async w=>{w.stopPropagation();try{let k=await N(`/suggestions/${t.id}/to-rehearsal`,"POST");I.push(k),F(e)}catch(k){alert(k.message)}},v.appendChild(f);let E=document.createElement("button");E.className="btn-danger",E.textContent="Supprimer",E.onclick=async w=>{if(w.stopPropagation(),!!confirm("Supprimer cette suggestion ?"))try{await N(`/suggestions/${t.id}`,"DELETE"),F(e)}catch(k){alert(k.message)}},v.appendChild(E),u.appendChild(v)}o.appendChild(u),e.appendChild(o)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau",a.textContent="+",a.onclick=()=>Te(e),e.appendChild(a)}function Te(e){let n=document.createElement("div");n.className="modal";let c=document.createElement("div");c.className="modal-content";let a=document.createElement("h3");a.textContent="Ajouter une suggestion",c.appendChild(a);let t=document.createElement("form");t.onsubmit=C=>{C.preventDefault()};let o=document.createElement("label");o.textContent="Titre";let l=document.createElement("input");l.type="text",l.required=!0,l.style.width="100%";let i=document.createElement("label");i.textContent="Auteur";let d=document.createElement("input");d.type="text",d.style.width="100%";let p=document.createElement("label");p.textContent="Version de";let r=document.createElement("input");r.type="text",r.style.width="100%";let s=document.createElement("label");s.textContent="Lien YouTube";let u=document.createElement("input");u.type="url",u.style.width="100%",t.appendChild(o),t.appendChild(l),t.appendChild(i),t.appendChild(d),t.appendChild(p),t.appendChild(r),t.appendChild(s),t.appendChild(u),c.appendChild(t);let y=document.createElement("div");y.className="modal-actions";let x=document.createElement("button");x.className="btn-secondary",x.textContent="Annuler",x.onclick=()=>{n.parentNode&&n.parentNode.removeChild(n)};let v=document.createElement("button");v.className="btn-primary",v.textContent="Ajouter",v.onclick=async C=>{C.preventDefault();let f=l.value.trim(),E=d.value.trim(),w=r.value.trim(),k=u.value.trim();if(f)try{await N("/suggestions","POST",{title:f,author:E,youtube:k,versionOf:w}),n.parentNode&&n.parentNode.removeChild(n),F(e)}catch(B){alert(B.message)}},y.appendChild(x),y.appendChild(v),c.appendChild(y),n.appendChild(c),document.body.appendChild(n),setTimeout(()=>l.focus(),50)}function Le(e,n){let c=document.createElement("div");c.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Modifier la suggestion",a.appendChild(t);let o=document.createElement("form");o.onsubmit=f=>f.preventDefault();let l=document.createElement("label");l.textContent="Titre";let i=document.createElement("input");i.type="text",i.required=!0,i.style.width="100%",i.value=e.title;let d=document.createElement("label");d.textContent="Auteur";let p=document.createElement("input");p.type="text",p.style.width="100%",p.value=e.author||"";let r=document.createElement("label");r.textContent="Version de";let s=document.createElement("input");s.type="text",s.style.width="100%",s.value=e.versionOf||"";let u=document.createElement("label");u.textContent="Lien YouTube";let y=document.createElement("input");y.type="url",y.style.width="100%",y.value=e.youtube||e.url||"",o.appendChild(l),o.appendChild(i),o.appendChild(d),o.appendChild(p),o.appendChild(r),o.appendChild(s),o.appendChild(u),o.appendChild(y),a.appendChild(o);let x=document.createElement("div");x.className="modal-actions";let v=document.createElement("button");v.className="btn-secondary",v.textContent="Annuler",v.onclick=()=>{c.parentNode&&c.parentNode.removeChild(c)};let C=document.createElement("button");C.className="btn-primary",C.textContent="Enregistrer",C.onclick=async f=>{f.preventDefault();let E=i.value.trim(),w=p.value.trim(),k=s.value.trim(),B=y.value.trim();if(E)try{await N(`/suggestions/${e.id}`,"PUT",{title:E,author:w,versionOf:k,youtube:B}),c.parentNode&&c.parentNode.removeChild(c),F(n)}catch(S){alert(S.message)}},x.appendChild(v),x.appendChild(C),a.appendChild(x),c.appendChild(a),document.body.appendChild(c),setTimeout(()=>i.focus(),50)}async function Y(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux en cours de travail",n.className="section-title",e.appendChild(n);let c=I;if(c.length===0)try{await U(),c=I}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les r\xE9p\xE9titions",e.appendChild(o);return}if(c.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucun morceau en r\xE9p\xE9tition",e.appendChild(t)}c.forEach(t=>{let o=document.createElement("div");o.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-blue-50";let l=t.levels[P.username]!=null?t.levels[P.username]:0,i=document.createElement("div");i.className="card-header";let d=document.createElement("h3");d.textContent=t.title,d.onclick=()=>{o.classList.toggle("collapsed")},i.appendChild(d);let p=document.createElement("span");p.className="level-badge",p.textContent=l,i.appendChild(p),o.appendChild(i);let r=document.createElement("div");if(r.className="card-details",t.author){let h=document.createElement("p");h.style.fontStyle="italic",h.textContent="Auteur : "+t.author,r.appendChild(h)}if(t.youtube){let h=document.createElement("a");h.href=t.youtube,h.target="_blank",h.rel="noopener noreferrer",h.textContent=t.youtube,r.appendChild(h)}let s=document.createElement("div");s.style.marginTop="8px";let u=document.createElement("label");u.textContent=`Votre niveau (${l}/10)`,u.className="level-display";let y=document.createElement("input");y.type="range",y.min=0,y.max=10,y.step=1,y.value=l;function x(h){let L=h/10,T=Math.round(255*(1-L)),m=Math.round(255*L);y.style.background=`linear-gradient(to right, rgb(${T},${m},80) ${h/10*100}%, var(--border-color) ${h/10*100}%)`}x(l),y.oninput=async()=>{let h=Number(y.value);u.textContent=`Votre niveau (${h}/10)`,p.textContent=h,x(h);try{await N(`/rehearsals/${t.id}`,"PUT",{level:h})}catch(L){alert(L.message)}},s.appendChild(u),s.appendChild(y),r.appendChild(s);let v=document.createElement("label");v.textContent="Vos notes";let C=document.createElement("textarea");C.value=t.notes&&t.notes[P.username]||"",C.onchange=async()=>{try{await N(`/rehearsals/${t.id}`,"PUT",{note:C.value})}catch(h){alert(h.message)}},r.appendChild(v),r.appendChild(C);let f=document.createElement("div");f.style.marginTop="8px",(t.audioNotes&&t.audioNotes[P.username]||[]).forEach((h,L)=>{let T=document.createElement("div");if(h.title){let g=document.createElement("div");g.textContent=h.title,T.appendChild(g)}let m=document.createElement("audio");m.controls=!0,m.src=h.audio,T.appendChild(m);let b=document.createElement("button");b.className="btn-danger",b.textContent="Supprimer audio",b.style.marginLeft="8px",b.onclick=async g=>{if(g.preventDefault(),!!confirm("Supprimer la note audio\xA0?"))try{await N(`/rehearsals/${t.id}`,"PUT",{audioIndex:L}),Y(e)}catch(D){alert(D.message)}},T.appendChild(b),f.appendChild(T)});let w=document.createElement("input");w.type="text",w.placeholder="Titre de la note",w.style.display="block",w.style.marginTop="8px";let k=document.createElement("input");k.type="file",k.accept="audio/*",k.style.display="none";let B=document.createElement("button");if(B.className="btn-secondary",B.textContent="Ajouter une note audio",B.onclick=h=>{h.preventDefault(),k.click()},k.onchange=async()=>{let h=k.files[0];if(!h)return;if(h.size>5*1024*1024){alert("Le fichier audio est trop volumineux (max 5\xA0Mo).");return}let L=new FileReader;L.onload=async T=>{let m=(T.target?.result||"").toString();try{await N(`/rehearsals/${t.id}`,"PUT",{audio:m,audioTitle:w.value}),Y(e)}catch(b){alert(b.message)}},L.readAsDataURL(h)},f.appendChild(w),f.appendChild(B),f.appendChild(k),r.appendChild(f),P){let h=document.createElement("div");h.style.marginTop="8px";let L=document.createElement("label");L.textContent="Partition(s)",h.appendChild(L);let T=document.createElement("div");(t.partitions||[]).forEach(g=>{let D=document.createElement("div"),A=document.createElement("span");A.textContent=`${g.displayName} \u2013 ${g.uploader} \u2013 ${ee(g.date)}`,D.appendChild(A);let M=document.createElement("a");if(M.href=g.downloadUrl,M.textContent="T\xE9l\xE9charger",M.target="_blank",M.rel="noopener noreferrer",M.className="btn-secondary",M.style.marginLeft="8px",D.appendChild(M),g.uploader===P.username||ie()){let $=document.createElement("button");$.className="btn-danger",$.textContent="Supprimer",$.style.marginLeft="8px",$.onclick=async V=>{if(V.preventDefault(),!!confirm("Supprimer cette partition\xA0?"))try{await me(t.id,g.id),await U(),Y(e)}catch(O){alert(O.message)}},D.appendChild($)}T.appendChild(D)}),h.appendChild(T);let m=document.createElement("input");m.type="file",m.accept="application/pdf",m.style.display="none";let b=document.createElement("button");b.className="btn-secondary",b.textContent="D\xE9poser une partition",b.onclick=g=>{g.preventDefault(),m.click()},m.onchange=async()=>{let g=m.files[0];if(g)try{await pe(t.id,g,g.name),await U(),Y(e)}catch(D){alert(D.message)}},h.appendChild(b),h.appendChild(m),r.appendChild(h)}let S=Object.keys(t.levels||{}).filter(h=>h.toLowerCase()!==P.username.toLowerCase());if(S.length>0){let h=document.createElement("div");h.style.marginTop="12px";let L=document.createElement("p");L.textContent="Autres membres :",L.style.fontStyle="italic",h.appendChild(L),S.forEach(T=>{let m=document.createElement("div");m.style.marginBottom="4px";let b=t.levels[T],g=t.notes&&t.notes[T]?t.notes[T]:"",D=document.createElement("p");D.style.margin="0";let A=document.createElement("strong");A.textContent=T,D.appendChild(A),D.appendChild(document.createTextNode(` \u2013 Niveau ${b}/10${g?" \u2013 "+g:""}`)),m.appendChild(D),(t.audioNotes&&t.audioNotes[T]||[]).forEach($=>{let V=document.createElement("audio");if(V.controls=!0,V.src=$.audio,V.style.display="block",V.style.marginTop="4px",$.title){let O=document.createElement("div");O.textContent=$.title,O.style.marginTop="4px",m.appendChild(O)}m.appendChild(V)}),h.appendChild(m)}),r.appendChild(h)}if(P&&(te()||P.id===t.creatorId)){let h=document.createElement("div");h.className="actions";let L=document.createElement("button");L.className="btn-secondary",L.textContent="Modifier",L.onclick=b=>{b.stopPropagation(),De(t,e)},h.appendChild(L);let T=document.createElement("button");T.className="btn-primary",T.textContent="Remettre dans J\u2019aime",T.onclick=async b=>{b.stopPropagation();try{await N(`/rehearsals/${t.id}/to-suggestion`,"POST"),Y(e)}catch(g){alert(g.message)}},h.appendChild(T);let m=document.createElement("button");m.className="btn-danger",m.textContent="Supprimer",m.onclick=async b=>{if(b.stopPropagation(),!!confirm("Supprimer ce morceau ?"))try{await N(`/rehearsals/${t.id}`,"DELETE"),I=I.filter(g=>g.id!==t.id),Y(e)}catch(g){alert(g.message)}},h.appendChild(m),r.appendChild(h)}o.appendChild(r),e.appendChild(o)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau en r\xE9p\xE9tition",a.textContent="+",a.onclick=()=>Se(e),e.appendChild(a)}function Se(e,n){let c=document.createElement("div");c.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Ajouter un morceau",a.appendChild(t);let o=document.createElement("form");o.onsubmit=w=>w.preventDefault();let l=document.createElement("label");l.textContent="Titre";let i=document.createElement("input");i.type="text",i.required=!0,i.style.width="100%";let d=document.createElement("label");d.textContent="Auteur";let p=document.createElement("input");p.type="text",p.style.width="100%";let r=document.createElement("label");r.textContent="Lien YouTube";let s=document.createElement("input");s.type="url",s.style.width="100%";let u=document.createElement("label");u.textContent="Lien Spotify";let y=document.createElement("input");y.type="url",y.style.width="100%";let x=document.createElement("label");x.textContent="Version de";let v=document.createElement("input");v.type="text",v.style.width="100%",o.appendChild(l),o.appendChild(i),o.appendChild(d),o.appendChild(p),o.appendChild(r),o.appendChild(s),o.appendChild(u),o.appendChild(y),o.appendChild(x),o.appendChild(v),a.appendChild(o);let C=document.createElement("div");C.className="modal-actions";let f=document.createElement("button");f.className="btn-secondary",f.textContent="Annuler",f.onclick=()=>{c.parentNode&&c.parentNode.removeChild(c)};let E=document.createElement("button");E.className="btn-primary",E.textContent="Ajouter",E.onclick=async w=>{w.preventDefault();let k=i.value.trim();if(!k)return;let B=p.value.trim(),S=s.value.trim(),h=y.value.trim(),L=v.value.trim();try{let T=await N("/rehearsals","POST",{title:k,author:B,youtube:S,spotify:h,versionOf:L});c.parentNode&&c.parentNode.removeChild(c),I.push(T),typeof n=="function"?n():Y(e)}catch(T){alert(T.message)}},C.appendChild(f),C.appendChild(E),a.appendChild(C),c.appendChild(a),document.body.appendChild(c),setTimeout(()=>i.focus(),50)}function De(e,n,c){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier le morceau",t.appendChild(o);let l=document.createElement("form");l.onsubmit=k=>k.preventDefault();let i=document.createElement("label");i.textContent="Titre";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.title;let p=document.createElement("label");p.textContent="Auteur";let r=document.createElement("input");r.type="text",r.style.width="100%",r.value=e.author||"";let s=document.createElement("label");s.textContent="Lien YouTube";let u=document.createElement("input");u.type="url",u.style.width="100%",u.value=e.youtube||"";let y=document.createElement("label");y.textContent="Lien Spotify";let x=document.createElement("input");x.type="url",x.style.width="100%",x.value=e.spotify||"";let v=document.createElement("label");v.textContent="Version de";let C=document.createElement("input");C.type="text",C.style.width="100%",C.value=e.versionOf||"",l.appendChild(i),l.appendChild(d),l.appendChild(p),l.appendChild(r),l.appendChild(s),l.appendChild(u),l.appendChild(y),l.appendChild(x),l.appendChild(v),l.appendChild(C),t.appendChild(l);let f=document.createElement("div");f.className="modal-actions";let E=document.createElement("button");E.className="btn-secondary",E.textContent="Annuler",E.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let w=document.createElement("button");w.className="btn-primary",w.textContent="Enregistrer",w.onclick=async k=>{k.preventDefault();let B=d.value.trim(),S=r.value.trim(),h=u.value.trim(),L=x.value.trim(),T=C.value.trim();if(B)try{await N(`/rehearsals/${e.id}`,"PUT",{title:B,author:S,youtube:h,spotify:L,versionOf:T}),a.parentNode&&a.parentNode.removeChild(a);let m=I.findIndex(b=>b.id===e.id);m!==-1&&(I[m]={...I[m],title:B,author:S||null,youtube:h||null,spotify:L||null,versionOf:T||null}),typeof c=="function"?c():Y(n)}catch(m){alert(m.message)}},f.appendChild(E),f.appendChild(w),t.appendChild(f),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function ne(e){e.innerHTML="";let n=document.createElement("h2");n.className="section-title",n.textContent="Prestations",e.appendChild(n);let c=[];try{c=await N("/performances")}catch{let p=document.createElement("p");p.style.color="var(--danger-color)",p.textContent="Impossible de r\xE9cup\xE9rer les prestations",e.appendChild(p);return}if(I.length===0)try{await U()}catch{}let a=new Date,t=c.filter(d=>new Date(d.date)>=a),o=c.filter(d=>new Date(d.date)<a);function l(d,p){let r=document.createElement("div");if(r.className="section-title",r.textContent=d,e.appendChild(r),p.length===0){let s=document.createElement("p");s.textContent="Aucune prestation",e.appendChild(s);return}p.forEach(s=>{let u=document.createElement("div");u.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-green-50";let y=document.createElement("h3");y.textContent=s.name,y.onclick=()=>{u.classList.toggle("collapsed")},u.appendChild(y);let x=document.createElement("div");x.className="card-details";let v=document.createElement("p");if(v.textContent="Date : "+ee(s.date),x.appendChild(v),s.location){let C=document.createElement("p");C.textContent="Lieu : "+s.location,x.appendChild(C)}if(s.songs&&s.songs.length>0){let C=document.createElement("ul");s.songs.forEach(f=>{let E=I.find(k=>k.id===f),w=document.createElement("li");w.textContent=E?E.title:"\u2014",C.appendChild(w)}),x.appendChild(C)}if(P&&(te()||P.id===s.creatorId)){let C=document.createElement("div");C.className="actions";let f=document.createElement("button");f.className="btn-secondary",f.textContent="Modifier",f.onclick=w=>{w.stopPropagation(),ve(s,e)},C.appendChild(f);let E=document.createElement("button");E.className="btn-danger",E.textContent="Supprimer",E.onclick=async w=>{if(w.stopPropagation(),!!confirm("Supprimer cette prestation ?"))try{await N(`/performances/${s.id}`,"DELETE"),ne(e)}catch(k){alert(k.message)}},C.appendChild(E),x.appendChild(C)}u.appendChild(x),e.appendChild(u)})}l("\xC0 venir",t),l("Pass\xE9es",o);let i=document.createElement("div");i.className="fab",i.title="Ajouter une prestation",i.textContent="+",i.onclick=()=>se(e),e.appendChild(i)}async function G(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Agenda",n.className="section-title",e.appendChild(n);let c=document.createElement("div");c.className="calendar-nav";let a=document.createElement("button");a.textContent="<",a.onclick=()=>{H.setMonth(H.getMonth()-1),G(e)};let t=document.createElement("button");t.textContent=">",t.onclick=()=>{H.setMonth(H.getMonth()+1),G(e)};let o=document.createElement("span");o.textContent=H.toLocaleDateString(void 0,{month:"long",year:"numeric"}),c.appendChild(a),c.appendChild(o),c.appendChild(t),e.appendChild(c);let l=document.createElement("div");l.className="actions";let i=document.createElement("button");i.className="btn-secondary",i.textContent="Nouvelle r\xE9p\xE9tition",i.onclick=()=>Ce(e,()=>G(e));let d=document.createElement("button");d.className="btn-secondary",d.textContent="Nouvelle prestation",d.onclick=()=>se(e,()=>G(e)),l.appendChild(i),l.appendChild(d),e.appendChild(l);let p=[];try{let f=H.getFullYear(),E=H.getMonth()+1,w=String(E).padStart(2,"0"),k=`${f}-${w}-01`,B=`${f}-${w}-31`;p=await N(`/agenda?start=${k}&end=${B}`)}catch{let E=document.createElement("p");E.style.color="var(--danger-color)",E.textContent="Impossible de r\xE9cup\xE9rer l'agenda",e.appendChild(E);return}p.sort((f,E)=>f.date.localeCompare(E.date));let r=document.createElement("div");r.className="calendar-grid",["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(f=>{let E=document.createElement("div");E.className="calendar-day-name",E.textContent=f,r.appendChild(E)});let u=H.getFullYear(),y=H.getMonth(),v=(new Date(u,y,1).getDay()+6)%7;for(let f=0;f<v;f++){let E=document.createElement("div");E.className="calendar-cell empty",r.appendChild(E)}let C=new Date(u,y+1,0).getDate();for(let f=1;f<=C;f++){let E=document.createElement("div");E.className="calendar-cell";let w=document.createElement("div");w.className="calendar-date",w.textContent=f,E.appendChild(w);let k=`${u}-${String(y+1).padStart(2,"0")}-${String(f).padStart(2,"0")}`,B=p.filter(S=>S.date?.startsWith(k));B.forEach(S=>{let h=document.createElement("div");h.className=`calendar-event ${S.type==="performance"?"performance":"rehearsal"}`;let L=S.title||S.location||"",T=S.type==="performance"?"Prestation":"R\xE9p\xE9tition";h.textContent=L||T,h.onclick=async m=>{if(m.preventDefault(),m.stopPropagation(),S.type==="performance")try{I.length===0&&await U();let g=(await N("/performances")).find(D=>D.id===S.id);g&&ve(g,e,()=>G(e))}catch(b){alert(b.message)}else Be(S,e,()=>G(e))},E.appendChild(h)}),B.length===0&&(E.onclick=async()=>{if(!te())return;if(confirm("Ajouter une prestation ? (Annuler pour une r\xE9p\xE9tition)")){try{I.length===0&&await U()}catch{}se(e,()=>G(e),k)}else Ce(e,()=>G(e),`${k}T20:00`)}),r.appendChild(E)}e.appendChild(r)}function Ce(e,n,c){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter une r\xE9p\xE9tition",t.appendChild(o);let l=document.createElement("form");l.onsubmit=x=>x.preventDefault();let i=document.createElement("label");i.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",c&&(d.value=c);let p=document.createElement("label");p.textContent="Lieu";let r=document.createElement("input");r.type="text",r.style.width="100%",l.appendChild(i),l.appendChild(d),l.appendChild(p),l.appendChild(r),t.appendChild(l);let s=document.createElement("div");s.className="modal-actions";let u=document.createElement("button");u.className="btn-secondary",u.textContent="Annuler",u.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let y=document.createElement("button");y.className="btn-primary",y.textContent="Ajouter",y.onclick=async x=>{x.preventDefault();let v=d.value;if(!v)return;let C=r.value.trim();try{await N("/agenda","POST",{type:"rehearsal",date:v,location:C}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"&&n()}catch(f){alert(f.message)}},s.appendChild(u),s.appendChild(y),t.appendChild(s),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function se(e,n,c){try{await U()}catch(k){alert(k.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter une prestation",t.appendChild(o);let l=document.createElement("form");l.onsubmit=k=>k.preventDefault();let i=document.createElement("label");i.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%";let p=document.createElement("label");p.textContent="Date";let r=document.createElement("input");r.type="date",r.required=!0,r.style.width="100%",c&&(r.value=c);let s=document.createElement("label");s.textContent="Heure";let u=document.createElement("input");u.type="time",u.required=!0,u.style.width="100%";let y=document.createElement("label");y.textContent="Lieu";let x=document.createElement("input");x.type="text",x.style.width="100%";let v=document.createElement("label");v.textContent="Morceaux jou\xE9s";let C=document.createElement("div");C.className="select-list",I.forEach(k=>{let B=document.createElement("label");B.style.display="flex",B.style.justifyContent="space-between",B.style.alignItems="center";let S=document.createElement("input");S.type="checkbox",S.value=k.id;let h=document.createElement("span");h.textContent=k.title,h.style.marginLeft="4px";let L=document.createElement("span");L.appendChild(S),L.appendChild(h);let T=document.createElement("span");T.className="level-badge";let m=Object.values(k.levels||{}).map(Number),b=m.length>0?m.reduce((g,D)=>g+D,0)/m.length:0;T.textContent=b.toFixed(1),B.appendChild(L),B.appendChild(T),C.appendChild(B)}),l.appendChild(i),l.appendChild(d),l.appendChild(p),l.appendChild(r),l.appendChild(s),l.appendChild(u),l.appendChild(y),l.appendChild(x),l.appendChild(v),l.appendChild(C),t.appendChild(l);let f=document.createElement("div");f.className="modal-actions";let E=document.createElement("button");E.className="btn-secondary",E.textContent="Annuler",E.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let w=document.createElement("button");w.className="btn-primary",w.textContent="Ajouter",w.onclick=async k=>{k.preventDefault();let B=d.value.trim(),S=r.value,h=u.value,L=x.value.trim();if(!B||!S||!h)return;let T=`${S}T${h}`,m=[];C.querySelectorAll('input[type="checkbox"]').forEach(g=>{g.checked&&m.push(Number(g.value))});let b=!1;for(let g of m){let D=I.find(A=>A.id===g);if(D){let A=Object.values(D.levels||{}).map(Number);if((A.length?Math.min(...A):0)<=6){b=!0;break}}}if(!(b&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Ajouter quand m\xEAme ?")))try{await N("/performances","POST",{name:B,date:T,location:L,songs:m}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"?n():ne(e)}catch(g){alert(g.message)}},f.appendChild(E),f.appendChild(w),t.appendChild(f),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Be(e,n,c){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la r\xE9p\xE9tition",t.appendChild(o);let l=document.createElement("form");l.onsubmit=x=>x.preventDefault();let i=document.createElement("label");i.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",d.value=e.date||"";let p=document.createElement("label");p.textContent="Lieu";let r=document.createElement("input");r.type="text",r.style.width="100%",r.value=e.location||"",l.appendChild(i),l.appendChild(d),l.appendChild(p),l.appendChild(r),t.appendChild(l);let s=document.createElement("div");s.className="modal-actions";let u=document.createElement("button");u.className="btn-secondary",u.textContent="Annuler",u.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let y=document.createElement("button");y.className="btn-primary",y.textContent="Enregistrer",y.onclick=async x=>{x.preventDefault();let v=d.value;if(!v)return;let C=r.value.trim();try{await N(`/agenda/${e.id}`,"PUT",{type:"rehearsal",date:v,location:C}),a.parentNode&&a.parentNode.removeChild(a),typeof c=="function"&&c()}catch(f){alert(f.message)}},s.appendChild(u),s.appendChild(y),t.appendChild(s),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function ve(e,n,c){try{await U()}catch(S){alert(S.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la prestation",t.appendChild(o);let l=document.createElement("form");l.onsubmit=S=>S.preventDefault();let i=document.createElement("label");i.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.name;let p=document.createElement("label");p.textContent="Date";let r=document.createElement("input");r.type="date",r.required=!0,r.style.width="100%";let[s,u]=(e.date||"").split("T");r.value=s;let y=document.createElement("label");y.textContent="Heure";let x=document.createElement("input");x.type="time",x.required=!0,x.style.width="100%",x.value=(u||"").slice(0,5);let v=document.createElement("label");v.textContent="Lieu";let C=document.createElement("input");C.type="text",C.style.width="100%",C.value=e.location||"";let f=document.createElement("label");f.textContent="Morceaux jou\xE9s";let E=document.createElement("div");E.className="select-list",I.forEach(S=>{let h=document.createElement("label");h.style.display="flex",h.style.justifyContent="space-between",h.style.alignItems="center";let L=document.createElement("input");L.type="checkbox",L.value=S.id,e.songs.includes(S.id)&&(L.checked=!0);let T=document.createElement("span");T.textContent=S.title,T.style.marginLeft="4px";let m=document.createElement("span");m.appendChild(L),m.appendChild(T);let b=document.createElement("span");b.className="level-badge";let g=Object.values(S.levels||{}).map(Number),D=g.length>0?g.reduce((A,M)=>A+M,0)/g.length:0;b.textContent=D.toFixed(1),h.appendChild(m),h.appendChild(b),E.appendChild(h)}),l.appendChild(i),l.appendChild(d),l.appendChild(p),l.appendChild(r),l.appendChild(y),l.appendChild(x),l.appendChild(v),l.appendChild(C),l.appendChild(f),l.appendChild(E),t.appendChild(l);let w=document.createElement("div");w.className="modal-actions";let k=document.createElement("button");k.className="btn-secondary",k.textContent="Annuler",k.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let B=document.createElement("button");B.className="btn-primary",B.textContent="Enregistrer",B.onclick=async S=>{S.preventDefault();let h=d.value.trim(),L=r.value,T=x.value,m=C.value.trim();if(!h||!L||!T)return;let b=`${L}T${T}`,g=[];E.querySelectorAll('input[type="checkbox"]').forEach(A=>{A.checked&&g.push(Number(A.value))});let D=!1;for(let A of g){let M=I.find($=>$.id===A);if(M){let $=Object.values(M.levels||{}).map(Number);if(($.length?Math.min(...$):0)<=6){D=!0;break}}}if(!(D&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Enregistrer quand m\xEAme ?")))try{await N(`/performances/${e.id}`,"PUT",{name:h,date:b,location:m,songs:g}),a.parentNode&&a.parentNode.removeChild(a),typeof c=="function"?c():ne(n)}catch(A){alert(A.message)}},w.appendChild(k),w.appendChild(B),t.appendChild(w),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Pe(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let c=document.createElement("h3");c.textContent="Groupes",n.appendChild(c);let a=document.createElement("select");a.id="group-select",n.appendChild(a);let t=document.createElement("div");t.style.marginTop="10px";let o=document.createElement("button");o.id="create-group-btn",o.className="btn-secondary",o.textContent="Cr\xE9er",t.appendChild(o);let l=document.createElement("button");l.id="join-group-btn",l.className="btn-secondary",l.textContent="Rejoindre",l.style.marginLeft="8px",t.appendChild(l);let i=document.createElement("button");if(i.id="rename-group-btn",i.className="btn-secondary",i.textContent="Renommer",i.style.marginLeft="8px",i.onclick=async()=>{let d=prompt("Nouveau nom du groupe",e.groupName);if(!d||d.trim()===""||d===e.groupName)return;let p=d.trim(),r=e.id||P.groupId;try{await N(`/groups/${r}`,"PUT",{name:p}),e.groupName=p,document.title=`${e.groupName} \u2013 BandTrack`;let s=document.getElementById("group-name");s&&(s.textContent=e.groupName),await W(r),await J(document.getElementById("app"))}catch(s){alert(s.message)}},t.appendChild(i),n.appendChild(t),ie()){let d=document.createElement("div");d.style.marginTop="8px";let p=e.invitationCode,r=document.createElement("span");r.textContent=`Code d'invitation : ${p}`,d.appendChild(r);let s=document.createElement("button");s.textContent="Copier",s.style.marginLeft="8px",s.onclick=()=>navigator.clipboard.writeText(p),d.appendChild(s);let u=document.createElement("button");u.textContent="Renouveler",u.style.marginLeft="8px",u.onclick=async()=>{try{p=(await N("/groups/renew-code","POST")).invitationCode,r.textContent=`Code d'invitation : ${p}`}catch(y){alert(y.message)}},d.appendChild(u),n.appendChild(d)}return n}function Ae(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");n.textContent="Mot de passe",e.appendChild(n);let c=document.createElement("form");c.onsubmit=p=>p.preventDefault();let a=document.createElement("label");a.textContent="Mot de passe actuel";let t=document.createElement("input");t.type="password",t.required=!0,t.style.width="100%";let o=document.createElement("label");o.textContent="Nouveau mot de passe";let l=document.createElement("input");l.type="password",l.required=!0,l.style.width="100%";let i=document.createElement("button");i.className="btn-primary",i.type="submit",i.textContent="Modifier",i.style.marginTop="8px";let d=document.createElement("p");return d.style.marginTop="8px",c.appendChild(a),c.appendChild(t),c.appendChild(o),c.appendChild(l),c.appendChild(i),c.appendChild(d),c.onsubmit=async p=>{p.preventDefault(),d.textContent="";try{await N("/password","PUT",{oldPassword:t.value,newPassword:l.value}),d.style.color="green",d.textContent="Mot de passe mis \xE0 jour",t.value="",l.value=""}catch(r){d.style.color="var(--danger-color)",d.textContent=r.message}},e.appendChild(c),e}function $e(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let c=document.createElement("h3");c.textContent="Th\xE8me",n.appendChild(c);let a=document.createElement("div"),t=document.createElement("label");t.textContent="Mode sombre",t.style.marginRight="8px";let o=document.createElement("input");o.type="checkbox",o.checked=e.darkMode,o.onchange=async()=>{e.darkMode=o.checked;try{await N("/settings","PUT",e),le(o.checked)}catch(r){alert(r.message)}},a.appendChild(t),a.appendChild(o),n.appendChild(a);let l=document.createElement("div");l.style.marginTop="20px";let i=document.createElement("label");i.textContent="Template (design)",i.style.marginRight="8px";let d=document.createElement("select");return[{value:"classic",label:"Classique"},{value:"groove",label:"Groove"},{value:"violet",label:"Violet"},{value:"imgbg",label:"Image"}].forEach(r=>{let s=document.createElement("option");s.value=r.value,s.textContent=r.label,d.appendChild(s)}),d.value=e.template||"classic",d.onchange=async()=>{let r=d.value;e.template=r;try{await N("/settings","PUT",e),re(r)}catch(s){alert(s.message)}},l.appendChild(i),l.appendChild(d),n.appendChild(l),n}async function Me(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");if(n.textContent="Membres",e.appendChild(n),q==null||P?.needsGroup){let c=document.createElement("p");return c.textContent="Aucun groupe actif",e.appendChild(c),e}try{let c=await N(`/groups/${q}/members`),a=document.createElement("table");a.className="user-table";let t=document.createElement("thead");t.innerHTML="<tr><th>Membre</th><th>R\xF4le</th></tr>",a.appendChild(t);let o=document.createElement("tbody");c.forEach(l=>{let i=document.createElement("tr"),d=document.createElement("td");d.textContent=l.username;let p=document.createElement("td");p.textContent=l.role,i.appendChild(d),i.appendChild(p),o.appendChild(i)}),a.appendChild(o),e.appendChild(a)}catch{let a=document.createElement("p");a.style.color="var(--danger-color)",a.textContent="Impossible de r\xE9cup\xE9rer les membres du groupe",e.appendChild(a)}return e}async function Ie(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let c=document.createElement("h3");if(c.textContent="Administration",n.appendChild(c),q==null||P?.needsGroup){let a=document.createElement("p");return a.textContent="Aucun groupe actif",n.appendChild(a),n}try{let a=await N("/context");if(!a){let m=document.createElement("p");return m.textContent="Aucun groupe actif",n.appendChild(m),n}let[t,o]=await Promise.all([N(`/groups/${q}/members`),N("/users")]),l=document.createElement("h4");l.textContent="Tableau de bord du groupe",l.style.marginTop="10px",n.appendChild(l);let i=document.createElement("div"),d=a.invitation_code,p=document.createElement("span");p.textContent=`Code d'invitation : ${d}`,i.appendChild(p);let r=document.createElement("button");r.textContent="Copier",r.style.marginLeft="8px",r.onclick=()=>navigator.clipboard.writeText(d),i.appendChild(r);let s=document.createElement("button");s.textContent="Renouveler",s.style.marginLeft="8px",s.onclick=async()=>{try{d=(await N("/groups/renew-code","POST")).invitationCode,p.textContent=`Code d'invitation : ${d}`}catch(m){alert(m.message)}},i.appendChild(s),n.appendChild(i);let u=document.createElement("table");u.className="user-table";let y=document.createElement("thead");y.innerHTML="<tr><th>Membre</th><th>R\xF4le</th><th>Actions</th></tr>",u.appendChild(y);let x=document.createElement("tbody");t.forEach(m=>{let b=document.createElement("tr"),g=document.createElement("td");g.textContent=m.username;let D=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach(V=>{let O=document.createElement("option");O.value=V,O.textContent=V,m.role===V&&(O.selected=!0),A.appendChild(O)}),m.userId===P.id&&(A.disabled=!0),A.onchange=async()=>{try{await N(`/groups/${q}/members`,"PUT",{id:m.id,role:A.value})}catch(V){alert(V.message)}},D.appendChild(A);let M=document.createElement("td"),$=document.createElement("button");$.textContent=m.userId===P.id?"Quitter":"Retirer",$.onclick=async()=>{let V=m.userId===P.id?"Quitter le groupe ?":"Supprimer ce membre ?";if(confirm(V))try{await N(`/groups/${q}/members`,"DELETE",{userId:m.userId}),m.userId===P.id?(alert("Quitter le groupe"),P.needsGroup=!0,Q()):(b.remove(),alert("Membre supprim\xE9"))}catch(O){alert(O.message)}},M.appendChild($),b.appendChild(g),b.appendChild(D),b.appendChild(M),x.appendChild(b)}),u.appendChild(x),n.appendChild(u);let v=new Set(t.map(m=>m.userId)),C=o.filter(m=>!v.has(m.id));if(C.length>0){let m=document.createElement("div"),b=document.createElement("select");C.forEach(D=>{let A=document.createElement("option");A.value=D.id,A.textContent=D.username,b.appendChild(A)}),m.appendChild(b);let g=document.createElement("button");g.textContent="Ajouter",g.style.marginLeft="8px",g.onclick=async()=>{try{let D=Number(b.value);await N(`/groups/${q}/members`,"POST",{userId:D,role:"user"}),J(e)}catch(D){alert(D.message)}},m.appendChild(g),n.appendChild(m)}let f=document.createElement("div"),E=document.createElement("input");E.type="email",E.placeholder="adresse e-mail",f.appendChild(E);let w=document.createElement("button");w.textContent="Inviter",w.style.marginLeft="8px",w.onclick=async()=>{let m=E.value.trim();if(m)try{let b=await N(`/groups/${q}/invite`,"POST",{email:m});b.temporaryPassword&&alert(`Mot de passe temporaire : ${b.temporaryPassword}`),J(e)}catch(b){alert(b.message)}},f.appendChild(w),n.appendChild(f);let k=document.createElement("h4");k.textContent="Gestion des utilisateurs",k.style.marginTop="30px",n.appendChild(k);let B=document.createElement("table");B.className="user-table";let S=document.createElement("thead");S.innerHTML="<tr><th>Utilisateur</th><th>R\xF4le</th></tr>",B.appendChild(S);let h=document.createElement("tbody"),L={};o.forEach(m=>{L[m.id]=m.role;let b=document.createElement("tr"),g=document.createElement("td");g.textContent=m.username;let D=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach(M=>{let $=document.createElement("option");$.value=M,$.textContent=M,m.role===M&&($.selected=!0),A.appendChild($)}),m.id===P.id&&(A.disabled=!0),A.dataset.userId=m.id,D.appendChild(A),b.appendChild(g),b.appendChild(D),h.appendChild(b)}),B.appendChild(h),n.appendChild(B);let T=document.createElement("button");T.className="btn-primary",T.style.marginTop="10px",T.textContent="Enregistrer les r\xF4les",T.onclick=async()=>{try{let m=[];h.querySelectorAll("select").forEach(b=>{let g=Number(b.dataset.userId),D=b.value;L[g]!==D&&m.push({id:g,role:D})});for(let b of m)await N(`/users/${b.id}`,"PUT",{role:b.role});alert("R\xF4les mis \xE0 jour"),J(e)}catch(m){alert(m.message)}},n.appendChild(T)}catch{let t=document.createElement("p");t.style.color="var(--danger-color)",t.textContent="Impossible de r\xE9cup\xE9rer les membres",n.appendChild(t)}return n}async function J(e){e.innerHTML="";let n=document.createElement("h2");if(n.className="section-title",n.textContent="Param\xE8tres",e.appendChild(n),P){let r=document.createElement("p");r.className="user-info",r.textContent=`Utilisateur connect\xE9: ${P.username}`,e.appendChild(r)}let c=document.createElement("div");c.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let a=document.createElement("button");a.className="logout-btn",a.textContent="Se d\xE9connecter",a.onclick=de,c.appendChild(a);let t=document.createElement("button");t.id="delete-account-btn",t.className="delete-account-btn",t.textContent="Supprimer mon compte",t.onclick=fe,c.appendChild(t);let o;try{o=await N("/settings")}catch{let s=document.createElement("p");s.style.color="var(--danger-color)",s.textContent="Impossible de r\xE9cup\xE9rer les param\xE8tres",e.appendChild(s),e.appendChild(c);return}let l={...o},i=Pe(l);e.appendChild(i);try{await W();let r=await Me();e.appendChild(r)}catch(r){console.error("Failed to load groups or members",r)}let d=$e(l);e.appendChild(d);let p=Ae();if(e.appendChild(p),e.appendChild(c),ie()){let r=await Ie(e);e.appendChild(r)}}window.addEventListener("DOMContentLoaded",xe)});je();})();
