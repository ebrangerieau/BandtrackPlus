(()=>{var oe=(e,n)=>()=>(e&&(n=e(e=0)),n);var be=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports);function ce(){R.rehearsalsCache=[]}var R,K=oe(()=>{R={currentUser:null,currentPage:"home",rehearsalsCache:[],groupsCache:[],activeGroupId:null,agendaDate:new Date}});async function N(e,n="GET",r){let a={method:n,credentials:"same-origin"};r!==void 0&&(a.headers={"Content-Type":"application/json"},a.body=JSON.stringify(r));let t=await fetch("/api"+e,a),o;try{o=await t.json()}catch{o=null}if(t.status===401)throw R.currentUser=null,new Error(o?.error||"Non authentifi\xE9");if(t.status===403&&o&&o.error==="No membership")throw R.currentUser&&(R.currentUser.needsGroup=!0),new Error("No membership");if(t.status===404&&e==="/context"&&n==="GET")return null;if(!t.ok)throw new Error(o&&o.error||"Erreur API");return o}function ge(e){return N(`/rehearsals/${e}/partitions`)}async function pe(e,n,r){let a=new FormData;a.append("file",n),r&&a.append("displayName",r);let t=await fetch(`/api/rehearsals/${e}/partitions`,{method:"POST",body:a,credentials:"same-origin"}),o;try{o=await t.json()}catch{o=null}if(t.status===401)throw R.currentUser=null,new Error(o?.error||"Non authentifi\xE9");if(!t.ok)throw new Error(o&&o.error||"Erreur API");return o}function me(e,n){return N(`/rehearsals/${e}/partitions/${n}`,"DELETE")}async function U(){let e=await N("/rehearsals"),n=await Promise.allSettled(e.map(a=>ge(a.id))),r=[];n.forEach((a,t)=>{let o=e[t];a.status==="fulfilled"?r.push({...o,partitions:a.value}):console.error(`Erreur lors de la r\xE9cup\xE9ration des partitions pour le morceau ${o.id}`,a.reason)}),R.rehearsalsCache=r}var le=oe(()=>{K();setInterval(()=>{R.currentUser&&U().catch(()=>{})},5*60*1e3)});async function _(){try{let e=await N("/me");if(R.currentUser=e,!e.needsGroup){let n=await N("/settings");X(n.darkMode),re(n.template||"classic"),document.title=`${n.groupName} \u2013 BandTrack`;let r=document.getElementById("group-name");r&&(r.textContent=n.groupName)}}catch{R.currentUser=null}}function X(e){let n=document.body;e?n.classList.add("dark"):n.classList.remove("dark")}function re(e){let n=document.body;n.classList.forEach(r=>{r.startsWith("template-")&&n.classList.remove(r)}),n.classList.add("template-"+e)}async function de(){try{await N("/logout","POST"),R.currentUser=null}catch(e){alert(e.message)}}var ue=oe(()=>{K();le()});var je=be(()=>{K();le();ue();var P=null,j="home",I=[],Z=[],q=null,H=new Date;Object.defineProperties(R,{currentUser:{get:()=>P,set:e=>P=e},currentPage:{get:()=>j,set:e=>j=e},rehearsalsCache:{get:()=>I,set:e=>I=e},groupsCache:{get:()=>Z,set:e=>Z=e},activeGroupId:{get:()=>q,set:e=>q=e},agendaDate:{get:()=>H,set:e=>H=e}});document.addEventListener("click",e=>{let n=document.getElementById("profile-menu"),r=document.getElementById("profile-btn");n&&!n.classList.contains("hidden")&&!n.contains(e.target)&&e.target!==r&&!r?.contains(e.target)&&(n.classList.add("hidden"),n.classList.remove("block","open"),r?.classList.remove("open"))});function ee(){let e=document.getElementById("profile-menu"),n=document.getElementById("profile-btn");!e||!n||(e.classList.toggle("hidden"),e.classList.toggle("block"),e.classList.toggle("open"),n.classList.toggle("open"))}function ne(){return P&&(P.membershipRole==="admin"||P.membershipRole==="moderator")}function ie(){return P&&P.membershipRole==="admin"}function te(e){if(!e)return"";let n=new Date(e);return isNaN(n)?e:n.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short",hour12:!1})}async function fe(){if(confirm("\xCAtes-vous s\xFBr de vouloir supprimer votre compte ?"))try{await N("/me","DELETE"),P=null,Q()}catch(n){alert(n.message)}}async function he(e){await N("/context","PUT",{groupId:Number(e)}),localStorage.setItem("activeGroupId",String(e)),q=Number(e),ce(),await _()}async function W(e){if(!P)return;let n=document.getElementById("group-select"),r=document.getElementById("create-group-btn"),a=document.getElementById("join-group-btn");r&&(r.onclick=()=>ye()),a&&(a.onclick=()=>Ee());try{Z=await N("/groups");let t=e||localStorage.getItem("activeGroupId");Z.some(o=>String(o.id)===String(t))||(t=Z[0]?Z[0].id:null),n&&(n.innerHTML="",Z.forEach(o=>{let c=document.createElement("option");c.value=o.id,c.textContent=o.name,n.appendChild(c)}),t&&(n.value=t),n.onchange=async()=>{await he(n.value),z(document.getElementById("app"))}),t&&await he(t)}catch(t){console.error(t)}}function ye(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let r=document.createElement("h3");r.textContent="Cr\xE9er un groupe",n.appendChild(r);let a=document.createElement("form");a.onsubmit=p=>p.preventDefault();let t=document.createElement("label");t.textContent="Nom du groupe";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%",a.appendChild(t),a.appendChild(o),n.appendChild(a);let c=document.createElement("div");c.className="modal-actions";let s=document.createElement("button");s.className="btn-secondary",s.textContent="Annuler",s.onclick=()=>e.remove();let d=document.createElement("button");d.className="btn-primary",d.textContent="Cr\xE9er",d.onclick=async()=>{let p=o.value.trim();if(p)try{let l=await N("/groups","POST",{name:p});alert("Code d'invitation : "+l.invitationCode),e.remove(),await W(l.id),z(document.getElementById("app"))}catch(l){alert(l.message)}},c.appendChild(s),c.appendChild(d),n.appendChild(c),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>o.focus(),50)}function Ee(){let e=document.createElement("div");e.className="modal";let n=document.createElement("div");n.className="modal-content";let r=document.createElement("h3");r.textContent="Rejoindre un groupe",n.appendChild(r);let a=document.createElement("form");a.onsubmit=i=>i.preventDefault();let t=document.createElement("label");t.textContent="Code d'invitation";let o=document.createElement("input");o.type="text",o.required=!0,o.style.width="100%";let c=document.createElement("label");c.textContent="Surnom";let s=document.createElement("input");s.type="text",s.style.width="100%",a.appendChild(t),a.appendChild(o),a.appendChild(c),a.appendChild(s),n.appendChild(a);let d=document.createElement("div");d.className="modal-actions";let p=document.createElement("button");p.className="btn-secondary",p.textContent="Annuler",p.onclick=()=>e.remove();let l=document.createElement("button");l.className="btn-primary",l.textContent="Rejoindre",l.onclick=async()=>{let i=o.value.trim(),f=s.value.trim();if(i)try{let E=await N("/groups/join","POST",{code:i,nickname:f});e.remove(),await W(E.groupId),z(document.getElementById("app"))}catch(E){alert(E.message)}},d.appendChild(p),d.appendChild(l),n.appendChild(d),e.appendChild(n),document.body.appendChild(e),setTimeout(()=>o.focus(),50)}async function xe(){await _(),P&&await W(),Q()}function Q(){let e=document.getElementById("app");if(P)P.needsGroup?we(e):z(e);else{let n=document.getElementById("group-name");n&&(n.textContent=""),ce(),Ne(e)}}function we(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let r=document.createElement("h2");r.textContent="Rejoindre ou cr\xE9er un groupe",n.appendChild(r);let a=document.createElement("p");a.textContent="Vous devez s\xE9lectionner ou cr\xE9er un groupe pour continuer.",n.appendChild(a);let t=document.createElement("p");t.textContent="Pour rejoindre un groupe existant, munissez-vous de son code d'invitation ou demandez \xE0 un administrateur de vous ajouter directement.",n.appendChild(t);let o=document.createElement("div"),c=document.createElement("button");c.className="btn-primary",c.textContent="Cr\xE9er un groupe",c.onclick=()=>ye(),o.appendChild(c);let s=document.createElement("button");s.className="btn-secondary",s.style.marginLeft="10px",s.textContent="Rejoindre un groupe",s.onclick=()=>Ee(),o.appendChild(s),n.appendChild(o);let d=document.createElement("button");d.id="delete-account-btn-group-setup",d.className="delete-account-btn",d.textContent="Supprimer mon compte",d.onclick=fe,n.appendChild(d),e.appendChild(n)}function Ne(e){e.innerHTML="";let n=document.createElement("div");n.className="auth-container";let r=!1;function a(){n.innerHTML="";let t=document.createElement("h2");t.textContent=r?"Inscription":"Connexion",n.appendChild(t);let o=document.createElement("form");o.onsubmit=async m=>{m.preventDefault(),r?await b():await v()};let c=document.createElement("label");c.textContent="Nom d\u2019utilisateur";let s=document.createElement("input");s.type="text",s.required=!0;let d=document.createElement("label");d.textContent="Mot de passe";let p=document.createElement("input");p.type="password",p.required=!0,o.appendChild(c),o.appendChild(s),o.appendChild(d),o.appendChild(p);let l;if(r){let m=document.createElement("label");m.textContent="Confirmer le mot de passe",l=document.createElement("input"),l.type="password",l.required=!0,o.appendChild(m),o.appendChild(l)}let i=document.createElement("div");i.style.color="var(--danger-color)",i.style.marginTop="12px",o.appendChild(i);let f=document.createElement("button");f.className="btn-primary",f.style.marginTop="20px",f.textContent=r?"S\u2019inscrire":"Se connecter",o.appendChild(f);let E=document.createElement("a");E.className="link",E.textContent=r?"D\xE9j\xE0 un compte ? Se connecter":"Cr\xE9er un compte",E.onclick=m=>{m.preventDefault(),r=!r,a()},n.appendChild(o),n.appendChild(E),e.appendChild(n);async function b(){let m=s.value.trim(),h=p.value,y=l?l.value:"";if(!m||!h){i.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}if(h!==y){i.textContent="Les mots de passe ne correspondent pas";return}try{await N("/register","POST",{username:m,password:h}),await _(),j="home",await W(),Q()}catch(w){i.textContent=w.message}}async function v(){let m=s.value.trim(),h=p.value;if(!m||!h){i.textContent="Veuillez saisir un nom d\u2019utilisateur et un mot de passe";return}try{await N("/login","POST",{username:m,password:h}),await _(),j="home",await W(),Q()}catch(y){i.textContent=y.message}}}a()}async function ke(e){e.innerHTML="";let n=document.createElement("div");n.className="home-container",e.appendChild(n);let r=P?P.username:"",a=document.createElement("div");a.className="welcome-section";let t=document.createElement("p"),o=document.createElement("strong");o.className="text-xl",o.textContent="Salut",t.appendChild(o),t.appendChild(document.createTextNode(` ${r}, voici o\xF9 en est votre groupe aujourd'hui...`)),a.appendChild(t),n.appendChild(a);let c=document.createElement("div");c.className="upcoming-section";let s=document.createElement("h3");s.textContent="\xC0 venir",c.appendChild(s);let d="Aucune prestation pr\xE9vue";try{let b=await N("/performances"),v=new Date,m=b.filter(h=>new Date(h.date)>=v);if(m.sort((h,y)=>new Date(h.date)-new Date(y.date)),m.length>0){let h=m[0];d=`${h.name} (${te(h.date)})`}}catch{d="Impossible de r\xE9cup\xE9rer les prestations"}let p=document.createElement("p"),l=document.createElement("strong");l.textContent="Prochaine prestation :",p.appendChild(l),p.appendChild(document.createTextNode(" "+d)),c.appendChild(p);let i="\u2014";try{let v=(await N("/agenda")).filter(y=>y.type==="rehearsal"),m=new Date,h=v.filter(y=>new Date(y.date)>=m);if(h.sort((y,w)=>new Date(y.date)-new Date(w.date)),h.length>0){let y=h[0];i=`${te(y.date)}${y.location?" \u2013 "+y.location:""}`}}catch{}let f=document.createElement("p"),E=document.createElement("strong");E.textContent="Prochaine r\xE9p\xE9tition :",f.appendChild(E),f.appendChild(document.createTextNode(" "+i)),c.appendChild(f),n.appendChild(c)}async function z(e){e.innerHTML="";let n=document.getElementById("profile-btn"),r=document.getElementById("profile-menu"),a=document.getElementById("menu-performances"),t=document.getElementById("menu-settings"),o=document.getElementById("menu-logout"),c=document.getElementById("theme-toggle");n&&r&&(n.onclick=l=>{l.stopPropagation(),ee()}),c&&(c.textContent=document.body.classList.contains("dark")?"\u2600\uFE0F":"\u{1F319}",c.onclick=async()=>{document.body.classList.toggle("dark");let l=document.body.classList.contains("dark");c.textContent=l?"\u2600\uFE0F":"\u{1F319}";try{let f={...await N("/settings"),darkMode:l};await N("/settings","PUT",f),X(f.darkMode)}catch(i){console.error(i)}}),a&&(a.onclick=()=>{j!=="performances"&&(j="performances",z(e)),r?.classList.contains("hidden")||ee()}),t&&(t.onclick=()=>{j!=="settings"&&(j="settings",z(e)),r?.classList.contains("hidden")||ee()}),o&&(o.onclick=async()=>{r?.classList.contains("hidden")||ee(),await de()});let s=document.createElement("div");s.className="page",e.appendChild(s);let d=document.createElement("div");if(d.className="nav-bar",[{key:"home",label:"Home",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>'},{key:"suggestions",label:"Suggestions",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"/></svg>'},{key:"rehearsals",label:"R\xE9p\xE8tes",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"/></svg>'},{key:"performances",label:"Prestations",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>'},{key:"agenda",label:"Agenda",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z"/></svg>'}].forEach(l=>{let i=document.createElement("button");i.innerHTML=`${l.icon}<span>${l.label}</span>`,i.className=j===l.key?"active":"",i.onclick=()=>{j!==l.key&&(j=l.key,z(e))},d.appendChild(i)}),e.appendChild(d),j==="home")ke(s);else if(j==="suggestions")F(s);else if(j==="rehearsals"){try{await U()}catch{}Y(s)}else if(j==="performances"){try{await U()}catch{}ae(s)}else if(j==="agenda"){try{await U()}catch{}G(s)}else j==="settings"&&J(s)}async function F(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux sugg\xE9r\xE9s",n.className="section-title",e.appendChild(n);let r=[];try{r=await N("/suggestions")}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les suggestions",e.appendChild(o);return}if(r.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucune proposition pour l\u2019instant",e.appendChild(t)}r.forEach(t=>{let o=document.createElement("div");o.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-pink-50 text-gray-900";let c=document.createElement("div");c.className="card-header";let s=document.createElement("h3");s.textContent=t.title,s.onclick=()=>{o.classList.toggle("collapsed")},c.appendChild(s);let d=document.createElement("div");d.className="like-info";let p=document.createElement("span");p.textContent=`\u2764\uFE0F ${t.likes||0}`;let l=document.createElement("button");l.className="like-btn",l.textContent="\u{1F44D}",l.onclick=async v=>{v.stopPropagation(),l.disabled=!0,i.disabled=!0;try{let m=await N(`/suggestions/${t.id}/vote`,"POST");p.textContent=`\u2764\uFE0F ${m.likes}`,await F(e)}catch(m){alert(m.message),l.disabled=!1,i.disabled=!1}};let i=document.createElement("button");i.className="like-btn",i.textContent="\u{1F44E}",i.onclick=async v=>{v.stopPropagation(),l.disabled=!0,i.disabled=!0;try{let m=await N(`/suggestions/${t.id}/vote`,"DELETE");p.textContent=`\u2764\uFE0F ${m.likes}`,await F(e)}catch(m){alert(m.message),l.disabled=!1,i.disabled=!1}},d.appendChild(p),d.appendChild(l),d.appendChild(i),c.appendChild(d),o.appendChild(c);let f=document.createElement("div");if(f.className="card-details",t.author){let v=document.createElement("p");v.style.fontStyle="italic",v.textContent="Auteur : "+t.author,f.appendChild(v)}if(t.versionOf){let v=document.createElement("p");v.style.fontStyle="italic",v.textContent="Version de : "+t.versionOf,f.appendChild(v)}let E=t.youtube||t.url;if(E){let v=document.createElement("a");v.href=E,v.target="_blank",v.rel="noopener noreferrer",v.textContent=E,f.appendChild(v)}let b=document.createElement("p");if(b.style.fontSize="12px",b.style.color="var(--text-color)",b.textContent=`Ajout\xE9 par ${t.creator}`,f.appendChild(b),P&&(ne()||t.creatorId===P.id||t.creator===P.username)){let v=document.createElement("div");v.className="actions";let m=document.createElement("button");m.className="btn-secondary",m.textContent="Modifier",m.onclick=w=>{w.stopPropagation(),Le(t,e)},v.appendChild(m);let h=document.createElement("button");h.className="btn-primary",h.textContent="Passer en r\xE9p\xE9tition",h.onclick=async w=>{w.stopPropagation();try{let k=await N(`/suggestions/${t.id}/to-rehearsal`,"POST");I.push(k),F(e)}catch(k){alert(k.message)}},v.appendChild(h);let y=document.createElement("button");y.className="btn-danger",y.textContent="Supprimer",y.onclick=async w=>{if(w.stopPropagation(),!!confirm("Supprimer cette suggestion ?"))try{await N(`/suggestions/${t.id}`,"DELETE"),F(e)}catch(k){alert(k.message)}},v.appendChild(y),f.appendChild(v)}o.appendChild(f),e.appendChild(o)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau",a.textContent="+",a.onclick=()=>Te(e),e.appendChild(a)}function Te(e){let n=document.createElement("div");n.className="modal";let r=document.createElement("div");r.className="modal-content";let a=document.createElement("h3");a.textContent="Ajouter une suggestion",r.appendChild(a);let t=document.createElement("form");t.onsubmit=m=>{m.preventDefault()};let o=document.createElement("label");o.textContent="Titre";let c=document.createElement("input");c.type="text",c.required=!0,c.style.width="100%";let s=document.createElement("label");s.textContent="Auteur";let d=document.createElement("input");d.type="text",d.style.width="100%";let p=document.createElement("label");p.textContent="Version de";let l=document.createElement("input");l.type="text",l.style.width="100%";let i=document.createElement("label");i.textContent="Lien YouTube";let f=document.createElement("input");f.type="url",f.style.width="100%",t.appendChild(o),t.appendChild(c),t.appendChild(s),t.appendChild(d),t.appendChild(p),t.appendChild(l),t.appendChild(i),t.appendChild(f),r.appendChild(t);let E=document.createElement("div");E.className="modal-actions";let b=document.createElement("button");b.className="btn-secondary",b.textContent="Annuler",b.onclick=()=>{n.parentNode&&n.parentNode.removeChild(n)};let v=document.createElement("button");v.className="btn-primary",v.textContent="Ajouter",v.onclick=async m=>{m.preventDefault();let h=c.value.trim(),y=d.value.trim(),w=l.value.trim(),k=f.value.trim();if(h)try{await N("/suggestions","POST",{title:h,author:y,youtube:k,versionOf:w}),n.parentNode&&n.parentNode.removeChild(n),F(e)}catch(B){alert(B.message)}},E.appendChild(b),E.appendChild(v),r.appendChild(E),n.appendChild(r),document.body.appendChild(n),setTimeout(()=>c.focus(),50)}function Le(e,n){let r=document.createElement("div");r.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Modifier la suggestion",a.appendChild(t);let o=document.createElement("form");o.onsubmit=h=>h.preventDefault();let c=document.createElement("label");c.textContent="Titre";let s=document.createElement("input");s.type="text",s.required=!0,s.style.width="100%",s.value=e.title;let d=document.createElement("label");d.textContent="Auteur";let p=document.createElement("input");p.type="text",p.style.width="100%",p.value=e.author||"";let l=document.createElement("label");l.textContent="Version de";let i=document.createElement("input");i.type="text",i.style.width="100%",i.value=e.versionOf||"";let f=document.createElement("label");f.textContent="Lien YouTube";let E=document.createElement("input");E.type="url",E.style.width="100%",E.value=e.youtube||e.url||"",o.appendChild(c),o.appendChild(s),o.appendChild(d),o.appendChild(p),o.appendChild(l),o.appendChild(i),o.appendChild(f),o.appendChild(E),a.appendChild(o);let b=document.createElement("div");b.className="modal-actions";let v=document.createElement("button");v.className="btn-secondary",v.textContent="Annuler",v.onclick=()=>{r.parentNode&&r.parentNode.removeChild(r)};let m=document.createElement("button");m.className="btn-primary",m.textContent="Enregistrer",m.onclick=async h=>{h.preventDefault();let y=s.value.trim(),w=p.value.trim(),k=i.value.trim(),B=E.value.trim();if(y)try{await N(`/suggestions/${e.id}`,"PUT",{title:y,author:w,versionOf:k,youtube:B}),r.parentNode&&r.parentNode.removeChild(r),F(n)}catch(S){alert(S.message)}},b.appendChild(v),b.appendChild(m),a.appendChild(b),r.appendChild(a),document.body.appendChild(r),setTimeout(()=>s.focus(),50)}async function Y(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Morceaux en cours de travail",n.className="section-title",e.appendChild(n);let r=I;if(r.length===0)try{await U(),r=I}catch{let o=document.createElement("p");o.style.color="var(--danger-color)",o.textContent="Impossible de r\xE9cup\xE9rer les r\xE9p\xE9titions",e.appendChild(o);return}if(r.length===0){let t=document.createElement("p");t.className="empty-state",t.textContent="Aucun morceau en r\xE9p\xE9tition",e.appendChild(t)}r.forEach(t=>{let o=document.createElement("div");o.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-blue-50";let c=t.levels[P.username]!=null?t.levels[P.username]:0,s=document.createElement("div");s.className="card-header";let d=document.createElement("h3");d.textContent=t.title,d.onclick=()=>{o.classList.toggle("collapsed")},s.appendChild(d);let p=document.createElement("span");p.className="level-badge",p.textContent=c,s.appendChild(p),o.appendChild(s);let l=document.createElement("div");if(l.className="card-details",t.author){let C=document.createElement("p");C.style.fontStyle="italic",C.textContent="Auteur : "+t.author,l.appendChild(C)}if(t.youtube){let C=document.createElement("a");C.href=t.youtube,C.target="_blank",C.rel="noopener noreferrer",C.textContent=t.youtube,l.appendChild(C)}let i=document.createElement("div");i.style.marginTop="8px";let f=document.createElement("label");f.textContent=`Votre niveau (${c}/10)`,f.className="level-display";let E=document.createElement("input");E.type="range",E.min=0,E.max=10,E.step=1,E.value=c;function b(C){let L=C/10,T=Math.round(255*(1-L)),u=Math.round(255*L);E.style.background=`linear-gradient(to right, rgb(${T},${u},80) ${C/10*100}%, var(--border-color) ${C/10*100}%)`}b(c),E.oninput=async()=>{let C=Number(E.value);f.textContent=`Votre niveau (${C}/10)`,p.textContent=C,b(C);try{await N(`/rehearsals/${t.id}`,"PUT",{level:C})}catch(L){alert(L.message)}},i.appendChild(f),i.appendChild(E),l.appendChild(i);let v=document.createElement("label");v.textContent="Vos notes";let m=document.createElement("textarea");m.value=t.notes&&t.notes[P.username]||"",m.onchange=async()=>{try{await N(`/rehearsals/${t.id}`,"PUT",{note:m.value})}catch(C){alert(C.message)}},l.appendChild(v),l.appendChild(m);let h=document.createElement("div");h.style.marginTop="8px",(t.audioNotes&&t.audioNotes[P.username]||[]).forEach((C,L)=>{let T=document.createElement("div");if(C.title){let x=document.createElement("div");x.textContent=C.title,T.appendChild(x)}let u=document.createElement("audio");u.controls=!0,u.src=C.audio,T.appendChild(u);let g=document.createElement("button");g.className="btn-danger",g.textContent="Supprimer audio",g.style.marginLeft="8px",g.onclick=async x=>{if(x.preventDefault(),!!confirm("Supprimer la note audio\xA0?"))try{await N(`/rehearsals/${t.id}`,"PUT",{audioIndex:L}),Y(e)}catch(D){alert(D.message)}},T.appendChild(g),h.appendChild(T)});let w=document.createElement("input");w.type="text",w.placeholder="Titre de la note",w.style.display="block",w.style.marginTop="8px";let k=document.createElement("input");k.type="file",k.accept="audio/*",k.style.display="none";let B=document.createElement("button");if(B.className="btn-secondary",B.textContent="Ajouter une note audio",B.onclick=C=>{C.preventDefault(),k.click()},k.onchange=async()=>{let C=k.files[0];if(!C)return;if(C.size>5*1024*1024){alert("Le fichier audio est trop volumineux (max 5\xA0Mo).");return}let L=new FileReader;L.onload=async T=>{let u=(T.target?.result||"").toString();try{await N(`/rehearsals/${t.id}`,"PUT",{audio:u,audioTitle:w.value}),Y(e)}catch(g){alert(g.message)}},L.readAsDataURL(C)},h.appendChild(w),h.appendChild(B),h.appendChild(k),l.appendChild(h),P){let C=document.createElement("div");C.style.marginTop="8px";let L=document.createElement("label");L.textContent="Partition(s)",C.appendChild(L);let T=document.createElement("div");(t.partitions||[]).forEach(x=>{let D=document.createElement("div"),A=document.createElement("span");A.textContent=`${x.displayName} \u2013 ${x.uploader} \u2013 ${te(x.date)}`,D.appendChild(A);let M=document.createElement("a");if(M.href=x.downloadUrl,M.textContent="T\xE9l\xE9charger",M.target="_blank",M.rel="noopener noreferrer",M.className="btn-secondary",M.style.marginLeft="8px",D.appendChild(M),x.uploader===P.username||ie()){let $=document.createElement("button");$.className="btn-danger",$.textContent="Supprimer",$.style.marginLeft="8px",$.onclick=async V=>{if(V.preventDefault(),!!confirm("Supprimer cette partition\xA0?"))try{await me(t.id,x.id),await U(),Y(e)}catch(O){alert(O.message)}},D.appendChild($)}T.appendChild(D)}),C.appendChild(T);let u=document.createElement("input");u.type="file",u.accept="application/pdf",u.style.display="none";let g=document.createElement("button");g.className="btn-secondary",g.textContent="D\xE9poser une partition",g.onclick=x=>{x.preventDefault(),u.click()},u.onchange=async()=>{let x=u.files[0];if(x)try{await pe(t.id,x,x.name),await U(),Y(e)}catch(D){alert(D.message)}},C.appendChild(g),C.appendChild(u),l.appendChild(C)}let S=Object.keys(t.levels||{}).filter(C=>C.toLowerCase()!==P.username.toLowerCase());if(S.length>0){let C=document.createElement("div");C.style.marginTop="12px";let L=document.createElement("p");L.textContent="Autres membres :",L.style.fontStyle="italic",C.appendChild(L),S.forEach(T=>{let u=document.createElement("div");u.style.marginBottom="4px";let g=t.levels[T],x=t.notes&&t.notes[T]?t.notes[T]:"",D=document.createElement("p");D.style.margin="0";let A=document.createElement("strong");A.textContent=T,D.appendChild(A),D.appendChild(document.createTextNode(` \u2013 Niveau ${g}/10${x?" \u2013 "+x:""}`)),u.appendChild(D),(t.audioNotes&&t.audioNotes[T]||[]).forEach($=>{let V=document.createElement("audio");if(V.controls=!0,V.src=$.audio,V.style.display="block",V.style.marginTop="4px",$.title){let O=document.createElement("div");O.textContent=$.title,O.style.marginTop="4px",u.appendChild(O)}u.appendChild(V)}),C.appendChild(u)}),l.appendChild(C)}if(P&&(ne()||P.id===t.creatorId)){let C=document.createElement("div");C.className="actions";let L=document.createElement("button");L.className="btn-secondary",L.textContent="Modifier",L.onclick=g=>{g.stopPropagation(),De(t,e)},C.appendChild(L);let T=document.createElement("button");T.className="btn-primary",T.textContent="Remettre dans J\u2019aime",T.onclick=async g=>{g.stopPropagation();try{await N(`/rehearsals/${t.id}/to-suggestion`,"POST"),Y(e)}catch(x){alert(x.message)}},C.appendChild(T);let u=document.createElement("button");u.className="btn-danger",u.textContent="Supprimer",u.onclick=async g=>{if(g.stopPropagation(),!!confirm("Supprimer ce morceau ?"))try{await N(`/rehearsals/${t.id}`,"DELETE"),I=I.filter(x=>x.id!==t.id),Y(e)}catch(x){alert(x.message)}},C.appendChild(u),l.appendChild(C)}o.appendChild(l),e.appendChild(o)});let a=document.createElement("div");a.className="fab",a.title="Ajouter un morceau en r\xE9p\xE9tition",a.textContent="+",a.onclick=()=>Se(e),e.appendChild(a)}function Se(e,n){let r=document.createElement("div");r.className="modal";let a=document.createElement("div");a.className="modal-content";let t=document.createElement("h3");t.textContent="Ajouter un morceau",a.appendChild(t);let o=document.createElement("form");o.onsubmit=w=>w.preventDefault();let c=document.createElement("label");c.textContent="Titre";let s=document.createElement("input");s.type="text",s.required=!0,s.style.width="100%";let d=document.createElement("label");d.textContent="Auteur";let p=document.createElement("input");p.type="text",p.style.width="100%";let l=document.createElement("label");l.textContent="Lien YouTube";let i=document.createElement("input");i.type="url",i.style.width="100%";let f=document.createElement("label");f.textContent="Lien Spotify";let E=document.createElement("input");E.type="url",E.style.width="100%";let b=document.createElement("label");b.textContent="Version de";let v=document.createElement("input");v.type="text",v.style.width="100%",o.appendChild(c),o.appendChild(s),o.appendChild(d),o.appendChild(p),o.appendChild(l),o.appendChild(i),o.appendChild(f),o.appendChild(E),o.appendChild(b),o.appendChild(v),a.appendChild(o);let m=document.createElement("div");m.className="modal-actions";let h=document.createElement("button");h.className="btn-secondary",h.textContent="Annuler",h.onclick=()=>{r.parentNode&&r.parentNode.removeChild(r)};let y=document.createElement("button");y.className="btn-primary",y.textContent="Ajouter",y.onclick=async w=>{w.preventDefault();let k=s.value.trim();if(!k)return;let B=p.value.trim(),S=i.value.trim(),C=E.value.trim(),L=v.value.trim();try{let T=await N("/rehearsals","POST",{title:k,author:B,youtube:S,spotify:C,versionOf:L});r.parentNode&&r.parentNode.removeChild(r),I.push(T),typeof n=="function"?n():Y(e)}catch(T){alert(T.message)}},m.appendChild(h),m.appendChild(y),a.appendChild(m),r.appendChild(a),document.body.appendChild(r),setTimeout(()=>s.focus(),50)}function De(e,n,r){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier le morceau",t.appendChild(o);let c=document.createElement("form");c.onsubmit=k=>k.preventDefault();let s=document.createElement("label");s.textContent="Titre";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.title;let p=document.createElement("label");p.textContent="Auteur";let l=document.createElement("input");l.type="text",l.style.width="100%",l.value=e.author||"";let i=document.createElement("label");i.textContent="Lien YouTube";let f=document.createElement("input");f.type="url",f.style.width="100%",f.value=e.youtube||"";let E=document.createElement("label");E.textContent="Lien Spotify";let b=document.createElement("input");b.type="url",b.style.width="100%",b.value=e.spotify||"";let v=document.createElement("label");v.textContent="Version de";let m=document.createElement("input");m.type="text",m.style.width="100%",m.value=e.versionOf||"",c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(l),c.appendChild(i),c.appendChild(f),c.appendChild(E),c.appendChild(b),c.appendChild(v),c.appendChild(m),t.appendChild(c);let h=document.createElement("div");h.className="modal-actions";let y=document.createElement("button");y.className="btn-secondary",y.textContent="Annuler",y.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let w=document.createElement("button");w.className="btn-primary",w.textContent="Enregistrer",w.onclick=async k=>{k.preventDefault();let B=d.value.trim(),S=l.value.trim(),C=f.value.trim(),L=b.value.trim(),T=m.value.trim();if(B)try{await N(`/rehearsals/${e.id}`,"PUT",{title:B,author:S,youtube:C,spotify:L,versionOf:T}),a.parentNode&&a.parentNode.removeChild(a);let u=I.findIndex(g=>g.id===e.id);u!==-1&&(I[u]={...I[u],title:B,author:S||null,youtube:C||null,spotify:L||null,versionOf:T||null}),typeof r=="function"?r():Y(n)}catch(u){alert(u.message)}},h.appendChild(y),h.appendChild(w),t.appendChild(h),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function ae(e){e.innerHTML="";let n=document.createElement("h2");n.className="section-title",n.textContent="Prestations",e.appendChild(n);let r=[];try{r=await N("/performances")}catch{let p=document.createElement("p");p.style.color="var(--danger-color)",p.textContent="Impossible de r\xE9cup\xE9rer les prestations",e.appendChild(p);return}if(I.length===0)try{await U()}catch{}let a=new Date,t=r.filter(d=>new Date(d.date)>=a),o=r.filter(d=>new Date(d.date)<a);function c(d,p){let l=document.createElement("div");if(l.className="section-title",l.textContent=d,e.appendChild(l),p.length===0){let i=document.createElement("p");i.textContent="Aucune prestation",e.appendChild(i);return}p.forEach(i=>{let f=document.createElement("div");f.className="card collapsed bg-white rounded-lg shadow-md p-4 bg-green-50";let E=document.createElement("h3");E.textContent=i.name,E.onclick=()=>{f.classList.toggle("collapsed")},f.appendChild(E);let b=document.createElement("div");b.className="card-details";let v=document.createElement("p");if(v.textContent="Date : "+te(i.date),b.appendChild(v),i.location){let m=document.createElement("p");m.textContent="Lieu : "+i.location,b.appendChild(m)}if(i.songs&&i.songs.length>0){let m=document.createElement("ul");i.songs.forEach(h=>{let y=I.find(k=>k.id===h),w=document.createElement("li");w.textContent=y?y.title:"\u2014",m.appendChild(w)}),b.appendChild(m)}if(P&&(ne()||P.id===i.creatorId)){let m=document.createElement("div");m.className="actions";let h=document.createElement("button");h.className="btn-secondary",h.textContent="Modifier",h.onclick=w=>{w.stopPropagation(),ve(i,e)},m.appendChild(h);let y=document.createElement("button");y.className="btn-danger",y.textContent="Supprimer",y.onclick=async w=>{if(w.stopPropagation(),!!confirm("Supprimer cette prestation ?"))try{await N(`/performances/${i.id}`,"DELETE"),ae(e)}catch(k){alert(k.message)}},m.appendChild(y),b.appendChild(m)}f.appendChild(b),e.appendChild(f)})}c("\xC0 venir",t),c("Pass\xE9es",o);let s=document.createElement("div");s.className="fab",s.title="Ajouter une prestation",s.textContent="+",s.onclick=()=>se(e),e.appendChild(s)}async function G(e){e.innerHTML="";let n=document.createElement("h2");n.textContent="Agenda",n.className="section-title",e.appendChild(n);let r=document.createElement("div");r.className="calendar-nav";let a=document.createElement("button");a.textContent="<",a.onclick=()=>{H.setMonth(H.getMonth()-1),G(e)};let t=document.createElement("button");t.textContent=">",t.onclick=()=>{H.setMonth(H.getMonth()+1),G(e)};let o=document.createElement("span");o.textContent=H.toLocaleDateString(void 0,{month:"long",year:"numeric"}),r.appendChild(a),r.appendChild(o),r.appendChild(t),e.appendChild(r);let c=document.createElement("div");c.className="actions";let s=document.createElement("button");s.className="btn-secondary",s.textContent="Nouvelle r\xE9p\xE9tition",s.onclick=()=>Ce(e,()=>G(e));let d=document.createElement("button");d.className="btn-secondary",d.textContent="Nouvelle prestation",d.onclick=()=>se(e,()=>G(e)),c.appendChild(s),c.appendChild(d),e.appendChild(c);let p=[];try{let h=H.getFullYear(),y=H.getMonth()+1,w=String(y).padStart(2,"0"),k=`${h}-${w}-01`,B=`${h}-${w}-31`;p=await N(`/agenda?start=${k}&end=${B}`)}catch{let y=document.createElement("p");y.style.color="var(--danger-color)",y.textContent="Impossible de r\xE9cup\xE9rer l'agenda",e.appendChild(y);return}p.sort((h,y)=>h.date.localeCompare(y.date));let l=document.createElement("div");l.className="calendar-grid",["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(h=>{let y=document.createElement("div");y.className="calendar-day-name",y.textContent=h,l.appendChild(y)});let f=H.getFullYear(),E=H.getMonth(),v=(new Date(f,E,1).getDay()+6)%7;for(let h=0;h<v;h++){let y=document.createElement("div");y.className="calendar-cell empty",l.appendChild(y)}let m=new Date(f,E+1,0).getDate();for(let h=1;h<=m;h++){let y=document.createElement("div");y.className="calendar-cell";let w=document.createElement("div");w.className="calendar-date",w.textContent=h,y.appendChild(w);let k=`${f}-${String(E+1).padStart(2,"0")}-${String(h).padStart(2,"0")}`,B=p.filter(S=>S.date?.startsWith(k));B.forEach(S=>{let C=document.createElement("div");C.className=`calendar-event ${S.type==="performance"?"performance":"rehearsal"}`;let L=S.title||S.location||"",T=S.type==="performance"?"Prestation":"R\xE9p\xE9tition";C.textContent=L||T,C.onclick=async u=>{if(u.preventDefault(),u.stopPropagation(),S.type==="performance")try{I.length===0&&await U();let x=(await N("/performances")).find(D=>D.id===S.id);x&&ve(x,e,()=>G(e))}catch(g){alert(g.message)}else Be(S,e,()=>G(e))},y.appendChild(C)}),B.length===0&&(y.onclick=async()=>{if(!ne())return;if(confirm("Ajouter une prestation ? (Annuler pour une r\xE9p\xE9tition)")){try{I.length===0&&await U()}catch{}se(e,()=>G(e),k)}else Ce(e,()=>G(e),`${k}T20:00`)}),l.appendChild(y)}e.appendChild(l)}function Ce(e,n,r){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter une r\xE9p\xE9tition",t.appendChild(o);let c=document.createElement("form");c.onsubmit=b=>b.preventDefault();let s=document.createElement("label");s.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",r&&(d.value=r);let p=document.createElement("label");p.textContent="Lieu";let l=document.createElement("input");l.type="text",l.style.width="100%",c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(l),t.appendChild(c);let i=document.createElement("div");i.className="modal-actions";let f=document.createElement("button");f.className="btn-secondary",f.textContent="Annuler",f.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let E=document.createElement("button");E.className="btn-primary",E.textContent="Ajouter",E.onclick=async b=>{b.preventDefault();let v=d.value;if(!v)return;let m=l.value.trim();try{await N("/agenda","POST",{type:"rehearsal",date:v,location:m}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"&&n()}catch(h){alert(h.message)}},i.appendChild(f),i.appendChild(E),t.appendChild(i),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function se(e,n,r){try{await U()}catch(k){alert(k.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Ajouter une prestation",t.appendChild(o);let c=document.createElement("form");c.onsubmit=k=>k.preventDefault();let s=document.createElement("label");s.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%";let p=document.createElement("label");p.textContent="Date";let l=document.createElement("input");l.type="date",l.required=!0,l.style.width="100%",r&&(l.value=r);let i=document.createElement("label");i.textContent="Heure";let f=document.createElement("input");f.type="time",f.required=!0,f.style.width="100%";let E=document.createElement("label");E.textContent="Lieu";let b=document.createElement("input");b.type="text",b.style.width="100%";let v=document.createElement("label");v.textContent="Morceaux jou\xE9s";let m=document.createElement("div");m.className="select-list",I.forEach(k=>{let B=document.createElement("label");B.style.display="flex",B.style.justifyContent="space-between",B.style.alignItems="center";let S=document.createElement("input");S.type="checkbox",S.value=k.id;let C=document.createElement("span");C.textContent=k.title,C.style.marginLeft="4px";let L=document.createElement("span");L.appendChild(S),L.appendChild(C);let T=document.createElement("span");T.className="level-badge";let u=Object.values(k.levels||{}).map(Number),g=u.length>0?u.reduce((x,D)=>x+D,0)/u.length:0;T.textContent=g.toFixed(1),B.appendChild(L),B.appendChild(T),m.appendChild(B)}),c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(l),c.appendChild(i),c.appendChild(f),c.appendChild(E),c.appendChild(b),c.appendChild(v),c.appendChild(m),t.appendChild(c);let h=document.createElement("div");h.className="modal-actions";let y=document.createElement("button");y.className="btn-secondary",y.textContent="Annuler",y.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let w=document.createElement("button");w.className="btn-primary",w.textContent="Ajouter",w.onclick=async k=>{k.preventDefault();let B=d.value.trim(),S=l.value,C=f.value,L=b.value.trim();if(!B||!S||!C)return;let T=`${S}T${C}`,u=[];m.querySelectorAll('input[type="checkbox"]').forEach(x=>{x.checked&&u.push(Number(x.value))});let g=!1;for(let x of u){let D=I.find(A=>A.id===x);if(D){let A=Object.values(D.levels||{}).map(Number);if((A.length?Math.min(...A):0)<=6){g=!0;break}}}if(!(g&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Ajouter quand m\xEAme ?")))try{await N("/performances","POST",{name:B,date:T,location:L,songs:u}),a.parentNode&&a.parentNode.removeChild(a),typeof n=="function"?n():ae(e)}catch(x){alert(x.message)}},h.appendChild(y),h.appendChild(w),t.appendChild(h),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Be(e,n,r){let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la r\xE9p\xE9tition",t.appendChild(o);let c=document.createElement("form");c.onsubmit=b=>b.preventDefault();let s=document.createElement("label");s.textContent="Date et heure";let d=document.createElement("input");d.type="datetime-local",d.required=!0,d.style.width="100%",d.value=e.date||"";let p=document.createElement("label");p.textContent="Lieu";let l=document.createElement("input");l.type="text",l.style.width="100%",l.value=e.location||"",c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(l),t.appendChild(c);let i=document.createElement("div");i.className="modal-actions";let f=document.createElement("button");f.className="btn-secondary",f.textContent="Annuler",f.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let E=document.createElement("button");E.className="btn-primary",E.textContent="Enregistrer",E.onclick=async b=>{b.preventDefault();let v=d.value;if(!v)return;let m=l.value.trim();try{await N(`/agenda/${e.id}`,"PUT",{type:"rehearsal",date:v,location:m}),a.parentNode&&a.parentNode.removeChild(a),typeof r=="function"&&r()}catch(h){alert(h.message)}},i.appendChild(f),i.appendChild(E),t.appendChild(i),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}async function ve(e,n,r){try{await U()}catch(S){alert(S.message);return}let a=document.createElement("div");a.className="modal";let t=document.createElement("div");t.className="modal-content";let o=document.createElement("h3");o.textContent="Modifier la prestation",t.appendChild(o);let c=document.createElement("form");c.onsubmit=S=>S.preventDefault();let s=document.createElement("label");s.textContent="Nom";let d=document.createElement("input");d.type="text",d.required=!0,d.style.width="100%",d.value=e.name;let p=document.createElement("label");p.textContent="Date";let l=document.createElement("input");l.type="date",l.required=!0,l.style.width="100%";let[i,f]=(e.date||"").split("T");l.value=i;let E=document.createElement("label");E.textContent="Heure";let b=document.createElement("input");b.type="time",b.required=!0,b.style.width="100%",b.value=(f||"").slice(0,5);let v=document.createElement("label");v.textContent="Lieu";let m=document.createElement("input");m.type="text",m.style.width="100%",m.value=e.location||"";let h=document.createElement("label");h.textContent="Morceaux jou\xE9s";let y=document.createElement("div");y.className="select-list",I.forEach(S=>{let C=document.createElement("label");C.style.display="flex",C.style.justifyContent="space-between",C.style.alignItems="center";let L=document.createElement("input");L.type="checkbox",L.value=S.id,e.songs.includes(S.id)&&(L.checked=!0);let T=document.createElement("span");T.textContent=S.title,T.style.marginLeft="4px";let u=document.createElement("span");u.appendChild(L),u.appendChild(T);let g=document.createElement("span");g.className="level-badge";let x=Object.values(S.levels||{}).map(Number),D=x.length>0?x.reduce((A,M)=>A+M,0)/x.length:0;g.textContent=D.toFixed(1),C.appendChild(u),C.appendChild(g),y.appendChild(C)}),c.appendChild(s),c.appendChild(d),c.appendChild(p),c.appendChild(l),c.appendChild(E),c.appendChild(b),c.appendChild(v),c.appendChild(m),c.appendChild(h),c.appendChild(y),t.appendChild(c);let w=document.createElement("div");w.className="modal-actions";let k=document.createElement("button");k.className="btn-secondary",k.textContent="Annuler",k.onclick=()=>{a.parentNode&&a.parentNode.removeChild(a)};let B=document.createElement("button");B.className="btn-primary",B.textContent="Enregistrer",B.onclick=async S=>{S.preventDefault();let C=d.value.trim(),L=l.value,T=b.value,u=m.value.trim();if(!C||!L||!T)return;let g=`${L}T${T}`,x=[];y.querySelectorAll('input[type="checkbox"]').forEach(A=>{A.checked&&x.push(Number(A.value))});let D=!1;for(let A of x){let M=I.find($=>$.id===A);if(M){let $=Object.values(M.levels||{}).map(Number);if(($.length?Math.min(...$):0)<=6){D=!0;break}}}if(!(D&&!confirm("Ce morceau n\u2019est probablement pas suffisamment r\xE9p\xE9t\xE9. Enregistrer quand m\xEAme ?")))try{await N(`/performances/${e.id}`,"PUT",{name:C,date:g,location:u,songs:x}),a.parentNode&&a.parentNode.removeChild(a),typeof r=="function"?r():ae(n)}catch(A){alert(A.message)}},w.appendChild(k),w.appendChild(B),t.appendChild(w),a.appendChild(t),document.body.appendChild(a),setTimeout(()=>d.focus(),50)}function Pe(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");r.textContent="Groupes",n.appendChild(r);let a=document.createElement("select");a.id="group-select",n.appendChild(a);let t=document.createElement("div");t.style.marginTop="10px";let o=document.createElement("button");o.id="create-group-btn",o.className="btn-secondary",o.textContent="Cr\xE9er",t.appendChild(o);let c=document.createElement("button");c.id="join-group-btn",c.className="btn-secondary",c.textContent="Rejoindre",c.style.marginLeft="8px",t.appendChild(c);let s=document.createElement("button");if(s.id="rename-group-btn",s.className="btn-secondary",s.textContent="Renommer",s.style.marginLeft="8px",s.onclick=async()=>{let d=prompt("Nouveau nom du groupe",e.groupName);if(!d||d.trim()===""||d===e.groupName)return;let p=d.trim(),l=e.id||P.groupId;try{await N(`/groups/${l}`,"PUT",{name:p}),e.groupName=p,document.title=`${e.groupName} \u2013 BandTrack`;let i=document.getElementById("group-name");i&&(i.textContent=e.groupName),await W(l),await J(document.getElementById("app"))}catch(i){alert(i.message)}},t.appendChild(s),n.appendChild(t),ie()){let d=document.createElement("div");d.style.marginTop="8px";let p=e.invitationCode,l=document.createElement("span");l.textContent=`Code d'invitation : ${p}`,d.appendChild(l);let i=document.createElement("button");i.textContent="Copier",i.style.marginLeft="8px",i.onclick=()=>navigator.clipboard.writeText(p),d.appendChild(i);let f=document.createElement("button");f.textContent="Renouveler",f.style.marginLeft="8px",f.onclick=async()=>{try{p=(await N("/groups/renew-code","POST")).invitationCode,l.textContent=`Code d'invitation : ${p}`}catch(E){alert(E.message)}},d.appendChild(f),n.appendChild(d)}return n}function Ae(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");n.textContent="Mot de passe",e.appendChild(n);let r=document.createElement("form");r.onsubmit=p=>p.preventDefault();let a=document.createElement("label");a.textContent="Mot de passe actuel";let t=document.createElement("input");t.type="password",t.required=!0,t.style.width="100%";let o=document.createElement("label");o.textContent="Nouveau mot de passe";let c=document.createElement("input");c.type="password",c.required=!0,c.style.width="100%";let s=document.createElement("button");s.className="btn-primary",s.type="submit",s.textContent="Modifier",s.style.marginTop="8px";let d=document.createElement("p");return d.style.marginTop="8px",r.appendChild(a),r.appendChild(t),r.appendChild(o),r.appendChild(c),r.appendChild(s),r.appendChild(d),r.onsubmit=async p=>{p.preventDefault(),d.textContent="";try{await N("/password","PUT",{oldPassword:t.value,newPassword:c.value}),d.style.color="green",d.textContent="Mot de passe mis \xE0 jour",t.value="",c.value=""}catch(l){d.style.color="var(--danger-color)",d.textContent=l.message}},e.appendChild(r),e}function $e(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");r.textContent="Th\xE8me",n.appendChild(r);let a=document.createElement("div"),t=document.createElement("label");t.textContent="Mode sombre",t.style.marginRight="8px";let o=document.createElement("input");o.type="checkbox",o.checked=e.darkMode,o.onchange=async()=>{e.darkMode=o.checked;try{await N("/settings","PUT",e),X(o.checked)}catch(l){alert(l.message)}},a.appendChild(t),a.appendChild(o),n.appendChild(a);let c=document.createElement("div");c.style.marginTop="20px";let s=document.createElement("label");s.textContent="Template (design)",s.style.marginRight="8px";let d=document.createElement("select");return[{value:"classic",label:"Classique"},{value:"groove",label:"Groove"},{value:"violet",label:"Violet"},{value:"imgbg",label:"Image"}].forEach(l=>{let i=document.createElement("option");i.value=l.value,i.textContent=l.label,d.appendChild(i)}),d.value=e.template||"classic",d.onchange=async()=>{let l=d.value;e.template=l;try{await N("/settings","PUT",e),re(l)}catch(i){alert(i.message)}},c.appendChild(s),c.appendChild(d),n.appendChild(c),n}async function Me(){let e=document.createElement("div");e.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let n=document.createElement("h3");if(n.textContent="Membres",e.appendChild(n),q==null||P?.needsGroup){let r=document.createElement("p");return r.textContent="Aucun groupe actif",e.appendChild(r),e}try{let r=await N(`/groups/${q}/members`),a=document.createElement("table");a.className="user-table";let t=document.createElement("thead");t.innerHTML="<tr><th>Membre</th><th>R\xF4le</th></tr>",a.appendChild(t);let o=document.createElement("tbody");r.forEach(c=>{let s=document.createElement("tr"),d=document.createElement("td");d.textContent=c.username;let p=document.createElement("td");p.textContent=c.role,s.appendChild(d),s.appendChild(p),o.appendChild(s)}),a.appendChild(o),e.appendChild(a)}catch{let a=document.createElement("p");a.style.color="var(--danger-color)",a.textContent="Impossible de r\xE9cup\xE9rer les membres du groupe",e.appendChild(a)}return e}async function Ie(e){let n=document.createElement("div");n.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let r=document.createElement("h3");if(r.textContent="Administration",n.appendChild(r),q==null||P?.needsGroup){let a=document.createElement("p");return a.textContent="Aucun groupe actif",n.appendChild(a),n}try{let a=await N("/context");if(!a){let u=document.createElement("p");return u.textContent="Aucun groupe actif",n.appendChild(u),n}let[t,o]=await Promise.all([N(`/groups/${q}/members`),N("/users")]),c=document.createElement("h4");c.textContent="Tableau de bord du groupe",c.style.marginTop="10px",n.appendChild(c);let s=document.createElement("div"),d=a.invitation_code,p=document.createElement("span");p.textContent=`Code d'invitation : ${d}`,s.appendChild(p);let l=document.createElement("button");l.textContent="Copier",l.style.marginLeft="8px",l.onclick=()=>navigator.clipboard.writeText(d),s.appendChild(l);let i=document.createElement("button");i.textContent="Renouveler",i.style.marginLeft="8px",i.onclick=async()=>{try{d=(await N("/groups/renew-code","POST")).invitationCode,p.textContent=`Code d'invitation : ${d}`}catch(u){alert(u.message)}},s.appendChild(i),n.appendChild(s);let f=document.createElement("table");f.className="user-table";let E=document.createElement("thead");E.innerHTML="<tr><th>Membre</th><th>R\xF4le</th><th>Actions</th></tr>",f.appendChild(E);let b=document.createElement("tbody");t.forEach(u=>{let g=document.createElement("tr"),x=document.createElement("td");x.textContent=u.username;let D=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach(V=>{let O=document.createElement("option");O.value=V,O.textContent=V,u.role===V&&(O.selected=!0),A.appendChild(O)}),u.userId===P.id&&(A.disabled=!0),A.onchange=async()=>{try{await N(`/groups/${q}/members`,"PUT",{id:u.id,role:A.value})}catch(V){alert(V.message)}},D.appendChild(A);let M=document.createElement("td"),$=document.createElement("button");$.textContent=u.userId===P.id?"Quitter":"Retirer",$.onclick=async()=>{let V=u.userId===P.id?"Quitter le groupe ?":"Supprimer ce membre ?";if(confirm(V))try{await N(`/groups/${q}/members`,"DELETE",{userId:u.userId}),u.userId===P.id?(alert("Quitter le groupe"),P.needsGroup=!0,Q()):(g.remove(),alert("Membre supprim\xE9"))}catch(O){alert(O.message)}},M.appendChild($),g.appendChild(x),g.appendChild(D),g.appendChild(M),b.appendChild(g)}),f.appendChild(b),n.appendChild(f);let v=new Set(t.map(u=>u.userId)),m=o.filter(u=>!v.has(u.id));if(m.length>0){let u=document.createElement("div"),g=document.createElement("select");m.forEach(D=>{let A=document.createElement("option");A.value=D.id,A.textContent=D.username,g.appendChild(A)}),u.appendChild(g);let x=document.createElement("button");x.textContent="Ajouter",x.style.marginLeft="8px",x.onclick=async()=>{try{let D=Number(g.value);await N(`/groups/${q}/members`,"POST",{userId:D,role:"user"}),J(e)}catch(D){alert(D.message)}},u.appendChild(x),n.appendChild(u)}let h=document.createElement("div"),y=document.createElement("input");y.type="email",y.placeholder="adresse e-mail",h.appendChild(y);let w=document.createElement("button");w.textContent="Inviter",w.style.marginLeft="8px",w.onclick=async()=>{let u=y.value.trim();if(u)try{let g=await N(`/groups/${q}/invite`,"POST",{email:u});g.temporaryPassword&&alert(`Mot de passe temporaire : ${g.temporaryPassword}`),J(e)}catch(g){alert(g.message)}},h.appendChild(w),n.appendChild(h);let k=document.createElement("h4");k.textContent="Gestion des utilisateurs",k.style.marginTop="30px",n.appendChild(k);let B=document.createElement("table");B.className="user-table";let S=document.createElement("thead");S.innerHTML="<tr><th>Utilisateur</th><th>R\xF4le</th></tr>",B.appendChild(S);let C=document.createElement("tbody"),L={};o.forEach(u=>{L[u.id]=u.role;let g=document.createElement("tr"),x=document.createElement("td");x.textContent=u.username;let D=document.createElement("td"),A=document.createElement("select");["user","moderator","admin"].forEach(M=>{let $=document.createElement("option");$.value=M,$.textContent=M,u.role===M&&($.selected=!0),A.appendChild($)}),u.id===P.id&&(A.disabled=!0),A.dataset.userId=u.id,D.appendChild(A),g.appendChild(x),g.appendChild(D),C.appendChild(g)}),B.appendChild(C),n.appendChild(B);let T=document.createElement("button");T.className="btn-primary",T.style.marginTop="10px",T.textContent="Enregistrer les r\xF4les",T.onclick=async()=>{try{let u=[];C.querySelectorAll("select").forEach(g=>{let x=Number(g.dataset.userId),D=g.value;L[x]!==D&&u.push({id:x,role:D})});for(let g of u)await N(`/users/${g.id}`,"PUT",{role:g.role});alert("R\xF4les mis \xE0 jour"),J(e)}catch(u){alert(u.message)}},n.appendChild(T)}catch{let t=document.createElement("p");t.style.color="var(--danger-color)",t.textContent="Impossible de r\xE9cup\xE9rer les membres",n.appendChild(t)}return n}async function J(e){e.innerHTML="";let n=document.createElement("h2");if(n.className="section-title",n.textContent="Param\xE8tres",e.appendChild(n),P){let l=document.createElement("p");l.className="user-info",l.textContent=`Utilisateur connect\xE9: ${P.username}`,e.appendChild(l)}let r=document.createElement("div");r.className="settings-section bg-white rounded-lg shadow-md p-4 bg-purple-50";let a=document.createElement("button");a.className="logout-btn",a.textContent="Se d\xE9connecter",a.onclick=de,r.appendChild(a);let t=document.createElement("button");t.id="delete-account-btn",t.className="delete-account-btn",t.textContent="Supprimer mon compte",t.onclick=fe,r.appendChild(t);let o;try{o=await N("/settings")}catch{let i=document.createElement("p");i.style.color="var(--danger-color)",i.textContent="Impossible de r\xE9cup\xE9rer les param\xE8tres",e.appendChild(i),e.appendChild(r);return}let c={...o},s=Pe(c);e.appendChild(s);try{await W();let l=await Me();e.appendChild(l)}catch(l){console.error("Failed to load groups or members",l)}let d=$e(c);e.appendChild(d);let p=Ae();if(e.appendChild(p),e.appendChild(r),ie()){let l=await Ie(e);e.appendChild(l)}}window.addEventListener("DOMContentLoaded",xe)});je();})();
